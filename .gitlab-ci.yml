# GitLab CI/CD Configuration for Docker Build Testing

stages:
  - build
  - test

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

# Docker build job
docker-build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    # Build the Docker image with GitHub token for private modules
    - |
      docker build \
        --build-arg GITHUB_TOKEN=$GITHUB_TOKEN \
        -t chatbox-websocket:ci-test \
        .
    # Verify image was created
    - docker images | grep chatbox-websocket
    # Test that the image runs
    - docker run --rm chatbox-websocket:ci-test --version || docker run --rm chatbox-websocket:ci-test --help || echo "Image created successfully"
  only:
    - main
    - master
    - develop
    - merge_requests
  tags:
    - docker

# Optional: Build and push to registry
docker-build-push:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        --build-arg GITHUB_TOKEN=$GITHUB_TOKEN \
        -t $IMAGE_TAG \
        -t $CI_REGISTRY_IMAGE:latest \
        .
    - docker push $IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - master
  tags:
    - docker
  when: manual
