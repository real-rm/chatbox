# GitLab CI/CD Configuration for Docker Build Testing

stages:
  - lint
  - build
  - test

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  GOPRIVATE: "github.com/real-rm/*"

# Shared MongoDB setup
.mongo-setup: &mongo-setup
  - apt-get update && apt-get install -y netcat-openbsd
  - until nc -z mongo 27017; do echo "Waiting for MongoDB..."; sleep 1; done
  - |
    apt-get install -y wget gnupg
    wget -qO /usr/share/keyrings/mongodb-server-7.0.gpg https://www.mongodb.org/static/pgp/server-7.0.asc
    echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] http://repo.mongodb.org/apt/debian bullseye/mongodb-org/7.0 main" | tee /etc/apt/sources.list.d/mongodb-org-7.0.list
    apt-get update
    apt-get install -y mongodb-mongosh
    mongosh "mongodb://admin:admin@mongo:27017/admin" --eval 'try { db.createUser({user: "chatbox", pwd: "ChatBox123", roles: [{role: "readWrite", db: "chatbox"}, {role: "dbAdmin", db: "chatbox"}]}) } catch(e) { print("User already exists: " + e) }'

# Shared Go private module setup
.go-private-setup: &go-private-setup
  - git config --global url."https://${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

# Docker build job
docker-build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    - |
      DOCKER_BUILDKIT=1 docker build \
        --secret id=github_token,env=GITHUB_TOKEN \
        -t chatbox-websocket:ci-test \
        .
    - docker images | grep chatbox-websocket
    - docker run --rm chatbox-websocket:ci-test --version || docker run --rm chatbox-websocket:ci-test --help || echo "Image created successfully"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH =~ /^(main|master|develop)$/'
  tags:
    - docker

# Optional: Build and push to registry
docker-build-push:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      DOCKER_BUILDKIT=1 docker build \
        --secret id=github_token,env=GITHUB_TOKEN \
        -t $IMAGE_TAG \
        -t $CI_REGISTRY_IMAGE:latest \
        .
    - docker push $IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE:latest
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^(main|master)$/'
      when: manual
  tags:
    - docker

# Static analysis job
lint:
  stage: lint
  image: golang:1.24.4
  cache:
    key: go-mod-${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
  variables:
    GOPATH: ${CI_PROJECT_DIR}/.go
  before_script: *go-private-setup
  script:
    - go vet ./...
    - gofmt -l . | tee /dev/stderr | (! read)
    - go install golang.org/x/vuln/cmd/govulncheck@v1.1.3
    - govulncheck ./...
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH =~ /^(main|master|develop)$/'
  tags:
    - docker

# Test job with race detector
# Combined test + coverage job (avoids running all tests twice)
test:
  stage: test
  image: golang:1.24.4
  services:
    - mongo:7.0
  cache:
    key: go-mod-${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
  variables:
    GOPATH: ${CI_PROJECT_DIR}/.go
    MONGO_INITDB_ROOT_USERNAME: admin
    MONGO_INITDB_ROOT_PASSWORD: admin
    MONGO_URI: "mongodb://chatbox:ChatBox123@mongo:27017/chatbox?authSource=admin"
  before_script:
    - *go-private-setup
    - *mongo-setup
  script:
    - go test -race -cover -timeout 5m -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out | grep total | awk '{print "Total coverage: " $3}'
    - |
      COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
      echo "Coverage: ${COVERAGE}%"
      if [ "$(echo "$COVERAGE < 40" | bc -l)" -eq 1 ]; then echo "FAIL: Coverage below 40% minimum"; exit 1; fi
    - go tool cover -html=coverage.out -o coverage.html
    - go install github.com/boumenot/gocover-cobertura@latest
    - gocover-cobertura < coverage.out > coverage.xml
  artifacts:
    paths:
      - coverage.out
      - coverage.html
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 30 days
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH =~ /^(main|master|develop)$/'
  tags:
    - docker
