# GitLab CI/CD Configuration for Docker Build Testing

stages:
  - lint
  - build
  - test
  - coverage

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

# Shared MongoDB setup (M12: extracted from duplicated before_script blocks)
.mongo-setup: &mongo-setup
  - apt-get update && apt-get install -y netcat-openbsd
  - until nc -z mongo 27017; do echo "Waiting for MongoDB..."; sleep 1; done
  - |
    apt-get install -y wget gnupg
    wget -qO /usr/share/keyrings/mongodb-server-6.0.gpg https://www.mongodb.org/static/pgp/server-6.0.asc
    echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] http://repo.mongodb.org/apt/debian bullseye/mongodb-org/6.0 main" | tee /etc/apt/sources.list.d/mongodb-org-6.0.list
    apt-get update
    apt-get install -y mongodb-mongosh
    mongosh "mongodb://admin:admin@mongo:27017/admin" --eval 'try { db.createUser({user: "chatbox", pwd: "ChatBox123", roles: [{role: "readWrite", db: "chatbox"}, {role: "dbAdmin", db: "chatbox"}]}) } catch(e) { print("User already exists: " + e) }'

# Docker build job
docker-build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker info
  script:
    # Build the Docker image with BuildKit secrets for private modules
    - |
      DOCKER_BUILDKIT=1 docker build \
        --secret id=github_token,env=GITHUB_TOKEN \
        -t chatbox-websocket:ci-test \
        .
    # Verify image was created
    - docker images | grep chatbox-websocket
    # Test that the image runs
    - docker run --rm chatbox-websocket:ci-test --version || docker run --rm chatbox-websocket:ci-test --help || echo "Image created successfully"
  only:
    - main
    - master
    - develop
    - merge_requests
  tags:
    - docker

# Optional: Build and push to registry
docker-build-push:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      DOCKER_BUILDKIT=1 docker build \
        --secret id=github_token,env=GITHUB_TOKEN \
        -t $IMAGE_TAG \
        -t $CI_REGISTRY_IMAGE:latest \
        .
    - docker push $IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - master
  tags:
    - docker
  when: manual

# Static analysis job
lint:
  stage: lint
  image: golang:1.24
  script:
    - go vet ./...
    - gofmt -l . | tee /dev/stderr | (! read)
    # M11: Security scanning with govulncheck
    - go install golang.org/x/vuln/cmd/govulncheck@latest
    - govulncheck ./...
  only:
    - main
    - master
    - develop
    - merge_requests
  tags:
    - docker

# Test job with race detector
test:
  stage: test
  image: golang:1.24
  services:
    - mongo:7.0
  variables:
    MONGO_INITDB_ROOT_USERNAME: admin
    MONGO_INITDB_ROOT_PASSWORD: admin
    MONGO_URI: "mongodb://chatbox:ChatBox123@mongo:27017/chatbox?authSource=admin"
  before_script: *mongo-setup
  script:
    - go test -race -v -timeout 5m ./...
  only:
    - main
    - master
    - develop
    - merge_requests
  tags:
    - docker

# Coverage measurement job (M10: full module coverage)
coverage:
  stage: coverage
  image: golang:1.24
  services:
    - mongo:7.0
  variables:
    MONGO_INITDB_ROOT_USERNAME: admin
    MONGO_INITDB_ROOT_PASSWORD: admin
    MONGO_URI: "mongodb://chatbox:ChatBox123@mongo:27017/chatbox?authSource=admin"
  before_script: *mongo-setup
  script:
    # Run tests with coverage for the full module
    - go test -cover -timeout 5m -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out | grep total | awk '{print "Total coverage: " $3}'

    # Generate HTML coverage report
    - go tool cover -html=coverage.out -o coverage.html

    # Generate Cobertura XML for GitLab merge request coverage visualization
    - go install github.com/boumenot/gocover-cobertura@latest
    - gocover-cobertura < coverage.out > coverage.xml
  artifacts:
    paths:
      - coverage.out
      - coverage.html
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 30 days
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  only:
    - main
    - master
    - develop
    - merge_requests
  tags:
    - docker
