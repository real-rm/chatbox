=== RUN   TestCORSConfiguration
=== RUN   TestCORSConfiguration/cors_allowed_origins_configuration_exists
    chatbox_cors_test.go:41: CORS allowed origins configuration: ""
=== RUN   TestCORSConfiguration/cors_configuration_parsing_works
    chatbox_cors_test.go:51: No CORS origins configured - CORS middleware disabled
--- PASS: TestCORSConfiguration (0.00s)
    --- PASS: TestCORSConfiguration/cors_allowed_origins_configuration_exists (0.00s)
    --- PASS: TestCORSConfiguration/cors_configuration_parsing_works (0.00s)
=== RUN   TestCORSMiddlewareIntegration
=== RUN   TestCORSMiddlewareIntegration/CORS_middleware_is_applied_when_configured
    chatbox_cors_test.go:83: ✓ Endpoint responds successfully
=== RUN   TestCORSMiddlewareIntegration/CORS_preflight_requests
    chatbox_cors_test.go:90: CORS Preflight Request Handling:
    chatbox_cors_test.go:91: - When cors_allowed_origins is configured, gin-contrib/cors middleware is applied
    chatbox_cors_test.go:92: - Preflight OPTIONS requests are automatically handled by the middleware
    chatbox_cors_test.go:93: - Allowed methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
    chatbox_cors_test.go:94: - Allowed headers: Origin, Content-Type, Accept, Authorization
    chatbox_cors_test.go:95: - Credentials are allowed (AllowCredentials: true)
    chatbox_cors_test.go:96: - Max age: 12 hours
--- PASS: TestCORSMiddlewareIntegration (0.00s)
    --- PASS: TestCORSMiddlewareIntegration/CORS_middleware_is_applied_when_configured (0.00s)
    --- PASS: TestCORSMiddlewareIntegration/CORS_preflight_requests (0.00s)
=== RUN   TestCORSImplementation
=== RUN   TestCORSImplementation/CORS_implementation_details
    chatbox_cors_test.go:103: CORS Implementation:
    chatbox_cors_test.go:104: 1. Configuration: chatbox.cors_allowed_origins in config.toml
    chatbox_cors_test.go:105: 2. Format: Comma-separated list of origins (e.g., 'http://localhost:3000,https://example.com')
    chatbox_cors_test.go:106: 3. Middleware: gin-contrib/cors package
    chatbox_cors_test.go:107: 4. Applied to: All routes in the Gin router
    chatbox_cors_test.go:108: 5. Behavior: If cors_allowed_origins is empty, CORS middleware is not applied
    chatbox_cors_test.go:109: 
    chatbox_cors_test.go:110: Configuration Example:
    chatbox_cors_test.go:111:   [chatbox]
    chatbox_cors_test.go:112:   cors_allowed_origins = "http://localhost:3000,https://example.com"
    chatbox_cors_test.go:113: 
    chatbox_cors_test.go:114: CORS Headers Set:
    chatbox_cors_test.go:115:   - Access-Control-Allow-Origin: <matching origin>
    chatbox_cors_test.go:116:   - Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
    chatbox_cors_test.go:117:   - Access-Control-Allow-Headers: Origin, Content-Type, Accept, Authorization
    chatbox_cors_test.go:118:   - Access-Control-Allow-Credentials: true
    chatbox_cors_test.go:119:   - Access-Control-Max-Age: 43200 (12 hours)
--- PASS: TestCORSImplementation (0.00s)
    --- PASS: TestCORSImplementation/CORS_implementation_details (0.00s)
=== RUN   TestProperty_ErrorMessageCompletenessForInvalidKeys
+ error message contains both required and actual key lengths: OK, passed
   100 tests.
--- PASS: TestProperty_ErrorMessageCompletenessForInvalidKeys (0.00s)
=== RUN   TestValidateEncryptionKey
=== RUN   TestValidateEncryptionKey/valid_32-byte_key
=== RUN   TestValidateEncryptionKey/empty_key_(encryption_disabled)
=== RUN   TestValidateEncryptionKey/nil_key_(encryption_disabled)
=== RUN   TestValidateEncryptionKey/invalid_16-byte_key
=== RUN   TestValidateEncryptionKey/invalid_31-byte_key
=== RUN   TestValidateEncryptionKey/invalid_33-byte_key
=== RUN   TestValidateEncryptionKey/invalid_64-byte_key
=== RUN   TestValidateEncryptionKey/error_message_format
=== RUN   TestValidateEncryptionKey/error_message_contains_both_required_and_actual_lengths
--- PASS: TestValidateEncryptionKey (0.00s)
    --- PASS: TestValidateEncryptionKey/valid_32-byte_key (0.00s)
    --- PASS: TestValidateEncryptionKey/empty_key_(encryption_disabled) (0.00s)
    --- PASS: TestValidateEncryptionKey/nil_key_(encryption_disabled) (0.00s)
    --- PASS: TestValidateEncryptionKey/invalid_16-byte_key (0.00s)
    --- PASS: TestValidateEncryptionKey/invalid_31-byte_key (0.00s)
    --- PASS: TestValidateEncryptionKey/invalid_33-byte_key (0.00s)
    --- PASS: TestValidateEncryptionKey/invalid_64-byte_key (0.00s)
    --- PASS: TestValidateEncryptionKey/error_message_format (0.00s)
    --- PASS: TestValidateEncryptionKey/error_message_contains_both_required_and_actual_lengths (0.00s)
=== RUN   TestMongoDBHealthCheck_Integration
=== RUN   TestMongoDBHealthCheck_Integration/healthy_MongoDB_returns_200
    chatbox_health_test.go:58: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-21]) incomplete read of message header: read tcp [::1]:57317->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-21]) incomplete read of message header: read tcp [::1]:57317->[::1]:27017: read: connection reset by peer }, ] }
--- PASS: TestMongoDBHealthCheck_Integration (10.00s)
    --- SKIP: TestMongoDBHealthCheck_Integration/healthy_MongoDB_returns_200 (10.00s)
=== RUN   TestMongoDBHealthCheck_Down
=== RUN   TestMongoDBHealthCheck_Down/nil_MongoDB_returns_503
    chatbox_health_test.go:118: Response: {"checks":{"mongodb":{"reason":"MongoDB not initialized","status":"not ready"}},"status":"not ready","timestamp":"2026-02-17T14:54:19Z"}
=== RUN   TestMongoDBHealthCheck_Down/unreachable_MongoDB_returns_503
    chatbox_health_test.go:160: MongoDB initialization failed as expected: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-42]) incomplete read of message header: read tcp [::1]:57342->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-42]) incomplete read of message header: read tcp [::1]:57342->[::1]:27017: read: connection reset by peer }, ] }
--- PASS: TestMongoDBHealthCheck_Down (10.00s)
    --- PASS: TestMongoDBHealthCheck_Down/nil_MongoDB_returns_503 (0.00s)
    --- PASS: TestMongoDBHealthCheck_Down/unreachable_MongoDB_returns_503 (10.00s)
=== RUN   TestMongoDBHealthCheck_Timeout
=== RUN   TestMongoDBHealthCheck_Timeout/health_check_completes_within_timeout
    chatbox_health_test.go:220: Health check completed in 45.292µs
--- PASS: TestMongoDBHealthCheck_Timeout (0.00s)
    --- PASS: TestMongoDBHealthCheck_Timeout/health_check_completes_within_timeout (0.00s)
=== RUN   TestPathPrefixRouteRegistration
=== RUN   TestPathPrefixRouteRegistration/default_prefix_/chatbox
    chatbox_path_prefix_test.go:86: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-63]) incomplete read of message header: read tcp [::1]:57368->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-63]) incomplete read of message header: read tcp [::1]:57368->[::1]:27017: read: connection reset by peer }, ] }
=== RUN   TestPathPrefixRouteRegistration/custom_prefix_/api/v1
    chatbox_path_prefix_test.go:86: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-84]) incomplete read of message header: read tcp [::1]:57390->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-84]) incomplete read of message header: read tcp [::1]:57390->[::1]:27017: read: connection reset by peer }, ] }
=== RUN   TestPathPrefixRouteRegistration/single_slash_prefix
    chatbox_path_prefix_test.go:86: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-105]) incomplete read of message header: read tcp [::1]:57416->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-105]) incomplete read of message header: read tcp [::1]:57416->[::1]:27017: read: connection reset by peer }, ] }
=== RUN   TestPathPrefixRouteRegistration/nested_prefix
    chatbox_path_prefix_test.go:86: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-126]) incomplete read of message header: read tcp [::1]:57446->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-126]) incomplete read of message header: read tcp [::1]:57446->[::1]:27017: read: connection reset by peer }, ] }
--- PASS: TestPathPrefixRouteRegistration (40.01s)
    --- SKIP: TestPathPrefixRouteRegistration/default_prefix_/chatbox (10.00s)
    --- SKIP: TestPathPrefixRouteRegistration/custom_prefix_/api/v1 (10.00s)
    --- SKIP: TestPathPrefixRouteRegistration/single_slash_prefix (10.00s)
    --- SKIP: TestPathPrefixRouteRegistration/nested_prefix (10.00s)
=== RUN   TestPathPrefixValidation
=== RUN   TestPathPrefixValidation/empty_prefix
    chatbox_path_prefix_test.go:179: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-147]) incomplete read of message header: read tcp [::1]:57470->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-147]) incomplete read of message header: read tcp [::1]:57470->[::1]:27017: read: connection reset by peer }, ] }
=== RUN   TestPathPrefixValidation/missing_leading_slash
    chatbox_path_prefix_test.go:179: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-168]) incomplete read of message header: read tcp [::1]:57493->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-168]) incomplete read of message header: read tcp [::1]:57493->[::1]:27017: read: connection reset by peer }, ] }
=== RUN   TestPathPrefixValidation/valid_prefix
    chatbox_path_prefix_test.go:179: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-189]) incomplete read of message header: read tcp [::1]:57529->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-189]) incomplete read of message header: read tcp [::1]:57529->[::1]:27017: read: connection reset by peer }, ] }
--- PASS: TestPathPrefixValidation (30.01s)
    --- SKIP: TestPathPrefixValidation/empty_prefix (10.00s)
    --- SKIP: TestPathPrefixValidation/missing_leading_slash (10.00s)
    --- SKIP: TestPathPrefixValidation/valid_prefix (10.00s)
=== RUN   TestProductionIssue17_WeakSecretAcceptance
=== RUN   TestProductionIssue17_WeakSecretAcceptance/test123
    chatbox_production_test.go:51: ✓ Weak secret 'test123' correctly rejected: JWT secret must be at least 32 characters (got 7). Generate a strong secret with: openssl rand -base64 32
=== RUN   TestProductionIssue17_WeakSecretAcceptance/password
    chatbox_production_test.go:51: ✓ Weak secret 'password' correctly rejected: JWT secret must be at least 32 characters (got 8). Generate a strong secret with: openssl rand -base64 32
=== RUN   TestProductionIssue17_WeakSecretAcceptance/secret
    chatbox_production_test.go:51: ✓ Weak secret 'secret' correctly rejected: JWT secret must be at least 32 characters (got 6). Generate a strong secret with: openssl rand -base64 32
=== RUN   TestProductionIssue17_WeakSecretAcceptance/12345678
    chatbox_production_test.go:51: ✓ Weak secret '12345678' correctly rejected: JWT secret must be at least 32 characters (got 8). Generate a strong secret with: openssl rand -base64 32
=== RUN   TestProductionIssue17_WeakSecretAcceptance/abc
    chatbox_production_test.go:51: ✓ Weak secret 'abc' correctly rejected: JWT secret must be at least 32 characters (got 3). Generate a strong secret with: openssl rand -base64 32
=== RUN   TestProductionIssue17_WeakSecretAcceptance/this-is-a-test-secret-value
    chatbox_production_test.go:51: ✓ Weak secret 'this-is-a-test-secret-value' correctly rejected: JWT secret must be at least 32 characters (got 27). Generate a strong secret with: openssl rand -base64 32
=== RUN   TestProductionIssue17_WeakSecretAcceptance/admin-password-for-production
    chatbox_production_test.go:51: ✓ Weak secret 'admin-password-for-production' correctly rejected: JWT secret must be at least 32 characters (got 29). Generate a strong secret with: openssl rand -base64 32
=== RUN   TestProductionIssue17_WeakSecretAcceptance/strong_secret
    chatbox_production_test.go:61: ✓ Strong secret accepted (length: 32)
=== NAME  TestProductionIssue17_WeakSecretAcceptance
    chatbox_production_test.go:65: FINDING: JWT secret strength validation IS implemented
    chatbox_production_test.go:66: VALIDATION: Minimum 32 characters required
    chatbox_production_test.go:67: VALIDATION: Common weak secrets are rejected (test, password, admin, etc.)
    chatbox_production_test.go:68: VALIDATION: Empty secrets are rejected
    chatbox_production_test.go:69: STATUS: Security improvement - weak secrets are now properly rejected
    chatbox_production_test.go:70: RECOMMENDATION: Ensure production deployments use strong secrets
    chatbox_production_test.go:71: RECOMMENDATION: Use 'openssl rand -base64 32' to generate secrets
--- PASS: TestProductionIssue17_WeakSecretAcceptance (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/test123 (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/password (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/secret (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/12345678 (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/abc (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/this-is-a-test-secret-value (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/admin-password-for-production (0.00s)
    --- PASS: TestProductionIssue17_WeakSecretAcceptance/strong_secret (0.00s)
=== RUN   TestProductionIssue15_ShutdownTimeout
    chatbox_production_test.go:151: Created handler with 5 mock connections
    chatbox_production_test.go:101: Shutdown completed successfully
    chatbox_production_test.go:105: Shutdown completion time: 63.584µs
    chatbox_production_test.go:106: Context timeout: 2s
    chatbox_production_test.go:113: FINDING: ShutdownWithContext() respects context deadline
    chatbox_production_test.go:114: FINDING: Connections are closed in parallel using goroutines
    chatbox_production_test.go:115: FINDING: Shutdown waits for all connections to close or context deadline
    chatbox_production_test.go:116: STATUS: Current implementation properly handles shutdown timeout
    chatbox_production_test.go:117: RECOMMENDATION: Monitor shutdown duration in production
    chatbox_production_test.go:118: RECOMMENDATION: Configure appropriate shutdown timeout in deployment
--- PASS: TestProductionIssue15_ShutdownTimeout (0.00s)
=== RUN   TestProductionIssue18_AdminRateLimiting
    chatbox_production_test.go:230: Sending 1000 rapid requests to /chat/admin/sessions...
    chatbox_production_test.go:271: Progress: 100 requests sent (success: 10, rate limited: 90, errors: 0)
    chatbox_production_test.go:271: Progress: 200 requests sent (success: 10, rate limited: 190, errors: 0)
    chatbox_production_test.go:271: Progress: 300 requests sent (success: 10, rate limited: 290, errors: 0)
    chatbox_production_test.go:271: Progress: 400 requests sent (success: 10, rate limited: 390, errors: 0)
    chatbox_production_test.go:271: Progress: 500 requests sent (success: 10, rate limited: 490, errors: 0)
    chatbox_production_test.go:271: Progress: 600 requests sent (success: 10, rate limited: 590, errors: 0)
    chatbox_production_test.go:271: Progress: 700 requests sent (success: 10, rate limited: 690, errors: 0)
    chatbox_production_test.go:271: Progress: 800 requests sent (success: 10, rate limited: 790, errors: 0)
    chatbox_production_test.go:271: Progress: 900 requests sent (success: 10, rate limited: 890, errors: 0)
    chatbox_production_test.go:271: Progress: 1000 requests sent (success: 10, rate limited: 990, errors: 0)
    chatbox_production_test.go:277: 
        === Rate Limiting Test Results ===
    chatbox_production_test.go:278: Total requests sent: 1000
    chatbox_production_test.go:279: Successful requests (200): 10
    chatbox_production_test.go:280: Rate limited requests (429): 990
    chatbox_production_test.go:281: Other errors: 0
    chatbox_production_test.go:287: 
        FINDING: Admin endpoints HAVE rate limiting configured
    chatbox_production_test.go:288: IMPLEMENTATION: adminRateLimitMiddleware in chatbox.go
    chatbox_production_test.go:289: CONFIGURATION: Default 20 requests per minute (configurable)
    chatbox_production_test.go:290: BEHAVIOR: Returns 429 Too Many Requests with Retry-After header
    chatbox_production_test.go:291: RATE LIMIT SOURCE: User-based (from JWT claims)
    chatbox_production_test.go:292: STATUS: Rate limiting is properly implemented and working
    chatbox_production_test.go:293: RECOMMENDATION: Monitor rate limit metrics in production
    chatbox_production_test.go:294: RECOMMENDATION: Adjust limits based on actual usage patterns
    chatbox_production_test.go:295: RECOMMENDATION: Consider different limits for different admin endpoints
--- PASS: TestProductionIssue18_AdminRateLimiting (0.14s)
=== RUN   TestProductionIssue06_EncryptionKeyValidation
=== RUN   TestProductionIssue06_EncryptionKeyValidation/empty_key_(encryption_disabled)
=== RUN   TestProductionIssue06_EncryptionKeyValidation/32-byte_key_(valid)
=== RUN   TestProductionIssue06_EncryptionKeyValidation/16-byte_key_(invalid)
=== RUN   TestProductionIssue06_EncryptionKeyValidation/24-byte_key_(invalid)
=== RUN   TestProductionIssue06_EncryptionKeyValidation/64-byte_key_(invalid)
=== NAME  TestProductionIssue06_EncryptionKeyValidation
    chatbox_production_test.go:372: STATUS: Encryption key validation works correctly
    chatbox_production_test.go:373: FINDING: Only 32-byte keys or empty keys are accepted
--- PASS: TestProductionIssue06_EncryptionKeyValidation (0.00s)
    --- PASS: TestProductionIssue06_EncryptionKeyValidation/empty_key_(encryption_disabled) (0.00s)
    --- PASS: TestProductionIssue06_EncryptionKeyValidation/32-byte_key_(valid) (0.00s)
    --- PASS: TestProductionIssue06_EncryptionKeyValidation/16-byte_key_(invalid) (0.00s)
    --- PASS: TestProductionIssue06_EncryptionKeyValidation/24-byte_key_(invalid) (0.00s)
    --- PASS: TestProductionIssue06_EncryptionKeyValidation/64-byte_key_(invalid) (0.00s)
=== RUN   TestRegister
=== RUN   TestRegister/function_signature
--- PASS: TestRegister (0.00s)
    --- PASS: TestRegister/function_signature (0.00s)
=== RUN   TestAuthMiddleware
=== RUN   TestAuthMiddleware/function_exists
--- PASS: TestAuthMiddleware (0.00s)
    --- PASS: TestAuthMiddleware/function_exists (0.00s)
=== RUN   TestHealthCheckHandlers
=== RUN   TestHealthCheckHandlers/health_check_handler_exists
=== RUN   TestHealthCheckHandlers/ready_check_handler_exists
--- PASS: TestHealthCheckHandlers (0.00s)
    --- PASS: TestHealthCheckHandlers/health_check_handler_exists (0.00s)
    --- PASS: TestHealthCheckHandlers/ready_check_handler_exists (0.00s)
=== RUN   TestAllowedOriginsConfiguration
=== RUN   TestAllowedOriginsConfiguration/allowed_origins_configuration_exists
    chatbox_test.go:117: Allowed origins configuration: ""
=== RUN   TestAllowedOriginsConfiguration/configuration_parsing_works
    chatbox_test.go:127: No origins configured - development mode (allows all origins)
--- PASS: TestAllowedOriginsConfiguration (0.00s)
    --- PASS: TestAllowedOriginsConfiguration/allowed_origins_configuration_exists (0.00s)
    --- PASS: TestAllowedOriginsConfiguration/configuration_parsing_works (0.00s)
=== RUN   TestAdminSessionsEndpoint
=== RUN   TestAdminSessionsEndpoint/handler_exists
=== RUN   TestAdminSessionsEndpoint/accepts_pagination_parameters
    chatbox_test.go:159: Admin sessions endpoint supports pagination with limit and offset
    chatbox_test.go:160: Admin sessions endpoint supports filtering by user_id, status, admin_assisted, and time range
    chatbox_test.go:161: Admin sessions endpoint supports sorting by multiple fields with asc/desc order
--- PASS: TestAdminSessionsEndpoint (0.00s)
    --- PASS: TestAdminSessionsEndpoint/handler_exists (0.00s)
    --- PASS: TestAdminSessionsEndpoint/accepts_pagination_parameters (0.00s)
=== RUN   TestAdminSessionsEndpoint_LargeDataset
=== RUN   TestAdminSessionsEndpoint_LargeDataset/performance_requirements
    chatbox_test.go:171: Performance Requirements:
    chatbox_test.go:172: - Should handle 10,000+ sessions efficiently
    chatbox_test.go:173: - Query response time should be < 1 second for paginated results
    chatbox_test.go:174: - Pagination should work correctly with large offsets
    chatbox_test.go:175: - Filtering should reduce result set efficiently
    chatbox_test.go:176: - Sorting should use O(n log n) algorithm (implemented in storage layer)
    chatbox_test.go:177: - Combined filters should work correctly with large datasets
    chatbox_test.go:179: 
        To run full integration tests with large datasets:
    chatbox_test.go:180: 1. Start MongoDB: docker-compose up -d mongodb
    chatbox_test.go:181: 2. Run storage tests: go test -v ./internal/storage -run TestListAllSessionsWithOptions_LargeDataset
    chatbox_test.go:182: 3. The test creates 1000 sessions and validates pagination, filtering, and sorting
--- PASS: TestAdminSessionsEndpoint_LargeDataset (0.00s)
    --- PASS: TestAdminSessionsEndpoint_LargeDataset/performance_requirements (0.00s)
=== RUN   TestReadyCheckWithMongoDB
=== RUN   TestReadyCheckWithMongoDB/returns_503_when_MongoDB_is_nil
=== RUN   TestReadyCheckWithMongoDB/returns_503_when_MongoDB_connection_fails
    chatbox_test.go:257: MongoDB initialization failed as expected: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-210]) incomplete read of message header: read tcp [::1]:58558->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-210]) incomplete read of message header: read tcp [::1]:58558->[::1]:27017: read: connection reset by peer }, ] }
=== RUN   TestReadyCheckWithMongoDB/returns_200_when_MongoDB_is_healthy
    chatbox_test.go:315: Skipping test: MongoDB not available: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-231]) incomplete read of message header: read tcp [::1]:58582->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-231]) incomplete read of message header: read tcp [::1]:58582->[::1]:27017: read: connection reset by peer }, ] }
--- PASS: TestReadyCheckWithMongoDB (20.00s)
    --- PASS: TestReadyCheckWithMongoDB/returns_503_when_MongoDB_is_nil (0.00s)
    --- PASS: TestReadyCheckWithMongoDB/returns_503_when_MongoDB_connection_fails (10.00s)
    --- SKIP: TestReadyCheckWithMongoDB/returns_200_when_MongoDB_is_healthy (10.00s)
=== RUN   TestEncryptionKeyConfiguration
=== RUN   TestEncryptionKeyConfiguration/encryption_key_configuration_exists
    chatbox_test.go:356: Encryption key configured (length: 35 bytes)
=== RUN   TestEncryptionKeyConfiguration/encryption_key_is_32_bytes_for_AES-256
    chatbox_test.go:369: Warning: Encryption key is 35 bytes, not 32 bytes. Application will pad/truncate.
=== RUN   TestEncryptionKeyConfiguration/encryption_key_is_passed_to_storage_service
    chatbox_test.go:386: Encryption key loading flow:
    chatbox_test.go:387: 1. Load from config: chatbox.encryption_key
    chatbox_test.go:388: 2. Convert to bytes and ensure 32 bytes (AES-256)
    chatbox_test.go:389: 3. Pass to storage.NewStorageService()
    chatbox_test.go:390: 4. Storage service uses key to encrypt/decrypt message content
    chatbox_test.go:397: ✓ Encryption key is properly configured and will be passed to storage service
--- PASS: TestEncryptionKeyConfiguration (0.00s)
    --- PASS: TestEncryptionKeyConfiguration/encryption_key_configuration_exists (0.00s)
    --- PASS: TestEncryptionKeyConfiguration/encryption_key_is_32_bytes_for_AES-256 (0.00s)
    --- PASS: TestEncryptionKeyConfiguration/encryption_key_is_passed_to_storage_service (0.00s)
=== RUN   TestMaxMessageSizeConfiguration
=== RUN   TestMaxMessageSizeConfiguration/max_message_size_configuration_exists
    chatbox_test.go:425: Max message size configuration: 1048576 bytes
=== RUN   TestMaxMessageSizeConfiguration/max_message_size_is_valid_integer
    chatbox_test.go:437: Parsed max message size: 1048576 bytes
=== RUN   TestMaxMessageSizeConfiguration/default_max_message_size_is_1MB
=== RUN   TestMaxMessageSizeConfiguration/environment_variable_overrides_config
--- PASS: TestMaxMessageSizeConfiguration (0.00s)
    --- PASS: TestMaxMessageSizeConfiguration/max_message_size_configuration_exists (0.00s)
    --- PASS: TestMaxMessageSizeConfiguration/max_message_size_is_valid_integer (0.00s)
    --- PASS: TestMaxMessageSizeConfiguration/default_max_message_size_is_1MB (0.00s)
    --- PASS: TestMaxMessageSizeConfiguration/environment_variable_overrides_config (0.00s)
=== RUN   TestHandleUserSessions
=== RUN   TestHandleUserSessions/handler_function_exists
=== RUN   TestHandleUserSessions/requires_authentication
    chatbox_test.go:485: handleUserSessions requires claims in context
    chatbox_test.go:486: Returns 401 if claims are missing
    chatbox_test.go:487: Returns 500 if claims type is invalid
=== RUN   TestHandleUserSessions/calls_storage_service
    chatbox_test.go:495: Calls storageService.ListUserSessions(claims.UserID, 0)
    chatbox_test.go:496: Returns JSON with sessions, user_id, and count fields
--- PASS: TestHandleUserSessions (0.00s)
    --- PASS: TestHandleUserSessions/handler_function_exists (0.00s)
    --- PASS: TestHandleUserSessions/requires_authentication (0.00s)
    --- PASS: TestHandleUserSessions/calls_storage_service (0.00s)
=== RUN   TestHandleListSessions
=== RUN   TestHandleListSessions/handler_function_exists
=== RUN   TestHandleListSessions/supports_pagination_parameters
    chatbox_test.go:510: Accepts limit parameter (default: 100, max: 1000)
    chatbox_test.go:511: Accepts offset parameter (default: 0)
    chatbox_test.go:512: Invalid limits are clamped to valid range
    chatbox_test.go:513: Negative offsets are set to 0
=== RUN   TestHandleListSessions/supports_filtering_parameters
    chatbox_test.go:518: Accepts user_id filter
    chatbox_test.go:519: Accepts status filter (active/ended)
    chatbox_test.go:520: Accepts admin_assisted filter (true/false)
    chatbox_test.go:521: Accepts start_time_from filter (RFC3339)
    chatbox_test.go:522: Accepts start_time_to filter (RFC3339)
    chatbox_test.go:523: Returns 400 for invalid time formats
=== RUN   TestHandleListSessions/supports_sorting_parameters
    chatbox_test.go:528: Accepts sort_by parameter (start_time, end_time, message_count, total_tokens, user_id)
    chatbox_test.go:529: Accepts sort_order parameter (asc/desc, default: desc)
    chatbox_test.go:530: Default sort is by start_time descending
=== RUN   TestHandleListSessions/calls_storage_service_with_options
    chatbox_test.go:535: Builds SessionListOptions from query parameters
    chatbox_test.go:536: Calls storageService.ListAllSessionsWithOptions(opts)
    chatbox_test.go:537: Returns JSON with sessions, count, limit, and offset
    chatbox_test.go:538: Returns 500 if storage service fails
--- PASS: TestHandleListSessions (0.00s)
    --- PASS: TestHandleListSessions/handler_function_exists (0.00s)
    --- PASS: TestHandleListSessions/supports_pagination_parameters (0.00s)
    --- PASS: TestHandleListSessions/supports_filtering_parameters (0.00s)
    --- PASS: TestHandleListSessions/supports_sorting_parameters (0.00s)
    --- PASS: TestHandleListSessions/calls_storage_service_with_options (0.00s)
=== RUN   TestHandleGetMetrics
=== RUN   TestHandleGetMetrics/handler_function_exists
=== RUN   TestHandleGetMetrics/supports_time_range_parameters
    chatbox_test.go:552: Accepts start_time parameter (RFC3339 format)
    chatbox_test.go:553: Accepts end_time parameter (RFC3339 format)
    chatbox_test.go:554: Defaults to last 24 hours if not specified
    chatbox_test.go:555: Returns 400 for invalid time formats
=== RUN   TestHandleGetMetrics/calls_storage_service_for_metrics
    chatbox_test.go:560: Calls storageService.GetSessionMetrics(startTime, endTime)
    chatbox_test.go:561: Calls storageService.GetTokenUsage(startTime, endTime)
    chatbox_test.go:562: Returns JSON with metrics and time_range
    chatbox_test.go:563: Returns 500 if either storage call fails
=== RUN   TestHandleGetMetrics/returns_comprehensive_metrics
    chatbox_test.go:568: Returns TotalSessions count
    chatbox_test.go:569: Returns ActiveSessions count
    chatbox_test.go:570: Returns TotalTokens (from GetTokenUsage)
    chatbox_test.go:571: Returns time_range with start and end timestamps
--- PASS: TestHandleGetMetrics (0.00s)
    --- PASS: TestHandleGetMetrics/handler_function_exists (0.00s)
    --- PASS: TestHandleGetMetrics/supports_time_range_parameters (0.00s)
    --- PASS: TestHandleGetMetrics/calls_storage_service_for_metrics (0.00s)
    --- PASS: TestHandleGetMetrics/returns_comprehensive_metrics (0.00s)
=== RUN   TestHandleAdminTakeover
=== RUN   TestHandleAdminTakeover/handler_function_exists
=== RUN   TestHandleAdminTakeover/requires_session_ID_parameter
    chatbox_test.go:585: Expects sessionID as URL parameter
    chatbox_test.go:586: Returns 400 if sessionID is empty
=== RUN   TestHandleAdminTakeover/requires_authentication
    chatbox_test.go:591: Requires claims in context (set by authMiddleware)
    chatbox_test.go:592: Returns 401 if claims are missing
    chatbox_test.go:593: Returns 500 if claims type is invalid
=== RUN   TestHandleAdminTakeover/creates_admin_connection_and_initiates_takeover
    chatbox_test.go:598: Creates WebSocket connection for admin using claims
    chatbox_test.go:599: Sets admin name from JWT claims
    chatbox_test.go:600: Calls messageRouter.HandleAdminTakeover(adminConn, sessionID)
    chatbox_test.go:601: Returns 500 if HandleAdminTakeover fails
    chatbox_test.go:602: Returns 200 with success message on success
=== RUN   TestHandleAdminTakeover/returns_takeover_details
    chatbox_test.go:607: Returns JSON with message, session_id, and admin_id
    chatbox_test.go:608: Logs detailed error server-side on failure
--- PASS: TestHandleAdminTakeover (0.00s)
    --- PASS: TestHandleAdminTakeover/handler_function_exists (0.00s)
    --- PASS: TestHandleAdminTakeover/requires_session_ID_parameter (0.00s)
    --- PASS: TestHandleAdminTakeover/requires_authentication (0.00s)
    --- PASS: TestHandleAdminTakeover/creates_admin_connection_and_initiates_takeover (0.00s)
    --- PASS: TestHandleAdminTakeover/returns_takeover_details (0.00s)
=== RUN   TestHandleHealthCheck
=== RUN   TestHandleHealthCheck/returns_200_with_healthy_status
=== RUN   TestHandleHealthCheck/includes_RFC3339_timestamp
=== RUN   TestHandleHealthCheck/always_returns_status_healthy
--- PASS: TestHandleHealthCheck (0.00s)
    --- PASS: TestHandleHealthCheck/returns_200_with_healthy_status (0.00s)
    --- PASS: TestHandleHealthCheck/includes_RFC3339_timestamp (0.00s)
    --- PASS: TestHandleHealthCheck/always_returns_status_healthy (0.00s)
=== RUN   TestHandleReadyCheck
=== RUN   TestHandleReadyCheck/returns_503_when_MongoDB_is_nil
=== RUN   TestHandleReadyCheck/includes_timestamp_in_response
=== RUN   TestHandleReadyCheck/includes_checks_in_response
--- PASS: TestHandleReadyCheck (0.00s)
    --- PASS: TestHandleReadyCheck/returns_503_when_MongoDB_is_nil (0.00s)
    --- PASS: TestHandleReadyCheck/includes_timestamp_in_response (0.00s)
    --- PASS: TestHandleReadyCheck/includes_checks_in_response (0.00s)
=== RUN   TestAuthMiddleware_ValidAdminToken
--- PASS: TestAuthMiddleware_ValidAdminToken (0.00s)
=== RUN   TestAuthMiddleware_ValidChatAdminToken
--- PASS: TestAuthMiddleware_ValidChatAdminToken (0.00s)
=== RUN   TestAuthMiddleware_MissingAuthHeader
--- PASS: TestAuthMiddleware_MissingAuthHeader (0.00s)
=== RUN   TestAuthMiddleware_InvalidTokenFormat
--- PASS: TestAuthMiddleware_InvalidTokenFormat (0.00s)
=== RUN   TestAuthMiddleware_ExpiredToken
--- PASS: TestAuthMiddleware_ExpiredToken (0.00s)
=== RUN   TestAuthMiddleware_NonAdminRole
--- PASS: TestAuthMiddleware_NonAdminRole (0.00s)
=== RUN   TestAuthMiddleware_InvalidSignature
--- PASS: TestAuthMiddleware_InvalidSignature (0.00s)
=== RUN   TestUserAuthMiddleware_ValidToken
--- PASS: TestUserAuthMiddleware_ValidToken (0.00s)
=== RUN   TestUserAuthMiddleware_NoAdminCheck
--- PASS: TestUserAuthMiddleware_NoAdminCheck (0.00s)
=== RUN   TestUserAuthMiddleware_MissingAuthHeader
--- PASS: TestUserAuthMiddleware_MissingAuthHeader (0.00s)
=== RUN   TestUserAuthMiddleware_InvalidToken
--- PASS: TestUserAuthMiddleware_InvalidToken (0.00s)
=== RUN   TestAdminRateLimitMiddleware_AllowsWithinLimit
--- PASS: TestAdminRateLimitMiddleware_AllowsWithinLimit (0.00s)
=== RUN   TestAdminRateLimitMiddleware_BlocksWhenExceeded
--- PASS: TestAdminRateLimitMiddleware_BlocksWhenExceeded (0.00s)
=== RUN   TestAdminRateLimitMiddleware_ReturnsRetryAfterHeader
--- PASS: TestAdminRateLimitMiddleware_ReturnsRetryAfterHeader (0.00s)
=== RUN   TestAdminRateLimitMiddleware_NoClaims
--- PASS: TestAdminRateLimitMiddleware_NoClaims (0.00s)
=== RUN   TestAdminRateLimitMiddleware_InvalidClaimsType
--- PASS: TestAdminRateLimitMiddleware_InvalidClaimsType (0.00s)
=== RUN   TestAdminRateLimitMiddleware_IndependentUserLimits
--- PASS: TestAdminRateLimitMiddleware_IndependentUserLimits (0.00s)
=== RUN   TestValidateJWTSecret
=== RUN   TestValidateJWTSecret/rejects_empty_secret
=== RUN   TestValidateJWTSecret/rejects_secret_shorter_than_minimum_length
=== RUN   TestValidateJWTSecret/rejects_secret_exactly_at_minimum_length_minus_one
=== RUN   TestValidateJWTSecret/accepts_secret_exactly_at_minimum_length
=== RUN   TestValidateJWTSecret/accepts_long_strong_secret
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'secret'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'password'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'test'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'admin'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'changeme'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'default'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'example'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'demo'
=== RUN   TestValidateJWTSecret/rejects_secret_containing_'12345'
=== RUN   TestValidateJWTSecret/weak_pattern_check_is_case-insensitive
=== RUN   TestValidateJWTSecret/error_message_includes_helpful_guidance
=== RUN   TestValidateJWTSecret/weak_secret_error_includes_generation_command
=== RUN   TestValidateJWTSecret/accepts_cryptographically_random-looking_secret
=== RUN   TestValidateJWTSecret/accepts_secret_with_special_characters
--- PASS: TestValidateJWTSecret (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_empty_secret (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_shorter_than_minimum_length (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_exactly_at_minimum_length_minus_one (0.00s)
    --- PASS: TestValidateJWTSecret/accepts_secret_exactly_at_minimum_length (0.00s)
    --- PASS: TestValidateJWTSecret/accepts_long_strong_secret (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'secret' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'password' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'test' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'admin' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'changeme' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'default' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'example' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'demo' (0.00s)
    --- PASS: TestValidateJWTSecret/rejects_secret_containing_'12345' (0.00s)
    --- PASS: TestValidateJWTSecret/weak_pattern_check_is_case-insensitive (0.00s)
    --- PASS: TestValidateJWTSecret/error_message_includes_helpful_guidance (0.00s)
    --- PASS: TestValidateJWTSecret/weak_secret_error_includes_generation_command (0.00s)
    --- PASS: TestValidateJWTSecret/accepts_cryptographically_random-looking_secret (0.00s)
    --- PASS: TestValidateJWTSecret/accepts_secret_with_special_characters (0.00s)
=== RUN   TestShutdown_GracefulShutdown
=== RUN   TestShutdown_GracefulShutdown/shutdown_with_no_components_initialized
=== RUN   TestShutdown_GracefulShutdown/shutdown_with_logger_only
=== RUN   TestShutdown_GracefulShutdown/shutdown_is_thread-safe
--- PASS: TestShutdown_GracefulShutdown (0.00s)
    --- PASS: TestShutdown_GracefulShutdown/shutdown_with_no_components_initialized (0.00s)
    --- PASS: TestShutdown_GracefulShutdown/shutdown_with_logger_only (0.00s)
    --- PASS: TestShutdown_GracefulShutdown/shutdown_is_thread-safe (0.00s)
=== RUN   TestShutdown_WithTimeout
=== RUN   TestShutdown_WithTimeout/shutdown_with_very_short_timeout
=== RUN   TestShutdown_WithTimeout/shutdown_respects_context_cancellation
=== RUN   TestShutdown_WithTimeout/shutdown_with_timeout_logs_appropriate_messages
--- PASS: TestShutdown_WithTimeout (0.01s)
    --- PASS: TestShutdown_WithTimeout/shutdown_with_very_short_timeout (0.01s)
    --- PASS: TestShutdown_WithTimeout/shutdown_respects_context_cancellation (0.00s)
    --- PASS: TestShutdown_WithTimeout/shutdown_with_timeout_logs_appropriate_messages (0.00s)
=== RUN   TestIntegration_CompleteMessageFlow
--- PASS: TestIntegration_CompleteMessageFlow (0.00s)
=== RUN   TestIntegration_FileUploadFlow
--- PASS: TestIntegration_FileUploadFlow (0.00s)
=== RUN   TestIntegration_VoiceMessageFlow
--- PASS: TestIntegration_VoiceMessageFlow (0.00s)
=== RUN   TestIntegration_AdminTakeoverFlow
--- PASS: TestIntegration_AdminTakeoverFlow (0.00s)
=== RUN   TestIntegration_ReconnectionFlow
--- PASS: TestIntegration_ReconnectionFlow (1.00s)
=== RUN   TestIntegration_ReconnectionTimeout
--- PASS: TestIntegration_ReconnectionTimeout (2.00s)
=== RUN   TestIntegration_MultiModelSelectionFlow
--- PASS: TestIntegration_MultiModelSelectionFlow (0.00s)
=== RUN   TestIntegration_ConcurrentConnections
--- PASS: TestIntegration_ConcurrentConnections (0.00s)
=== RUN   TestIntegration_MessageOrderPreservation
--- PASS: TestIntegration_MessageOrderPreservation (0.51s)
=== RUN   TestIntegration_ErrorHandling
--- PASS: TestIntegration_ErrorHandling (0.00s)
=== RUN   TestMetricsEndpoint
--- PASS: TestMetricsEndpoint (0.00s)
=== RUN   TestMetricsEndpointContentType
--- PASS: TestMetricsEndpointContentType (0.00s)
PASS
ok  	github.com/real-rm/chatbox	(cached)
=== RUN   TestProductionIssue05_MainServerStartup
=== RUN   TestProductionIssue05_MainServerStartup/SignalHandlingWorks
    main_production_test.go:65: ✓ Signal handling works correctly
=== RUN   TestProductionIssue05_MainServerStartup/DocumentMissingFunctionality
    main_production_test.go:87: MISSING COMPONENTS IN main.go:
    main_production_test.go:89:   1. HTTP server initialization
    main_production_test.go:89:   2. Register() call to set up routes
    main_production_test.go:89:   3. Chatbox service initialization
    main_production_test.go:89:   4. WebSocket handler setup
    main_production_test.go:89:   5. Graceful shutdown of active connections
    main_production_test.go:89:   6. Health check endpoint
    main_production_test.go:89:   7. Metrics endpoint
    main_production_test.go:92: 
        CURRENT BEHAVIOR:
    main_production_test.go:93:   - Loads configuration
    main_production_test.go:94:   - Initializes logger
    main_production_test.go:95:   - Sets up signal handling
    main_production_test.go:96:   - Waits for shutdown signal
    main_production_test.go:97:   - Does NOT start any server
    main_production_test.go:99: 
        RECOMMENDATION:
    main_production_test.go:100:   This is a TRUE ISSUE that must be fixed before production deployment.
    main_production_test.go:101:   The main.go file needs to be completely rewritten to:
    main_production_test.go:102:     1. Initialize all required services
    main_production_test.go:103:     2. Start the HTTP server
    main_production_test.go:104:     3. Handle graceful shutdown properly
--- PASS: TestProductionIssue05_MainServerStartup (0.00s)
    --- PASS: TestProductionIssue05_MainServerStartup/SignalHandlingWorks (0.00s)
    --- PASS: TestProductionIssue05_MainServerStartup/DocumentMissingFunctionality (0.00s)
=== RUN   TestLoadConfiguration
=== RUN   TestLoadConfiguration/SuccessfulLoad
=== RUN   TestLoadConfiguration/LoadWithoutConfigFile
=== RUN   TestLoadConfiguration/LoadConfigurationError
    main_test.go:60: goconfig allows invalid config path
--- PASS: TestLoadConfiguration (0.00s)
    --- PASS: TestLoadConfiguration/SuccessfulLoad (0.00s)
    --- PASS: TestLoadConfiguration/LoadWithoutConfigFile (0.00s)
    --- PASS: TestLoadConfiguration/LoadConfigurationError (0.00s)
=== RUN   TestInitializeLogger
=== RUN   TestInitializeLogger/SuccessfulInit
=== RUN   TestInitializeLogger/InitWithInvalidLogDir
    main_test.go:105: golog allows invalid log directory
=== RUN   TestInitializeLogger/InitWithFileAsLogDir
    main_test.go:132: golog allows device file as log directory
--- PASS: TestInitializeLogger (0.00s)
    --- PASS: TestInitializeLogger/SuccessfulInit (0.00s)
    --- PASS: TestInitializeLogger/InitWithInvalidLogDir (0.00s)
    --- PASS: TestInitializeLogger/InitWithFileAsLogDir (0.00s)
=== RUN   TestGetServerPort
=== RUN   TestGetServerPort/GetPortFromConfig
=== RUN   TestGetServerPort/GetPortWithError
=== RUN   TestGetServerPort/GetPortWithInvalidValue
--- PASS: TestGetServerPort (0.00s)
    --- PASS: TestGetServerPort/GetPortFromConfig (0.00s)
    --- PASS: TestGetServerPort/GetPortWithError (0.00s)
    --- PASS: TestGetServerPort/GetPortWithInvalidValue (0.00s)
=== RUN   TestSetupSignalHandler
=== RUN   TestSetupSignalHandler/CreateSignalChannel
=== RUN   TestSetupSignalHandler/ReceiveSignal
--- PASS: TestSetupSignalHandler (0.05s)
    --- PASS: TestSetupSignalHandler/CreateSignalChannel (0.00s)
    --- PASS: TestSetupSignalHandler/ReceiveSignal (0.05s)
=== RUN   TestRunWithSignalChannel
=== RUN   TestRunWithSignalChannel/SuccessfulRun
2026-02-17T22:59:41.856+07:00 level=INFO msg=Server starting, port=8080
2026-02-17T22:59:41.956+07:00 level=INFO value="Shutting down gracefully"
=== RUN   TestRunWithSignalChannel/RunWithConfigError
2026-02-17T22:59:41.957+07:00 level=INFO msg=Server starting, port=8080
2026-02-17T22:59:42.157+07:00 level=INFO value="Shutting down gracefully"
    main_test.go:298: Run completed successfully with defaults
=== RUN   TestRunWithSignalChannel/RunWithLoggerError
2026-02-17T22:59:42.158+07:00 level=INFO msg=Server starting, port=8080
2026-02-17T22:59:42.359+07:00 level=INFO value="Shutting down gracefully"
    main_test.go:341: Run completed successfully
--- PASS: TestRunWithSignalChannel (0.50s)
    --- PASS: TestRunWithSignalChannel/SuccessfulRun (0.10s)
    --- PASS: TestRunWithSignalChannel/RunWithConfigError (0.20s)
    --- PASS: TestRunWithSignalChannel/RunWithLoggerError (0.20s)
=== RUN   TestRunMain
=== RUN   TestRunMain/RunMainWithSignal
2026-02-17T22:59:42.360+07:00 level=INFO msg=Server starting, port=8080
2026-02-17T22:59:42.461+07:00 level=INFO value="Shutting down gracefully"
--- PASS: TestRunMain (0.10s)
    --- PASS: TestRunMain/RunMainWithSignal (0.10s)
=== RUN   TestConfigLoading
=== RUN   TestConfigLoading/LoadDefaultConfiguration
=== RUN   TestConfigLoading/LoadLogConfiguration
=== RUN   TestConfigLoading/LoadServerConfiguration
=== RUN   TestConfigLoading/HandleMissingConfigFile
    main_test.go:458: goconfig allows missing config file
--- PASS: TestConfigLoading (0.00s)
    --- PASS: TestConfigLoading/LoadDefaultConfiguration (0.00s)
    --- PASS: TestConfigLoading/LoadLogConfiguration (0.00s)
    --- PASS: TestConfigLoading/LoadServerConfiguration (0.00s)
    --- PASS: TestConfigLoading/HandleMissingConfigFile (0.00s)
=== RUN   TestConfigValidation
=== RUN   TestConfigValidation/ValidatePortRange
=== RUN   TestConfigValidation/ValidateLogLevel
=== RUN   TestConfigValidation/ValidateLogDirectory
=== RUN   TestConfigValidation/ValidateDefaultValues
--- PASS: TestConfigValidation (0.00s)
    --- PASS: TestConfigValidation/ValidatePortRange (0.00s)
    --- PASS: TestConfigValidation/ValidateLogLevel (0.00s)
    --- PASS: TestConfigValidation/ValidateLogDirectory (0.00s)
    --- PASS: TestConfigValidation/ValidateDefaultValues (0.00s)
=== RUN   TestEnvironmentVariableOverride
=== RUN   TestEnvironmentVariableOverride/OverrideServerPort
    main_test.go:576: Port from config: 8080 (env override may not be supported)
=== RUN   TestEnvironmentVariableOverride/OverrideLogLevel
    main_test.go:601: Log level from config: info (env override may not be supported)
=== RUN   TestEnvironmentVariableOverride/OverrideLogDirectory
    main_test.go:627: Log dir from config: logs (env override may not be supported)
=== RUN   TestEnvironmentVariableOverride/MultipleEnvironmentVariables
    main_test.go:661: Port: 8080
    main_test.go:662: Log Level: info
    main_test.go:663: Log Dir: logs
=== RUN   TestEnvironmentVariableOverride/EnvironmentVariablePrecedence
    main_test.go:687: Default values are used when config is not set
--- PASS: TestEnvironmentVariableOverride (0.00s)
    --- PASS: TestEnvironmentVariableOverride/OverrideServerPort (0.00s)
    --- PASS: TestEnvironmentVariableOverride/OverrideLogLevel (0.00s)
    --- PASS: TestEnvironmentVariableOverride/OverrideLogDirectory (0.00s)
    --- PASS: TestEnvironmentVariableOverride/MultipleEnvironmentVariables (0.00s)
    --- PASS: TestEnvironmentVariableOverride/EnvironmentVariablePrecedence (0.00s)
=== RUN   TestConfigurationIntegration
=== RUN   TestConfigurationIntegration/CompleteConfigurationFlow
    main_test.go:727: Configuration loaded successfully:
    main_test.go:728:   Log Dir: logs
    main_test.go:729:   Log Level: info
    main_test.go:730:   Standard Output: true
    main_test.go:731:   Server Port: 8080
=== RUN   TestConfigurationIntegration/ConfigurationWithEnvironmentOverrides
    main_test.go:759: Configuration with environment overrides:
    main_test.go:760:   Server Port: 8080
    main_test.go:761:   Log Level: info
--- PASS: TestConfigurationIntegration (0.00s)
    --- PASS: TestConfigurationIntegration/CompleteConfigurationFlow (0.00s)
    --- PASS: TestConfigurationIntegration/ConfigurationWithEnvironmentOverrides (0.00s)
=== RUN   TestConfigurationErrorHandling
=== RUN   TestConfigurationErrorHandling/HandleInvalidPortValue
=== RUN   TestConfigurationErrorHandling/HandleMissingRequiredConfig
=== RUN   TestConfigurationErrorHandling/HandleEmptyConfigValues
--- PASS: TestConfigurationErrorHandling (0.00s)
    --- PASS: TestConfigurationErrorHandling/HandleInvalidPortValue (0.00s)
    --- PASS: TestConfigurationErrorHandling/HandleMissingRequiredConfig (0.00s)
    --- PASS: TestConfigurationErrorHandling/HandleEmptyConfigValues (0.00s)
=== RUN   TestConfigurationDefaults
=== RUN   TestConfigurationDefaults/DefaultPort
=== RUN   TestConfigurationDefaults/DefaultLogLevel
=== RUN   TestConfigurationDefaults/DefaultLogDir
=== RUN   TestConfigurationDefaults/DefaultStandardOutput
--- PASS: TestConfigurationDefaults (0.00s)
    --- PASS: TestConfigurationDefaults/DefaultPort (0.00s)
    --- PASS: TestConfigurationDefaults/DefaultLogLevel (0.00s)
    --- PASS: TestConfigurationDefaults/DefaultLogDir (0.00s)
    --- PASS: TestConfigurationDefaults/DefaultStandardOutput (0.00s)
=== RUN   TestConfigurationTimeout
=== RUN   TestConfigurationTimeout/ConfigurationLoadingCompletes
--- PASS: TestConfigurationTimeout (0.00s)
    --- PASS: TestConfigurationTimeout/ConfigurationLoadingCompletes (0.00s)
=== RUN   TestStartup
=== RUN   TestStartup/SuccessfulStartup
    main_test.go:968: Startup configuration validated:
    main_test.go:969:   Log Dir: logs
    main_test.go:970:   Log Level: info
    main_test.go:971:   Standard Output: true
    main_test.go:972:   Server Port: 8080
=== RUN   TestStartup/StartupWithInvalidConfig
    main_test.go:1009: Port fell back to valid value: 8080
    main_test.go:1018: Log level is valid: info
=== RUN   TestStartup/StartupWithMissingDependencies
    main_test.go:1054: Startup with missing dependencies falls back to defaults
=== RUN   TestStartup/StartupWithInvalidLogDirectory
    main_test.go:1077: Log directory set to: logs (logger initialization would validate this)
=== RUN   TestStartup/StartupWithMissingPort
=== RUN   TestStartup/StartupConfigurationOrder
    main_test.go:1124: Configuration loading order validated
--- PASS: TestStartup (0.00s)
    --- PASS: TestStartup/SuccessfulStartup (0.00s)
    --- PASS: TestStartup/StartupWithInvalidConfig (0.00s)
    --- PASS: TestStartup/StartupWithMissingDependencies (0.00s)
    --- PASS: TestStartup/StartupWithInvalidLogDirectory (0.00s)
    --- PASS: TestStartup/StartupWithMissingPort (0.00s)
    --- PASS: TestStartup/StartupConfigurationOrder (0.00s)
=== RUN   TestSignalHandling
=== RUN   TestSignalHandling/SIGTERMHandling
    main_test.go:1189: SIGTERM signal received successfully
=== RUN   TestSignalHandling/SIGINTHandling
    main_test.go:1211: SIGINT signal received successfully
=== RUN   TestSignalHandling/GracefulShutdown
    main_test.go:1246: Graceful shutdown completed successfully
=== RUN   TestSignalHandling/MultipleSignals
    main_test.go:1270: First signal received: interrupt
    main_test.go:1279: Second signal received: terminated
=== RUN   TestSignalHandling/SignalChannelBuffering
    main_test.go:1298: Buffered signal received successfully
=== RUN   TestSignalHandling/ShutdownWithTimeout
    main_test.go:1341: Shutdown completed within timeout
=== RUN   TestSignalHandling/SignalNotifyRegistration
    main_test.go:1381: Both SIGINT and SIGTERM registered successfully
=== RUN   TestSignalHandling/CleanupAfterSignal
    main_test.go:1420: All cleanup steps completed successfully
--- PASS: TestSignalHandling (0.72s)
    --- PASS: TestSignalHandling/SIGTERMHandling (0.10s)
    --- PASS: TestSignalHandling/SIGINTHandling (0.10s)
    --- PASS: TestSignalHandling/GracefulShutdown (0.15s)
    --- PASS: TestSignalHandling/MultipleSignals (0.10s)
    --- PASS: TestSignalHandling/SignalChannelBuffering (0.00s)
    --- PASS: TestSignalHandling/ShutdownWithTimeout (0.10s)
    --- PASS: TestSignalHandling/SignalNotifyRegistration (0.10s)
    --- PASS: TestSignalHandling/CleanupAfterSignal (0.06s)
PASS
ok  	github.com/real-rm/chatbox/cmd/server	2.053s
=== RUN   TestProductionIssue06_PlaceholderSecrets
    secret_validation_test.go:69: SECURITY RISK: Found 17 placeholder secrets in secret.yaml:
    secret_validation_test.go:71:   - LLM_PROVIDER_2_API_KEY: sk-ant-your-anthropic-api-key
    secret_validation_test.go:71:   - SES_ACCESS_KEY_ID: AKIAXXXXXXXXXXXXXXXX
    secret_validation_test.go:71:   - ADMIN_API_KEY: your-admin-api-key-for-monitoring
    secret_validation_test.go:71:   - ENCRYPTION_KEY: CHANGE-ME-32-BYTE-KEY-FOR-AES256
    secret_validation_test.go:71:   - S3_ACCESS_KEY_ID: your-s3-access-key-id
    secret_validation_test.go:71:   - SMTP_USER: smtp-username
    secret_validation_test.go:71:   - SMS_ACCOUNT_SID: ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
    secret_validation_test.go:71:   - SMS_API_KEY: your-sms-api-key
    secret_validation_test.go:71:   - LLM_PROVIDER_3_API_KEY: your-dify-api-key
    secret_validation_test.go:71:   - S3_SECRET_ACCESS_KEY: your-s3-secret-access-key
    secret_validation_test.go:71:   - SMTP_PASS: smtp-password
    secret_validation_test.go:71:   - SES_SECRET_ACCESS_KEY: your-ses-secret-access-key
    secret_validation_test.go:71:   - JWT_SECRET: your-jwt-secret-key-change-in-production-use-strong-random-string
    secret_validation_test.go:71:   - SMS_AUTH_TOKEN: your-twilio-auth-token
    secret_validation_test.go:71:   - LLM_PROVIDER_1_API_KEY: sk-your-openai-api-key
    secret_validation_test.go:71:   - MONGO_USERNAME: chatbox-user
    secret_validation_test.go:71:   - MONGO_PASSWORD: your-mongo-password
    secret_validation_test.go:73: 
        Recommendations:
    secret_validation_test.go:74: 1. Generate strong random secrets for production deployment
    secret_validation_test.go:75: 2. Use secret management tools (e.g., Sealed Secrets, External Secrets Operator)
    secret_validation_test.go:76: 3. Never commit real secrets to version control
    secret_validation_test.go:77: 4. Implement secret rotation procedures
    secret_validation_test.go:78: 5. Use environment-specific secret values
    secret_validation_test.go:79: 
        For quick setup instructions, see: docs/SECRET_SETUP_QUICKSTART.md
--- FAIL: TestProductionIssue06_PlaceholderSecrets (0.00s)
FAIL
FAIL	github.com/real-rm/chatbox/deployments/kubernetes	1.197s
=== RUN   TestProperty_JWTTokenValidation
+ valid tokens with correct signature and not expired should be accepted:
   OK, passed 20 tests.
Elapsed time: 8.616167ms
+ expired tokens should be rejected with error: OK, passed 20 tests.
Elapsed time: 8.6095ms
+ tokens with invalid signature should be rejected with error: OK, passed
   20 tests.
Elapsed time: 6.043375ms
+ malformed tokens should be rejected with error: OK, passed 20 tests.
Elapsed time: 292.125µs
+ empty tokens should be rejected with error: OK, passed 20 tests.
Elapsed time: 8.209µs
+ tokens missing user_id claim should be rejected: OK, passed 20 tests.
Elapsed time: 5.945208ms
+ tokens missing roles claim should be rejected: OK, passed 20 tests.
Elapsed time: 308.291µs
--- PASS: TestProperty_JWTTokenValidation (0.03s)
=== RUN   TestProperty_JWTClaimsExtractionRoundTrip
+ extracting claims from valid token returns original user_id and roles:
   OK, passed 20 tests.
Elapsed time: 7.1995ms
+ extracting claims with empty roles array preserves empty array: OK,
   passed 20 tests.
Elapsed time: 271.291µs
+ extracting claims with multiple roles preserves all roles in order: OK,
   passed 20 tests.
Elapsed time: 737.333µs
+ extracting claims with special characters in user_id preserves exact
   value: OK, passed 20 tests.
Elapsed time: 5.419459ms
+ extracting claims preserves exact role order: OK, passed 20 tests.
Elapsed time: 5.178958ms
--- PASS: TestProperty_JWTClaimsExtractionRoundTrip (0.02s)
=== RUN   TestValidateToken_ValidToken
--- PASS: TestValidateToken_ValidToken (0.00s)
=== RUN   TestValidateToken_ExpiredToken
--- PASS: TestValidateToken_ExpiredToken (0.00s)
=== RUN   TestValidateToken_InvalidSignature
--- PASS: TestValidateToken_InvalidSignature (0.00s)
=== RUN   TestValidateToken_MalformedToken
--- PASS: TestValidateToken_MalformedToken (0.00s)
=== RUN   TestValidateToken_EmptyToken
--- PASS: TestValidateToken_EmptyToken (0.00s)
=== RUN   TestValidateToken_MissingUserID
--- PASS: TestValidateToken_MissingUserID (0.00s)
=== RUN   TestValidateToken_MissingRoles
--- PASS: TestValidateToken_MissingRoles (0.00s)
=== RUN   TestValidateToken_InvalidRolesType
--- PASS: TestValidateToken_InvalidRolesType (0.00s)
=== RUN   TestValidateToken_MultipleRoles
--- PASS: TestValidateToken_MultipleRoles (0.00s)
=== RUN   TestValidateToken_EmptyRolesArray
--- PASS: TestValidateToken_EmptyRolesArray (0.00s)
=== RUN   TestExtractClaims_RoundTrip
--- PASS: TestExtractClaims_RoundTrip (0.00s)
=== RUN   TestValidateToken_WithName
--- PASS: TestValidateToken_WithName (0.00s)
=== RUN   TestValidateToken_WithoutName
--- PASS: TestValidateToken_WithoutName (0.00s)
=== RUN   TestValidateToken_WithEmptyName
--- PASS: TestValidateToken_WithEmptyName (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/auth	1.683s
=== RUN   TestProductionIssue19_ValidationCalled
    config_production_test.go:38: FINDING: Load() does NOT call Validate() automatically
    config_production_test.go:39: IMPACT: Invalid configuration can be loaded without errors
    config_production_test.go:45: STATUS: Validate() must be called explicitly
    config_production_test.go:46: RECOMMENDATION: Call Validate() after Load() in main.go
--- PASS: TestProductionIssue19_ValidationCalled (0.00s)
=== RUN   TestProductionIssue19_ValidationCoverage
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_port_-_too_low
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_port_-_negative
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_port_-_too_high
=== RUN   TestProductionIssue19_ValidationCoverage/valid_port_-_minimum
=== RUN   TestProductionIssue19_ValidationCoverage/valid_port_-_maximum
=== RUN   TestProductionIssue19_ValidationCoverage/missing_JWT_secret
=== RUN   TestProductionIssue19_ValidationCoverage/missing_database_URI
=== RUN   TestProductionIssue19_ValidationCoverage/missing_database_name
=== RUN   TestProductionIssue19_ValidationCoverage/missing_database_collection
=== RUN   TestProductionIssue19_ValidationCoverage/missing_storage_bucket
=== RUN   TestProductionIssue19_ValidationCoverage/missing_storage_region
=== RUN   TestProductionIssue19_ValidationCoverage/missing_storage_access_key_ID
=== RUN   TestProductionIssue19_ValidationCoverage/missing_storage_secret_access_key
=== RUN   TestProductionIssue19_ValidationCoverage/no_LLM_providers
=== RUN   TestProductionIssue19_ValidationCoverage/missing_LLM_provider_ID
=== RUN   TestProductionIssue19_ValidationCoverage/missing_LLM_provider_name
=== RUN   TestProductionIssue19_ValidationCoverage/missing_LLM_provider_type
=== RUN   TestProductionIssue19_ValidationCoverage/missing_LLM_provider_endpoint
=== RUN   TestProductionIssue19_ValidationCoverage/missing_LLM_provider_API_key
=== RUN   TestProductionIssue19_ValidationCoverage/JWT_secret_too_short
=== RUN   TestProductionIssue19_ValidationCoverage/weak_JWT_secret_-_contains_'password'
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_LLM_provider_type
=== RUN   TestProductionIssue19_ValidationCoverage/valid_LLM_provider_type_-_openai
=== RUN   TestProductionIssue19_ValidationCoverage/valid_LLM_provider_type_-_anthropic
=== RUN   TestProductionIssue19_ValidationCoverage/valid_LLM_provider_type_-_dify
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_reconnect_timeout_-_zero
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_reconnect_timeout_-_negative
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_max_connections_-_zero
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_max_connections_-_negative
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_rate_limit_-_zero
=== RUN   TestProductionIssue19_ValidationCoverage/invalid_rate_limit_-_negative
=== RUN   TestProductionIssue19_ValidationCoverage/valid_config_-_all_fields_correct
=== NAME  TestProductionIssue19_ValidationCoverage
    config_production_test.go:394: STATUS: All config fields are validated
    config_production_test.go:395: FINDING: Comprehensive validation coverage exists
    config_production_test.go:396: COVERAGE: Port range, required fields, format validation all tested
--- PASS: TestProductionIssue19_ValidationCoverage (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_port_-_too_low (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_port_-_negative (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_port_-_too_high (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/valid_port_-_minimum (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/valid_port_-_maximum (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_JWT_secret (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_database_URI (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_database_name (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_database_collection (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_storage_bucket (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_storage_region (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_storage_access_key_ID (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_storage_secret_access_key (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/no_LLM_providers (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_LLM_provider_ID (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_LLM_provider_name (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_LLM_provider_type (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_LLM_provider_endpoint (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/missing_LLM_provider_API_key (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/JWT_secret_too_short (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/weak_JWT_secret_-_contains_'password' (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_LLM_provider_type (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/valid_LLM_provider_type_-_openai (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/valid_LLM_provider_type_-_anthropic (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/valid_LLM_provider_type_-_dify (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_reconnect_timeout_-_zero (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_reconnect_timeout_-_negative (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_max_connections_-_zero (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_max_connections_-_negative (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_rate_limit_-_zero (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/invalid_rate_limit_-_negative (0.00s)
    --- PASS: TestProductionIssue19_ValidationCoverage/valid_config_-_all_fields_correct (0.00s)
=== RUN   TestLLMStreamTimeout_DefaultValue
    config_production_test.go:471: STATUS: LLMStreamTimeout defaults to 120 seconds
--- PASS: TestLLMStreamTimeout_DefaultValue (0.00s)
=== RUN   TestLLMStreamTimeout_EnvironmentVariable
=== RUN   TestLLMStreamTimeout_EnvironmentVariable/custom_timeout_-_60_seconds
=== RUN   TestLLMStreamTimeout_EnvironmentVariable/custom_timeout_-_5_minutes
=== RUN   TestLLMStreamTimeout_EnvironmentVariable/custom_timeout_-_300_seconds
=== RUN   TestLLMStreamTimeout_EnvironmentVariable/invalid_value_-_falls_back_to_default
=== NAME  TestLLMStreamTimeout_EnvironmentVariable
    config_production_test.go:523: STATUS: LLMStreamTimeout can be configured via LLM_STREAM_TIMEOUT env var
--- PASS: TestLLMStreamTimeout_EnvironmentVariable (0.00s)
    --- PASS: TestLLMStreamTimeout_EnvironmentVariable/custom_timeout_-_60_seconds (0.00s)
    --- PASS: TestLLMStreamTimeout_EnvironmentVariable/custom_timeout_-_5_minutes (0.00s)
    --- PASS: TestLLMStreamTimeout_EnvironmentVariable/custom_timeout_-_300_seconds (0.00s)
    --- PASS: TestLLMStreamTimeout_EnvironmentVariable/invalid_value_-_falls_back_to_default (0.00s)
=== RUN   TestProperty_WeakSecretsAreRejected
+ secrets shorter than 32 characters are rejected: OK, passed 100 tests.
+ secrets containing weak patterns are rejected: OK, passed 100 tests.
+ empty secret is rejected: OK, passed 100 tests.
--- PASS: TestProperty_WeakSecretsAreRejected (0.00s)
=== RUN   TestProperty_StrongSecretsAreAccepted
+ strong random secrets are accepted: OK, passed 100 tests.
--- PASS: TestProperty_StrongSecretsAreAccepted (0.00s)
=== RUN   TestLoad_DefaultValues
--- PASS: TestLoad_DefaultValues (0.00s)
=== RUN   TestLoad_EnvironmentVariables
--- PASS: TestLoad_EnvironmentVariables (0.00s)
=== RUN   TestLoad_LLMProviders
--- PASS: TestLoad_LLMProviders (0.00s)
=== RUN   TestValidate_ValidConfig
--- PASS: TestValidate_ValidConfig (0.00s)
=== RUN   TestValidate_InvalidServerPort
=== RUN   TestValidate_InvalidServerPort/zero_port
=== RUN   TestValidate_InvalidServerPort/negative_port
=== RUN   TestValidate_InvalidServerPort/port_too_large
--- PASS: TestValidate_InvalidServerPort (0.00s)
    --- PASS: TestValidate_InvalidServerPort/zero_port (0.00s)
    --- PASS: TestValidate_InvalidServerPort/negative_port (0.00s)
    --- PASS: TestValidate_InvalidServerPort/port_too_large (0.00s)
=== RUN   TestValidate_MissingJWTSecret
--- PASS: TestValidate_MissingJWTSecret (0.00s)
=== RUN   TestValidate_InvalidReconnectTimeout
--- PASS: TestValidate_InvalidReconnectTimeout (0.00s)
=== RUN   TestValidate_InvalidMaxConnections
--- PASS: TestValidate_InvalidMaxConnections (0.00s)
=== RUN   TestValidate_InvalidRateLimit
--- PASS: TestValidate_InvalidRateLimit (0.00s)
=== RUN   TestValidate_MissingDatabaseURI
--- PASS: TestValidate_MissingDatabaseURI (0.00s)
=== RUN   TestValidate_MissingDatabaseName
--- PASS: TestValidate_MissingDatabaseName (0.00s)
=== RUN   TestValidate_MissingDatabaseCollection
--- PASS: TestValidate_MissingDatabaseCollection (0.00s)
=== RUN   TestValidate_MissingStorageBucket
--- PASS: TestValidate_MissingStorageBucket (0.00s)
=== RUN   TestValidate_MissingStorageRegion
--- PASS: TestValidate_MissingStorageRegion (0.00s)
=== RUN   TestValidate_MissingStorageCredentials
=== RUN   TestValidate_MissingStorageCredentials/missing_access_key
=== RUN   TestValidate_MissingStorageCredentials/missing_secret_key
--- PASS: TestValidate_MissingStorageCredentials (0.00s)
    --- PASS: TestValidate_MissingStorageCredentials/missing_access_key (0.00s)
    --- PASS: TestValidate_MissingStorageCredentials/missing_secret_key (0.00s)
=== RUN   TestValidate_NoLLMProviders
--- PASS: TestValidate_NoLLMProviders (0.00s)
=== RUN   TestValidate_InvalidLLMProvider
=== RUN   TestValidate_InvalidLLMProvider/missing_ID
=== RUN   TestValidate_InvalidLLMProvider/missing_name
=== RUN   TestValidate_InvalidLLMProvider/missing_type
=== RUN   TestValidate_InvalidLLMProvider/invalid_type
=== RUN   TestValidate_InvalidLLMProvider/missing_endpoint
=== RUN   TestValidate_InvalidLLMProvider/missing_API_key
--- PASS: TestValidate_InvalidLLMProvider (0.00s)
    --- PASS: TestValidate_InvalidLLMProvider/missing_ID (0.00s)
    --- PASS: TestValidate_InvalidLLMProvider/missing_name (0.00s)
    --- PASS: TestValidate_InvalidLLMProvider/missing_type (0.00s)
    --- PASS: TestValidate_InvalidLLMProvider/invalid_type (0.00s)
    --- PASS: TestValidate_InvalidLLMProvider/missing_endpoint (0.00s)
    --- PASS: TestValidate_InvalidLLMProvider/missing_API_key (0.00s)
=== RUN   TestGetEnvAsSlice
=== RUN   TestGetEnvAsSlice/empty_string
=== RUN   TestGetEnvAsSlice/single_value
=== RUN   TestGetEnvAsSlice/multiple_values
=== RUN   TestGetEnvAsSlice/values_with_spaces
--- PASS: TestGetEnvAsSlice (0.00s)
    --- PASS: TestGetEnvAsSlice/empty_string (0.00s)
    --- PASS: TestGetEnvAsSlice/single_value (0.00s)
    --- PASS: TestGetEnvAsSlice/multiple_values (0.00s)
    --- PASS: TestGetEnvAsSlice/values_with_spaces (0.00s)
=== RUN   TestGetEnvAsInt_InvalidValue
=== RUN   TestGetEnvAsInt_InvalidValue/invalid_integer
=== RUN   TestGetEnvAsInt_InvalidValue/empty_string
=== RUN   TestGetEnvAsInt_InvalidValue/valid_integer
--- PASS: TestGetEnvAsInt_InvalidValue (0.00s)
    --- PASS: TestGetEnvAsInt_InvalidValue/invalid_integer (0.00s)
    --- PASS: TestGetEnvAsInt_InvalidValue/empty_string (0.00s)
    --- PASS: TestGetEnvAsInt_InvalidValue/valid_integer (0.00s)
=== RUN   TestGetEnvAsBool_InvalidValue
=== RUN   TestGetEnvAsBool_InvalidValue/invalid_boolean
=== RUN   TestGetEnvAsBool_InvalidValue/empty_string
=== RUN   TestGetEnvAsBool_InvalidValue/valid_true
=== RUN   TestGetEnvAsBool_InvalidValue/valid_false
=== RUN   TestGetEnvAsBool_InvalidValue/valid_1
=== RUN   TestGetEnvAsBool_InvalidValue/valid_0
--- PASS: TestGetEnvAsBool_InvalidValue (0.00s)
    --- PASS: TestGetEnvAsBool_InvalidValue/invalid_boolean (0.00s)
    --- PASS: TestGetEnvAsBool_InvalidValue/empty_string (0.00s)
    --- PASS: TestGetEnvAsBool_InvalidValue/valid_true (0.00s)
    --- PASS: TestGetEnvAsBool_InvalidValue/valid_false (0.00s)
    --- PASS: TestGetEnvAsBool_InvalidValue/valid_1 (0.00s)
    --- PASS: TestGetEnvAsBool_InvalidValue/valid_0 (0.00s)
=== RUN   TestGetEnvAsDuration_InvalidValue
=== RUN   TestGetEnvAsDuration_InvalidValue/invalid_duration
=== RUN   TestGetEnvAsDuration_InvalidValue/empty_string
=== RUN   TestGetEnvAsDuration_InvalidValue/valid_duration
=== RUN   TestGetEnvAsDuration_InvalidValue/valid_duration_with_minutes
--- PASS: TestGetEnvAsDuration_InvalidValue (0.00s)
    --- PASS: TestGetEnvAsDuration_InvalidValue/invalid_duration (0.00s)
    --- PASS: TestGetEnvAsDuration_InvalidValue/empty_string (0.00s)
    --- PASS: TestGetEnvAsDuration_InvalidValue/valid_duration (0.00s)
    --- PASS: TestGetEnvAsDuration_InvalidValue/valid_duration_with_minutes (0.00s)
=== RUN   TestLoad_KubernetesConfig
--- PASS: TestLoad_KubernetesConfig (0.00s)
=== RUN   TestLoad_NotificationConfig
--- PASS: TestLoad_NotificationConfig (0.00s)
=== RUN   TestLoad_AllLLMProviderTypes
--- PASS: TestLoad_AllLLMProviderTypes (0.00s)
=== RUN   TestValidate_MultipleErrors
--- PASS: TestValidate_MultipleErrors (0.00s)
=== RUN   TestLoad_EmptyLLMProviderSkipped
--- PASS: TestLoad_EmptyLLMProviderSkipped (0.00s)
=== RUN   TestLoad_DatabaseConnectTimeout
--- PASS: TestLoad_DatabaseConnectTimeout (0.00s)
=== RUN   TestPathPrefix_DefaultValue
--- PASS: TestPathPrefix_DefaultValue (0.00s)
=== RUN   TestPathPrefix_EnvironmentVariable
=== RUN   TestPathPrefix_EnvironmentVariable/custom_prefix
=== RUN   TestPathPrefix_EnvironmentVariable/single_slash
=== RUN   TestPathPrefix_EnvironmentVariable/nested_path
--- PASS: TestPathPrefix_EnvironmentVariable (0.00s)
    --- PASS: TestPathPrefix_EnvironmentVariable/custom_prefix (0.00s)
    --- PASS: TestPathPrefix_EnvironmentVariable/single_slash (0.00s)
    --- PASS: TestPathPrefix_EnvironmentVariable/nested_path (0.00s)
=== RUN   TestPathPrefix_ConfigFile
=== RUN   TestPathPrefix_ConfigFile/from_config_file_when_env_not_set
=== RUN   TestPathPrefix_ConfigFile/env_overrides_config_file
--- PASS: TestPathPrefix_ConfigFile (0.00s)
    --- PASS: TestPathPrefix_ConfigFile/from_config_file_when_env_not_set (0.00s)
    --- PASS: TestPathPrefix_ConfigFile/env_overrides_config_file (0.00s)
=== RUN   TestPathPrefix_Validation
=== RUN   TestPathPrefix_Validation/valid_prefix
=== RUN   TestPathPrefix_Validation/empty_prefix
=== RUN   TestPathPrefix_Validation/missing_leading_slash
=== RUN   TestPathPrefix_Validation/single_slash
=== RUN   TestPathPrefix_Validation/nested_path
--- PASS: TestPathPrefix_Validation (0.00s)
    --- PASS: TestPathPrefix_Validation/valid_prefix (0.00s)
    --- PASS: TestPathPrefix_Validation/empty_prefix (0.00s)
    --- PASS: TestPathPrefix_Validation/missing_leading_slash (0.00s)
    --- PASS: TestPathPrefix_Validation/single_slash (0.00s)
    --- PASS: TestPathPrefix_Validation/nested_path (0.00s)
=== RUN   TestProperty_InvalidConfigRejection
--- PASS: TestProperty_InvalidConfigRejection (0.00s)
=== RUN   TestProperty_WeakSecretRejection
--- PASS: TestProperty_WeakSecretRejection (0.00s)
=== RUN   TestProperty_ValidConfigAcceptance
--- PASS: TestProperty_ValidConfigAcceptance (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/config	2.608s
?   	github.com/real-rm/chatbox/internal/constants	[no test files]
=== RUN   TestProperty_ErrorMessageGeneration
+ Error message contains type and description: OK, passed 100 tests.
+ Auth errors are always fatal (not recoverable): OK, passed 100 tests.
+ Validation errors are always recoverable: OK, passed 100 tests.
+ Service errors are always recoverable: OK, passed 100 tests.
+ Rate limit errors include retry after value: OK, passed 100 tests.
+ Error implements error interface: OK, passed 100 tests.
+ ToErrorInfo preserves all error information: OK, passed 100 tests.
--- PASS: TestProperty_ErrorMessageGeneration (0.01s)
=== RUN   TestProperty_FatalErrorConnectionClosure
+ Fatal errors are marked as non-recoverable: OK, passed 100 tests.
+ IsFatal returns opposite of Recoverable: OK, passed 100 tests.
+ Auth errors are always fatal: OK, passed 100 tests.
+ Non-auth errors are never fatal: OK, passed 100 tests.
+ ErrorInfo recoverable flag matches ChatError: OK, passed 100 tests.
--- PASS: TestProperty_FatalErrorConnectionClosure (0.00s)
=== RUN   TestConvenienceConstructors
=== RUN   TestConvenienceConstructors/ErrInvalidToken_creates_auth_error
=== RUN   TestConvenienceConstructors/ErrExpiredToken_creates_auth_error
=== RUN   TestConvenienceConstructors/ErrMissingField_creates_validation_error
=== RUN   TestConvenienceConstructors/ErrLLMUnavailable_creates_service_error
=== RUN   TestConvenienceConstructors/ErrTooManyRequests_creates_rate_limit_error
--- PASS: TestConvenienceConstructors (0.00s)
    --- PASS: TestConvenienceConstructors/ErrInvalidToken_creates_auth_error (0.00s)
    --- PASS: TestConvenienceConstructors/ErrExpiredToken_creates_auth_error (0.00s)
    --- PASS: TestConvenienceConstructors/ErrMissingField_creates_validation_error (0.00s)
    --- PASS: TestConvenienceConstructors/ErrLLMUnavailable_creates_service_error (0.00s)
    --- PASS: TestConvenienceConstructors/ErrTooManyRequests_creates_rate_limit_error (0.00s)
=== RUN   TestNewAuthError
--- PASS: TestNewAuthError (0.00s)
=== RUN   TestNewValidationError
--- PASS: TestNewValidationError (0.00s)
=== RUN   TestNewServiceError
--- PASS: TestNewServiceError (0.00s)
=== RUN   TestNewRateLimitError
--- PASS: TestNewRateLimitError (0.00s)
=== RUN   TestErrInvalidToken
--- PASS: TestErrInvalidToken (0.00s)
=== RUN   TestErrExpiredToken
--- PASS: TestErrExpiredToken (0.00s)
=== RUN   TestErrInsufficientPermissions
--- PASS: TestErrInsufficientPermissions (0.00s)
=== RUN   TestErrInvalidMessageFormat
--- PASS: TestErrInvalidMessageFormat (0.00s)
=== RUN   TestErrMissingField
--- PASS: TestErrMissingField (0.00s)
=== RUN   TestErrInvalidFileType
--- PASS: TestErrInvalidFileType (0.00s)
=== RUN   TestErrInvalidFileSize
--- PASS: TestErrInvalidFileSize (0.00s)
=== RUN   TestErrLLMUnavailable
--- PASS: TestErrLLMUnavailable (0.00s)
=== RUN   TestErrLLMTimeout
--- PASS: TestErrLLMTimeout (0.00s)
=== RUN   TestErrDatabaseError
--- PASS: TestErrDatabaseError (0.00s)
=== RUN   TestErrStorageError
--- PASS: TestErrStorageError (0.00s)
=== RUN   TestErrTooManyRequests
--- PASS: TestErrTooManyRequests (0.00s)
=== RUN   TestErrConnectionLimitExceeded
--- PASS: TestErrConnectionLimitExceeded (0.00s)
=== RUN   TestErrNotFound
--- PASS: TestErrNotFound (0.00s)
=== RUN   TestErrUnauthorized
--- PASS: TestErrUnauthorized (0.00s)
=== RUN   TestErrorCodeConstants
=== RUN   TestErrorCodeConstants/InvalidToken
=== RUN   TestErrorCodeConstants/ExpiredToken
=== RUN   TestErrorCodeConstants/InsufficientPerms
=== RUN   TestErrorCodeConstants/Unauthorized
=== RUN   TestErrorCodeConstants/InvalidFormat
=== RUN   TestErrorCodeConstants/MissingField
=== RUN   TestErrorCodeConstants/InvalidFileType
=== RUN   TestErrorCodeConstants/InvalidFileSize
=== RUN   TestErrorCodeConstants/NotFound
=== RUN   TestErrorCodeConstants/LLMUnavailable
=== RUN   TestErrorCodeConstants/LLMTimeout
=== RUN   TestErrorCodeConstants/DatabaseError
=== RUN   TestErrorCodeConstants/StorageError
=== RUN   TestErrorCodeConstants/ServiceError
=== RUN   TestErrorCodeConstants/TooManyRequests
=== RUN   TestErrorCodeConstants/ConnectionLimit
--- PASS: TestErrorCodeConstants (0.00s)
    --- PASS: TestErrorCodeConstants/InvalidToken (0.00s)
    --- PASS: TestErrorCodeConstants/ExpiredToken (0.00s)
    --- PASS: TestErrorCodeConstants/InsufficientPerms (0.00s)
    --- PASS: TestErrorCodeConstants/Unauthorized (0.00s)
    --- PASS: TestErrorCodeConstants/InvalidFormat (0.00s)
    --- PASS: TestErrorCodeConstants/MissingField (0.00s)
    --- PASS: TestErrorCodeConstants/InvalidFileType (0.00s)
    --- PASS: TestErrorCodeConstants/InvalidFileSize (0.00s)
    --- PASS: TestErrorCodeConstants/NotFound (0.00s)
    --- PASS: TestErrorCodeConstants/LLMUnavailable (0.00s)
    --- PASS: TestErrorCodeConstants/LLMTimeout (0.00s)
    --- PASS: TestErrorCodeConstants/DatabaseError (0.00s)
    --- PASS: TestErrorCodeConstants/StorageError (0.00s)
    --- PASS: TestErrorCodeConstants/ServiceError (0.00s)
    --- PASS: TestErrorCodeConstants/TooManyRequests (0.00s)
    --- PASS: TestErrorCodeConstants/ConnectionLimit (0.00s)
=== RUN   TestErrorCategoryConstants
=== RUN   TestErrorCategoryConstants/Auth
=== RUN   TestErrorCategoryConstants/Validation
=== RUN   TestErrorCategoryConstants/Service
=== RUN   TestErrorCategoryConstants/RateLimit
--- PASS: TestErrorCategoryConstants (0.00s)
    --- PASS: TestErrorCategoryConstants/Auth (0.00s)
    --- PASS: TestErrorCategoryConstants/Validation (0.00s)
    --- PASS: TestErrorCategoryConstants/Service (0.00s)
    --- PASS: TestErrorCategoryConstants/RateLimit (0.00s)
=== RUN   TestChatErrorError
=== RUN   TestChatErrorError/Error_without_cause
=== RUN   TestChatErrorError/Error_with_cause
=== RUN   TestChatErrorError/Error_with_formatted_message
--- PASS: TestChatErrorError (0.00s)
    --- PASS: TestChatErrorError/Error_without_cause (0.00s)
    --- PASS: TestChatErrorError/Error_with_cause (0.00s)
    --- PASS: TestChatErrorError/Error_with_formatted_message (0.00s)
=== RUN   TestChatErrorUnwrap
=== RUN   TestChatErrorUnwrap/Unwrap_returns_cause
=== RUN   TestChatErrorUnwrap/Unwrap_returns_nil_when_no_cause
--- PASS: TestChatErrorUnwrap (0.00s)
    --- PASS: TestChatErrorUnwrap/Unwrap_returns_cause (0.00s)
    --- PASS: TestChatErrorUnwrap/Unwrap_returns_nil_when_no_cause (0.00s)
=== RUN   TestChatErrorIsFatal
=== RUN   TestChatErrorIsFatal/Auth_error_is_fatal
=== RUN   TestChatErrorIsFatal/Validation_error_is_not_fatal
=== RUN   TestChatErrorIsFatal/Service_error_is_not_fatal
=== RUN   TestChatErrorIsFatal/Rate_limit_error_is_not_fatal
--- PASS: TestChatErrorIsFatal (0.00s)
    --- PASS: TestChatErrorIsFatal/Auth_error_is_fatal (0.00s)
    --- PASS: TestChatErrorIsFatal/Validation_error_is_not_fatal (0.00s)
    --- PASS: TestChatErrorIsFatal/Service_error_is_not_fatal (0.00s)
    --- PASS: TestChatErrorIsFatal/Rate_limit_error_is_not_fatal (0.00s)
=== RUN   TestChatErrorToErrorInfo
=== RUN   TestChatErrorToErrorInfo/Auth_error_conversion
=== RUN   TestChatErrorToErrorInfo/Rate_limit_error_conversion
=== RUN   TestChatErrorToErrorInfo/Validation_error_conversion
=== RUN   TestChatErrorToErrorInfo/Service_error_conversion
--- PASS: TestChatErrorToErrorInfo (0.00s)
    --- PASS: TestChatErrorToErrorInfo/Auth_error_conversion (0.00s)
    --- PASS: TestChatErrorToErrorInfo/Rate_limit_error_conversion (0.00s)
    --- PASS: TestChatErrorToErrorInfo/Validation_error_conversion (0.00s)
    --- PASS: TestChatErrorToErrorInfo/Service_error_conversion (0.00s)
=== RUN   TestToErrorInfoConversion
=== RUN   TestToErrorInfoConversion/Auth_error_with_all_fields
=== RUN   TestToErrorInfoConversion/Rate_limit_error_with_retry_after
=== RUN   TestToErrorInfoConversion/Validation_error_without_retry_after
=== RUN   TestToErrorInfoConversion/Service_error_conversion
--- PASS: TestToErrorInfoConversion (0.00s)
    --- PASS: TestToErrorInfoConversion/Auth_error_with_all_fields (0.00s)
    --- PASS: TestToErrorInfoConversion/Rate_limit_error_with_retry_after (0.00s)
    --- PASS: TestToErrorInfoConversion/Validation_error_without_retry_after (0.00s)
    --- PASS: TestToErrorInfoConversion/Service_error_conversion (0.00s)
=== RUN   TestJSONMarshaling
=== RUN   TestJSONMarshaling/Marshal_auth_error
=== RUN   TestJSONMarshaling/Marshal_rate_limit_error_with_retry_after
=== RUN   TestJSONMarshaling/Marshal_validation_error_without_retry_after
=== RUN   TestJSONMarshaling/Unmarshal_JSON_to_ErrorInfo
=== RUN   TestJSONMarshaling/Round-trip_marshal_and_unmarshal
--- PASS: TestJSONMarshaling (0.00s)
    --- PASS: TestJSONMarshaling/Marshal_auth_error (0.00s)
    --- PASS: TestJSONMarshaling/Marshal_rate_limit_error_with_retry_after (0.00s)
    --- PASS: TestJSONMarshaling/Marshal_validation_error_without_retry_after (0.00s)
    --- PASS: TestJSONMarshaling/Unmarshal_JSON_to_ErrorInfo (0.00s)
    --- PASS: TestJSONMarshaling/Round-trip_marshal_and_unmarshal (0.00s)
=== RUN   TestErrorWrapping
=== RUN   TestErrorWrapping/Wrap_error_with_cause
=== RUN   TestErrorWrapping/Error_string_includes_cause
=== RUN   TestErrorWrapping/Error_without_cause
=== RUN   TestErrorWrapping/Nested_error_wrapping
=== RUN   TestErrorWrapping/Convenience_constructors_preserve_cause
=== RUN   TestErrorWrapping/ToErrorInfo_does_not_expose_cause
--- PASS: TestErrorWrapping (0.00s)
    --- PASS: TestErrorWrapping/Wrap_error_with_cause (0.00s)
    --- PASS: TestErrorWrapping/Error_string_includes_cause (0.00s)
    --- PASS: TestErrorWrapping/Error_without_cause (0.00s)
    --- PASS: TestErrorWrapping/Nested_error_wrapping (0.00s)
    --- PASS: TestErrorWrapping/Convenience_constructors_preserve_cause (0.00s)
    --- PASS: TestErrorWrapping/ToErrorInfo_does_not_expose_cause (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/errors	2.100s
=== RUN   TestRespondUnauthorized
--- PASS: TestRespondUnauthorized (0.00s)
=== RUN   TestRespondInvalidToken
--- PASS: TestRespondInvalidToken (0.00s)
=== RUN   TestRespondForbidden
--- PASS: TestRespondForbidden (0.00s)
=== RUN   TestRespondBadRequest
--- PASS: TestRespondBadRequest (0.00s)
=== RUN   TestRespondInternalError
--- PASS: TestRespondInternalError (0.00s)
=== RUN   TestRespondServiceUnavailable
--- PASS: TestRespondServiceUnavailable (0.00s)
=== RUN   TestRespondNotFound
--- PASS: TestRespondNotFound (0.00s)
=== RUN   TestErrorResponseDoesNotLeakInternalDetails
=== RUN   TestErrorResponseDoesNotLeakInternalDetails/Unauthorized
=== RUN   TestErrorResponseDoesNotLeakInternalDetails/InvalidToken
=== RUN   TestErrorResponseDoesNotLeakInternalDetails/Forbidden
=== RUN   TestErrorResponseDoesNotLeakInternalDetails/InternalError
=== RUN   TestErrorResponseDoesNotLeakInternalDetails/ServiceUnavailable
--- PASS: TestErrorResponseDoesNotLeakInternalDetails (0.00s)
    --- PASS: TestErrorResponseDoesNotLeakInternalDetails/Unauthorized (0.00s)
    --- PASS: TestErrorResponseDoesNotLeakInternalDetails/InvalidToken (0.00s)
    --- PASS: TestErrorResponseDoesNotLeakInternalDetails/Forbidden (0.00s)
    --- PASS: TestErrorResponseDoesNotLeakInternalDetails/InternalError (0.00s)
    --- PASS: TestErrorResponseDoesNotLeakInternalDetails/ServiceUnavailable (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/httperrors	2.755s
=== RUN   TestAnthropicProvider_SendMessage
=== RUN   TestAnthropicProvider_SendMessage/successful_request
=== RUN   TestAnthropicProvider_SendMessage/API_error_response
=== RUN   TestAnthropicProvider_SendMessage/empty_content
--- PASS: TestAnthropicProvider_SendMessage (0.00s)
    --- PASS: TestAnthropicProvider_SendMessage/successful_request (0.00s)
    --- PASS: TestAnthropicProvider_SendMessage/API_error_response (0.00s)
    --- PASS: TestAnthropicProvider_SendMessage/empty_content (0.00s)
=== RUN   TestAnthropicProvider_StreamMessage
=== RUN   TestAnthropicProvider_StreamMessage/successful_streaming
=== RUN   TestAnthropicProvider_StreamMessage/API_error_response
--- PASS: TestAnthropicProvider_StreamMessage (0.00s)
    --- PASS: TestAnthropicProvider_StreamMessage/successful_streaming (0.00s)
    --- PASS: TestAnthropicProvider_StreamMessage/API_error_response (0.00s)
=== RUN   TestAnthropicProvider_GetTokenCount
=== RUN   TestAnthropicProvider_GetTokenCount/short_text
=== RUN   TestAnthropicProvider_GetTokenCount/medium_text
=== RUN   TestAnthropicProvider_GetTokenCount/empty_text
--- PASS: TestAnthropicProvider_GetTokenCount (0.00s)
    --- PASS: TestAnthropicProvider_GetTokenCount/short_text (0.00s)
    --- PASS: TestAnthropicProvider_GetTokenCount/medium_text (0.00s)
    --- PASS: TestAnthropicProvider_GetTokenCount/empty_text (0.00s)
=== RUN   TestAnthropicProvider_SystemMessageHandling
--- PASS: TestAnthropicProvider_SystemMessageHandling (0.00s)
=== RUN   TestDifyProvider_SendMessage
=== RUN   TestDifyProvider_SendMessage/successful_request
=== RUN   TestDifyProvider_SendMessage/API_error_response
=== RUN   TestDifyProvider_SendMessage/empty_answer
--- PASS: TestDifyProvider_SendMessage (0.00s)
    --- PASS: TestDifyProvider_SendMessage/successful_request (0.00s)
    --- PASS: TestDifyProvider_SendMessage/API_error_response (0.00s)
    --- PASS: TestDifyProvider_SendMessage/empty_answer (0.00s)
=== RUN   TestDifyProvider_StreamMessage
=== RUN   TestDifyProvider_StreamMessage/successful_streaming
=== RUN   TestDifyProvider_StreamMessage/streaming_with_error_event
=== RUN   TestDifyProvider_StreamMessage/API_error_response
--- PASS: TestDifyProvider_StreamMessage (0.00s)
    --- PASS: TestDifyProvider_StreamMessage/successful_streaming (0.00s)
    --- PASS: TestDifyProvider_StreamMessage/streaming_with_error_event (0.00s)
    --- PASS: TestDifyProvider_StreamMessage/API_error_response (0.00s)
=== RUN   TestDifyProvider_GetTokenCount
=== RUN   TestDifyProvider_GetTokenCount/short_text
=== RUN   TestDifyProvider_GetTokenCount/medium_text
=== RUN   TestDifyProvider_GetTokenCount/empty_text
--- PASS: TestDifyProvider_GetTokenCount (0.00s)
    --- PASS: TestDifyProvider_GetTokenCount/short_text (0.00s)
    --- PASS: TestDifyProvider_GetTokenCount/medium_text (0.00s)
    --- PASS: TestDifyProvider_GetTokenCount/empty_text (0.00s)
=== RUN   TestDifyProvider_FormatMessages
=== RUN   TestDifyProvider_FormatMessages/single_message
=== RUN   TestDifyProvider_FormatMessages/multiple_messages
=== RUN   TestDifyProvider_FormatMessages/empty_messages
--- PASS: TestDifyProvider_FormatMessages (0.00s)
    --- PASS: TestDifyProvider_FormatMessages/single_message (0.00s)
    --- PASS: TestDifyProvider_FormatMessages/multiple_messages (0.00s)
    --- PASS: TestDifyProvider_FormatMessages/empty_messages (0.00s)
=== RUN   TestDifyProvider_MultipleMessages
--- PASS: TestDifyProvider_MultipleMessages (0.00s)
=== RUN   TestAllProviders_Integration
=== RUN   TestAllProviders_Integration/OpenAI
=== RUN   TestAllProviders_Integration/OpenAI/SendMessage
    integration_test.go:109: OpenAI SendMessage returned expected error (invalid API key): OpenAI API error (status 401): {
            "error": {
                "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
                "type": "invalid_request_error",
                "param": null,
                "code": "invalid_api_key"
            }
        }
=== RUN   TestAllProviders_Integration/OpenAI/StreamMessage
    integration_test.go:140: OpenAI StreamMessage returned expected error (invalid API key): OpenAI API error (status 401): {
            "error": {
                "message": "Incorrect API key provided: test-key. You can find your API key at https://platform.openai.com/account/api-keys.",
                "type": "invalid_request_error",
                "param": null,
                "code": "invalid_api_key"
            }
        }
=== RUN   TestAllProviders_Integration/OpenAI/ErrorHandling
    integration_test.go:193: OpenAI correctly handled cancelled context: failed to send request: Post "https://api.openai.com/v1/chat/completions": context canceled
    integration_test.go:202: OpenAI correctly handled timeout: failed to send request: Post "https://api.openai.com/v1/chat/completions": context deadline exceeded
=== RUN   TestAllProviders_Integration/OpenAI/TokenCount
=== RUN   TestAllProviders_Integration/OpenAI/TokenCount/empty_text
    integration_test.go:243: OpenAI token count for 0 chars: 0 tokens
=== RUN   TestAllProviders_Integration/OpenAI/TokenCount/short_text
    integration_test.go:243: OpenAI token count for 5 chars: 1 tokens
=== RUN   TestAllProviders_Integration/OpenAI/TokenCount/medium_text
    integration_test.go:243: OpenAI token count for 55 chars: 13 tokens
=== RUN   TestAllProviders_Integration/OpenAI/TokenCount/long_text
    integration_test.go:243: OpenAI token count for 240 chars: 60 tokens
=== RUN   TestAllProviders_Integration/Anthropic
=== RUN   TestAllProviders_Integration/Anthropic/SendMessage
    integration_test.go:109: Anthropic SendMessage returned expected error (invalid API key): Anthropic API error (status 401): {"type":"error","error":{"type":"authentication_error","message":"invalid x-api-key"},"request_id":"req_011CYDvG67o2gwJyW4agid79"}
=== RUN   TestAllProviders_Integration/Anthropic/StreamMessage
    integration_test.go:140: Anthropic StreamMessage returned expected error (invalid API key): Anthropic API error (status 401): {"type":"error","error":{"type":"authentication_error","message":"invalid x-api-key"},"request_id":"req_011CYDvG7VtMZidpf8mnNyrb"}
=== RUN   TestAllProviders_Integration/Anthropic/ErrorHandling
    integration_test.go:193: Anthropic correctly handled cancelled context: failed to send request: Post "https://api.anthropic.com/v1/messages": context canceled
    integration_test.go:202: Anthropic correctly handled timeout: failed to send request: Post "https://api.anthropic.com/v1/messages": context deadline exceeded
=== RUN   TestAllProviders_Integration/Anthropic/TokenCount
=== RUN   TestAllProviders_Integration/Anthropic/TokenCount/empty_text
    integration_test.go:243: Anthropic token count for 0 chars: 0 tokens
=== RUN   TestAllProviders_Integration/Anthropic/TokenCount/short_text
    integration_test.go:243: Anthropic token count for 5 chars: 1 tokens
=== RUN   TestAllProviders_Integration/Anthropic/TokenCount/medium_text
    integration_test.go:243: Anthropic token count for 55 chars: 13 tokens
=== RUN   TestAllProviders_Integration/Anthropic/TokenCount/long_text
    integration_test.go:243: Anthropic token count for 240 chars: 60 tokens
=== RUN   TestAllProviders_Integration/Dify
=== RUN   TestAllProviders_Integration/Dify/SendMessage
    integration_test.go:109: Dify SendMessage returned expected error (invalid API key): Dify API error (status 401): {"code":"unauthorized","message":"Access token is invalid","status":401}
=== RUN   TestAllProviders_Integration/Dify/StreamMessage
    integration_test.go:140: Dify StreamMessage returned expected error (invalid API key): Dify API error (status 401): {"code":"unauthorized","message":"Access token is invalid","status":401}
=== RUN   TestAllProviders_Integration/Dify/ErrorHandling
    integration_test.go:193: Dify correctly handled cancelled context: failed to send request: Post "https://api.dify.ai/v1/chat-messages": context canceled
    integration_test.go:202: Dify correctly handled timeout: failed to send request: Post "https://api.dify.ai/v1/chat-messages": context deadline exceeded
=== RUN   TestAllProviders_Integration/Dify/TokenCount
=== RUN   TestAllProviders_Integration/Dify/TokenCount/empty_text
    integration_test.go:243: Dify token count for 0 chars: 0 tokens
=== RUN   TestAllProviders_Integration/Dify/TokenCount/short_text
    integration_test.go:243: Dify token count for 5 chars: 1 tokens
=== RUN   TestAllProviders_Integration/Dify/TokenCount/medium_text
    integration_test.go:243: Dify token count for 55 chars: 13 tokens
=== RUN   TestAllProviders_Integration/Dify/TokenCount/long_text
    integration_test.go:243: Dify token count for 240 chars: 60 tokens
--- PASS: TestAllProviders_Integration (2.47s)
    --- PASS: TestAllProviders_Integration/OpenAI (0.60s)
        --- PASS: TestAllProviders_Integration/OpenAI/SendMessage (0.36s)
        --- PASS: TestAllProviders_Integration/OpenAI/StreamMessage (0.23s)
        --- PASS: TestAllProviders_Integration/OpenAI/ErrorHandling (0.01s)
        --- PASS: TestAllProviders_Integration/OpenAI/TokenCount (0.00s)
            --- PASS: TestAllProviders_Integration/OpenAI/TokenCount/empty_text (0.00s)
            --- PASS: TestAllProviders_Integration/OpenAI/TokenCount/short_text (0.00s)
            --- PASS: TestAllProviders_Integration/OpenAI/TokenCount/medium_text (0.00s)
            --- PASS: TestAllProviders_Integration/OpenAI/TokenCount/long_text (0.00s)
    --- PASS: TestAllProviders_Integration/Anthropic (0.81s)
        --- PASS: TestAllProviders_Integration/Anthropic/SendMessage (0.52s)
        --- PASS: TestAllProviders_Integration/Anthropic/StreamMessage (0.28s)
        --- PASS: TestAllProviders_Integration/Anthropic/ErrorHandling (0.01s)
        --- PASS: TestAllProviders_Integration/Anthropic/TokenCount (0.00s)
            --- PASS: TestAllProviders_Integration/Anthropic/TokenCount/empty_text (0.00s)
            --- PASS: TestAllProviders_Integration/Anthropic/TokenCount/short_text (0.00s)
            --- PASS: TestAllProviders_Integration/Anthropic/TokenCount/medium_text (0.00s)
            --- PASS: TestAllProviders_Integration/Anthropic/TokenCount/long_text (0.00s)
    --- PASS: TestAllProviders_Integration/Dify (1.05s)
        --- PASS: TestAllProviders_Integration/Dify/SendMessage (0.74s)
        --- PASS: TestAllProviders_Integration/Dify/StreamMessage (0.30s)
        --- PASS: TestAllProviders_Integration/Dify/ErrorHandling (0.01s)
        --- PASS: TestAllProviders_Integration/Dify/TokenCount (0.00s)
            --- PASS: TestAllProviders_Integration/Dify/TokenCount/empty_text (0.00s)
            --- PASS: TestAllProviders_Integration/Dify/TokenCount/short_text (0.00s)
            --- PASS: TestAllProviders_Integration/Dify/TokenCount/medium_text (0.00s)
            --- PASS: TestAllProviders_Integration/Dify/TokenCount/long_text (0.00s)
=== RUN   TestLLMService_AllProviders
=== RUN   TestLLMService_AllProviders/AllProvidersRegistered
=== RUN   TestLLMService_AllProviders/ValidateProviders
=== RUN   TestLLMService_AllProviders/SendMessageToAllProviders
=== RUN   TestLLMService_AllProviders/SendMessageToAllProviders/GPT-4
    integration_test.go:328: Provider GPT-4 returned expected error: non-retryable error: OpenAI API error (status 401): {
            "error": {
                "message": "Incorrect API key provided: test-key***enai. You can find your API key at https://platform.openai.com/account/api-keys.",
                "type": "invalid_request_error",
                "param": null,
                "code": "invalid_api_key"
            }
        }
=== RUN   TestLLMService_AllProviders/SendMessageToAllProviders/Claude
    integration_test.go:328: Provider Claude returned expected error: non-retryable error: Anthropic API error (status 401): {"type":"error","error":{"type":"authentication_error","message":"invalid x-api-key"},"request_id":"req_011CYDvGEUqBDnbeW48xdudW"}
=== RUN   TestLLMService_AllProviders/SendMessageToAllProviders/Dify_Assistant
    integration_test.go:328: Provider Dify Assistant returned expected error: non-retryable error: Dify API error (status 401): {"code":"unauthorized","message":"Access token is invalid","status":401}
=== RUN   TestLLMService_AllProviders/StreamMessageToAllProviders
=== RUN   TestLLMService_AllProviders/StreamMessageToAllProviders/GPT-4
    integration_test.go:347: Provider GPT-4 streaming returned expected error: non-retryable error: OpenAI API error (status 401): {
            "error": {
                "message": "Incorrect API key provided: test-key***enai. You can find your API key at https://platform.openai.com/account/api-keys.",
                "type": "invalid_request_error",
                "param": null,
                "code": "invalid_api_key"
            }
        }
=== RUN   TestLLMService_AllProviders/StreamMessageToAllProviders/Claude
    integration_test.go:347: Provider Claude streaming returned expected error: non-retryable error: Anthropic API error (status 401): {"type":"error","error":{"type":"authentication_error","message":"invalid x-api-key"},"request_id":"req_011CYDvGJG3SwaRWvsWQ7C8C"}
=== RUN   TestLLMService_AllProviders/StreamMessageToAllProviders/Dify_Assistant
    integration_test.go:347: Provider Dify Assistant streaming returned expected error: non-retryable error: Dify API error (status 401): {"code":"unauthorized","message":"Access token is invalid","status":401}
=== RUN   TestLLMService_AllProviders/TokenCountForAllProviders
=== RUN   TestLLMService_AllProviders/TokenCountForAllProviders/GPT-4
    integration_test.go:363: Provider GPT-4 token count: 10
=== RUN   TestLLMService_AllProviders/TokenCountForAllProviders/Claude
    integration_test.go:363: Provider Claude token count: 10
=== RUN   TestLLMService_AllProviders/TokenCountForAllProviders/Dify_Assistant
    integration_test.go:363: Provider Dify Assistant token count: 10
--- PASS: TestLLMService_AllProviders (1.77s)
    --- PASS: TestLLMService_AllProviders/AllProvidersRegistered (0.00s)
    --- PASS: TestLLMService_AllProviders/ValidateProviders (0.00s)
    --- PASS: TestLLMService_AllProviders/SendMessageToAllProviders (0.88s)
        --- PASS: TestLLMService_AllProviders/SendMessageToAllProviders/GPT-4 (0.29s)
        --- PASS: TestLLMService_AllProviders/SendMessageToAllProviders/Claude (0.29s)
        --- PASS: TestLLMService_AllProviders/SendMessageToAllProviders/Dify_Assistant (0.31s)
    --- PASS: TestLLMService_AllProviders/StreamMessageToAllProviders (0.89s)
        --- PASS: TestLLMService_AllProviders/StreamMessageToAllProviders/GPT-4 (0.28s)
        --- PASS: TestLLMService_AllProviders/StreamMessageToAllProviders/Claude (0.29s)
        --- PASS: TestLLMService_AllProviders/StreamMessageToAllProviders/Dify_Assistant (0.31s)
    --- PASS: TestLLMService_AllProviders/TokenCountForAllProviders (0.00s)
        --- PASS: TestLLMService_AllProviders/TokenCountForAllProviders/GPT-4 (0.00s)
        --- PASS: TestLLMService_AllProviders/TokenCountForAllProviders/Claude (0.00s)
        --- PASS: TestLLMService_AllProviders/TokenCountForAllProviders/Dify_Assistant (0.00s)
=== RUN   TestProviderRetryLogic_AllProviders
=== RUN   TestProviderRetryLogic_AllProviders/OpenAI_Retry_Test
    integration_test.go:428: Provider OpenAI Retry Test retry test completed in 708ns: LLM provider not found: openai-retry
=== RUN   TestProviderRetryLogic_AllProviders/Anthropic_Retry_Test
    integration_test.go:428: Provider Anthropic Retry Test retry test completed in 417ns: LLM provider not found: anthropic-retry
=== RUN   TestProviderRetryLogic_AllProviders/Dify_Retry_Test
    integration_test.go:428: Provider Dify Retry Test retry test completed in 250ns: LLM provider not found: dify-retry
--- PASS: TestProviderRetryLogic_AllProviders (0.00s)
    --- PASS: TestProviderRetryLogic_AllProviders/OpenAI_Retry_Test (0.00s)
    --- PASS: TestProviderRetryLogic_AllProviders/Anthropic_Retry_Test (0.00s)
    --- PASS: TestProviderRetryLogic_AllProviders/Dify_Retry_Test (0.00s)
=== RUN   TestProperty_ValidMessageRoutingToLLM
+ valid messages are routed to LLM provider: OK, passed 20 tests.
--- PASS: TestProperty_ValidMessageRoutingToLLM (0.00s)
=== RUN   TestProperty_LLMResponseDelivery
+ LLM responses are delivered correctly: OK, passed 20 tests.
--- PASS: TestProperty_LLMResponseDelivery (0.00s)
=== RUN   TestProperty_ResponseTimeTracking
+ response time is tracked for all LLM requests: OK, passed 20 tests.
--- PASS: TestProperty_ResponseTimeTracking (1.86s)
=== RUN   TestProperty_LLMRequestContextInclusion
+ LLM requests include session context and user message: OK, passed 20
   tests.
--- PASS: TestProperty_LLMRequestContextInclusion (0.00s)
=== RUN   TestProperty_StreamingResponseForwarding
+ streaming responses are forwarded in real-time: OK, passed 20 tests.
--- PASS: TestProperty_StreamingResponseForwarding (0.00s)
=== RUN   TestProperty_LLMBackendRetryLogic
+ LLM backend failures trigger retry with exponential backoff: OK, passed
   5 tests.
--- PASS: TestProperty_LLMBackendRetryLogic (11.01s)
=== RUN   TestProperty_ModelSelectionPersistence
+ selected model is used for all subsequent requests: OK, passed 20 tests.
--- PASS: TestProperty_ModelSelectionPersistence (0.00s)
=== RUN   TestProperty_TokenUsageTrackingAndStorage
+ token usage is tracked and accumulated correctly: OK, passed 20 tests.
--- PASS: TestProperty_TokenUsageTrackingAndStorage (0.00s)
=== RUN   TestNewLLMService
    llm_test.go:17: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestNewLLMService (0.00s)
=== RUN   TestLLMService_RegisterProvider
    llm_test.go:133: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_RegisterProvider (0.00s)
=== RUN   TestLLMService_SendMessage
    llm_test.go:203: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_SendMessage (0.00s)
=== RUN   TestLLMService_StreamMessage
    llm_test.go:290: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_StreamMessage (0.00s)
=== RUN   TestLLMService_GetAvailableModels
    llm_test.go:392: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_GetAvailableModels (0.00s)
=== RUN   TestLLMService_ValidateModel
    llm_test.go:434: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_ValidateModel (0.00s)
=== RUN   TestLLMService_GetTokenCount
    llm_test.go:493: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_GetTokenCount (0.00s)
=== RUN   TestLLMService_ProviderError
    llm_test.go:568: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_ProviderError (0.00s)
=== RUN   TestLLMService_ConcurrentAccess
    llm_test.go:606: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_ConcurrentAccess (0.00s)
=== RUN   TestLLMService_RetryLogic
    llm_test.go:657: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_RetryLogic (0.00s)
=== RUN   TestLLMService_StreamRetryLogic
    llm_test.go:782: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_StreamRetryLogic (0.00s)
=== RUN   TestLLMService_ResponseTimeTracking
    llm_test.go:862: Skipping due to goconfig singleton caching issues - functionality covered by property tests
--- SKIP: TestLLMService_ResponseTimeTracking (0.00s)
=== RUN   TestIsRetryableError
=== RUN   TestIsRetryableError/nil_error
=== RUN   TestIsRetryableError/connection_refused
=== RUN   TestIsRetryableError/connection_reset
=== RUN   TestIsRetryableError/timeout
=== RUN   TestIsRetryableError/EOF
=== RUN   TestIsRetryableError/5xx_error
=== RUN   TestIsRetryableError/rate_limit
=== RUN   TestIsRetryableError/unavailable
=== RUN   TestIsRetryableError/overloaded
=== RUN   TestIsRetryableError/4xx_client_error
=== RUN   TestIsRetryableError/unauthorized
=== RUN   TestIsRetryableError/not_found
=== RUN   TestIsRetryableError/generic_error
--- PASS: TestIsRetryableError (0.00s)
    --- PASS: TestIsRetryableError/nil_error (0.00s)
    --- PASS: TestIsRetryableError/connection_refused (0.00s)
    --- PASS: TestIsRetryableError/connection_reset (0.00s)
    --- PASS: TestIsRetryableError/timeout (0.00s)
    --- PASS: TestIsRetryableError/EOF (0.00s)
    --- PASS: TestIsRetryableError/5xx_error (0.00s)
    --- PASS: TestIsRetryableError/rate_limit (0.00s)
    --- PASS: TestIsRetryableError/unavailable (0.00s)
    --- PASS: TestIsRetryableError/overloaded (0.00s)
    --- PASS: TestIsRetryableError/4xx_client_error (0.00s)
    --- PASS: TestIsRetryableError/unauthorized (0.00s)
    --- PASS: TestIsRetryableError/not_found (0.00s)
    --- PASS: TestIsRetryableError/generic_error (0.00s)
=== RUN   TestOpenAIProvider_SendMessage
=== RUN   TestOpenAIProvider_SendMessage/successful_request
=== RUN   TestOpenAIProvider_SendMessage/API_error_response
=== RUN   TestOpenAIProvider_SendMessage/empty_choices
--- PASS: TestOpenAIProvider_SendMessage (0.00s)
    --- PASS: TestOpenAIProvider_SendMessage/successful_request (0.00s)
    --- PASS: TestOpenAIProvider_SendMessage/API_error_response (0.00s)
    --- PASS: TestOpenAIProvider_SendMessage/empty_choices (0.00s)
=== RUN   TestOpenAIProvider_StreamMessage
=== RUN   TestOpenAIProvider_StreamMessage/successful_streaming
=== RUN   TestOpenAIProvider_StreamMessage/API_error_response
--- PASS: TestOpenAIProvider_StreamMessage (0.00s)
    --- PASS: TestOpenAIProvider_StreamMessage/successful_streaming (0.00s)
    --- PASS: TestOpenAIProvider_StreamMessage/API_error_response (0.00s)
=== RUN   TestOpenAIProvider_GetTokenCount
=== RUN   TestOpenAIProvider_GetTokenCount/short_text
=== RUN   TestOpenAIProvider_GetTokenCount/medium_text
=== RUN   TestOpenAIProvider_GetTokenCount/empty_text
--- PASS: TestOpenAIProvider_GetTokenCount (0.00s)
    --- PASS: TestOpenAIProvider_GetTokenCount/short_text (0.00s)
    --- PASS: TestOpenAIProvider_GetTokenCount/medium_text (0.00s)
    --- PASS: TestOpenAIProvider_GetTokenCount/empty_text (0.00s)
=== RUN   TestOpenAIProvider_ContextCancellation
--- PASS: TestOpenAIProvider_ContextCancellation (2.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/llm	22.360s
=== RUN   TestProperty_ErrorLoggingCompleteness
+ errors are logged with complete context: OK, passed 100 tests.
Elapsed time: 5.799625ms
--- PASS: TestProperty_ErrorLoggingCompleteness (0.01s)
=== RUN   TestProperty_StructuredLogFieldInclusion
+ log entries include all structured fields: OK, passed 100 tests.
Elapsed time: 5.272625ms
--- PASS: TestProperty_StructuredLogFieldInclusion (0.01s)
=== RUN   TestProperty_SignificantEventLogging
+ connection events are logged: OK, passed 100 tests.
Elapsed time: 1.432417ms
+ disconnection events are logged: OK, passed 100 tests.
Elapsed time: 2.690584ms
+ message exchange events are logged: OK, passed 100 tests.
Elapsed time: 2.634334ms
+ LLM interaction events are logged: OK, passed 100 tests.
Elapsed time: 2.418875ms
--- PASS: TestProperty_SignificantEventLogging (0.01s)
=== RUN   TestSessionManagerLogging
    logging_property_test.go:407: Session manager logging test completed successfully
--- PASS: TestSessionManagerLogging (0.00s)
=== RUN   TestRouterLogging
    logging_property_test.go:445: Router logging test completed successfully for session 933dd82a6248ba50739d4981cc797571
--- PASS: TestRouterLogging (0.00s)
=== RUN   TestLLMServiceLogging
    logging_property_test.go:484: LLM service logging test completed successfully
--- PASS: TestLLMServiceLogging (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/logging	5.724s
=== RUN   TestProperty_MessageParsingRoundTrip
+ marshaling then unmarshaling preserves message: OK, passed 20 tests.
--- PASS: TestProperty_MessageParsingRoundTrip (0.00s)
=== RUN   TestProperty_MessageRequiredFields
+ all messages have type and sender: OK, passed 20 tests.
--- PASS: TestProperty_MessageRequiredFields (0.00s)
=== RUN   TestProperty_JSONValidity
+ marshaled messages are valid JSON: OK, passed 20 tests.
--- PASS: TestProperty_JSONValidity (0.00s)
=== RUN   TestMessage_MarshalJSON
=== RUN   TestMessage_MarshalJSON/user_message_with_all_fields
=== RUN   TestMessage_MarshalJSON/ai_response_message
=== RUN   TestMessage_MarshalJSON/file_upload_message
=== RUN   TestMessage_MarshalJSON/error_message
=== RUN   TestMessage_MarshalJSON/model_select_message
--- PASS: TestMessage_MarshalJSON (0.00s)
    --- PASS: TestMessage_MarshalJSON/user_message_with_all_fields (0.00s)
    --- PASS: TestMessage_MarshalJSON/ai_response_message (0.00s)
    --- PASS: TestMessage_MarshalJSON/file_upload_message (0.00s)
    --- PASS: TestMessage_MarshalJSON/error_message (0.00s)
    --- PASS: TestMessage_MarshalJSON/model_select_message (0.00s)
=== RUN   TestMessage_UnmarshalJSON
=== RUN   TestMessage_UnmarshalJSON/valid_user_message
=== RUN   TestMessage_UnmarshalJSON/valid_ai_response
=== RUN   TestMessage_UnmarshalJSON/file_upload_with_metadata
=== RUN   TestMessage_UnmarshalJSON/error_message_with_error_info
=== RUN   TestMessage_UnmarshalJSON/invalid_json
=== RUN   TestMessage_UnmarshalJSON/invalid_timestamp_format
--- PASS: TestMessage_UnmarshalJSON (0.00s)
    --- PASS: TestMessage_UnmarshalJSON/valid_user_message (0.00s)
    --- PASS: TestMessage_UnmarshalJSON/valid_ai_response (0.00s)
    --- PASS: TestMessage_UnmarshalJSON/file_upload_with_metadata (0.00s)
    --- PASS: TestMessage_UnmarshalJSON/error_message_with_error_info (0.00s)
    --- PASS: TestMessage_UnmarshalJSON/invalid_json (0.00s)
    --- PASS: TestMessage_UnmarshalJSON/invalid_timestamp_format (0.00s)
=== RUN   TestMessage_RoundTrip
=== RUN   TestMessage_RoundTrip/user_message_round_trip
=== RUN   TestMessage_RoundTrip/admin_message_round_trip
=== RUN   TestMessage_RoundTrip/voice_message_round_trip
--- PASS: TestMessage_RoundTrip (0.00s)
    --- PASS: TestMessage_RoundTrip/user_message_round_trip (0.00s)
    --- PASS: TestMessage_RoundTrip/admin_message_round_trip (0.00s)
    --- PASS: TestMessage_RoundTrip/voice_message_round_trip (0.00s)
=== RUN   TestMessageTypes
=== RUN   TestMessageTypes/user_message
=== RUN   TestMessageTypes/ai_response
=== RUN   TestMessageTypes/file_upload
=== RUN   TestMessageTypes/voice_message
=== RUN   TestMessageTypes/error
=== RUN   TestMessageTypes/connection_status
=== RUN   TestMessageTypes/typing_indicator
=== RUN   TestMessageTypes/help_request
=== RUN   TestMessageTypes/admin_join
=== RUN   TestMessageTypes/admin_leave
=== RUN   TestMessageTypes/model_select
=== RUN   TestMessageTypes/loading
--- PASS: TestMessageTypes (0.00s)
    --- PASS: TestMessageTypes/user_message (0.00s)
    --- PASS: TestMessageTypes/ai_response (0.00s)
    --- PASS: TestMessageTypes/file_upload (0.00s)
    --- PASS: TestMessageTypes/voice_message (0.00s)
    --- PASS: TestMessageTypes/error (0.00s)
    --- PASS: TestMessageTypes/connection_status (0.00s)
    --- PASS: TestMessageTypes/typing_indicator (0.00s)
    --- PASS: TestMessageTypes/help_request (0.00s)
    --- PASS: TestMessageTypes/admin_join (0.00s)
    --- PASS: TestMessageTypes/admin_leave (0.00s)
    --- PASS: TestMessageTypes/model_select (0.00s)
    --- PASS: TestMessageTypes/loading (0.00s)
=== RUN   TestSenderTypes
=== RUN   TestSenderTypes/user_sender
=== RUN   TestSenderTypes/ai_sender
=== RUN   TestSenderTypes/admin_sender
--- PASS: TestSenderTypes (0.00s)
    --- PASS: TestSenderTypes/user_sender (0.00s)
    --- PASS: TestSenderTypes/ai_sender (0.00s)
    --- PASS: TestSenderTypes/admin_sender (0.00s)
=== RUN   TestErrorInfo
=== RUN   TestErrorInfo/recoverable_error
=== RUN   TestErrorInfo/fatal_error
--- PASS: TestErrorInfo (0.00s)
    --- PASS: TestErrorInfo/recoverable_error (0.00s)
    --- PASS: TestErrorInfo/fatal_error (0.00s)
=== RUN   TestProductionIssue07_ValidationCalled
    validation_production_test.go:28: === Production Issue #7: Message Validation Not Enforced ===
    validation_production_test.go:29: 
    validation_production_test.go:30: CURRENT BEHAVIOR:
    validation_production_test.go:31:   - Messages are parsed from JSON in readPump()
    validation_production_test.go:32:   - Messages are routed directly to the router
    validation_production_test.go:33:   - Validate() is NOT called
    validation_production_test.go:34:   - Sanitize() is NOT called
    validation_production_test.go:35: 
    validation_production_test.go:36: SECURITY IMPACT:
    validation_production_test.go:37:   - Invalid messages can be processed
    validation_production_test.go:38:   - XSS attacks possible via unsanitized content
    validation_production_test.go:39:   - SQL injection patterns not escaped
    validation_production_test.go:40:   - Malformed messages can cause errors downstream
    validation_production_test.go:41: 
    validation_production_test.go:42: RECOMMENDATION:
    validation_production_test.go:43:   1. Add msg.Validate() after JSON parsing in readPump()
    validation_production_test.go:44:   2. Add msg.Sanitize() after validation
    validation_production_test.go:45:   3. Send error response if validation fails
    validation_production_test.go:46:   4. Add metrics for validation failures
    validation_production_test.go:47: 
=== RUN   TestProductionIssue07_ValidationCalled/ValidationMethodExists
=== RUN   TestProductionIssue07_ValidationCalled/SanitizationMethodExists
=== RUN   TestProductionIssue07_ValidationCalled/InvalidMessageNotRejected
    validation_production_test.go:89: FINDING: Invalid messages would be caught by Validate(), but it's not called
=== RUN   TestProductionIssue07_ValidationCalled/MaliciousContentNotSanitized
    validation_production_test.go:110: FINDING: Malicious content would be sanitized by Sanitize(), but it's not called
=== RUN   TestProductionIssue07_ValidationCalled/SQLInjectionNotSanitized
    validation_production_test.go:131: FINDING: SQL injection patterns would be escaped by Sanitize(), but it's not called
=== RUN   TestProductionIssue07_ValidationCalled/FutureTimestampNotRejected
    validation_production_test.go:149: FINDING: Future timestamps would be rejected by Validate(), but it's not called
=== RUN   TestProductionIssue07_ValidationCalled/ExcessiveLengthNotRejected
    validation_production_test.go:167: FINDING: Excessive content length would be rejected by Validate(), but it's not called
=== RUN   TestProductionIssue07_ValidationCalled/InvalidSenderTypeNotRejected
    validation_production_test.go:184: FINDING: Invalid sender types would be rejected by Validate(), but it's not called
=== NAME  TestProductionIssue07_ValidationCalled
    validation_production_test.go:188: 
    validation_production_test.go:189: === SUMMARY ===
    validation_production_test.go:190: STATUS: CONFIRMED - Message validation and sanitization are NOT called
    validation_production_test.go:191: SEVERITY: HIGH
    validation_production_test.go:192: AFFECTED CODE: internal/websocket/handler.go readPump() function
    validation_production_test.go:193: 
    validation_production_test.go:194: VULNERABILITIES:
    validation_production_test.go:195:   ✗ XSS attacks possible
    validation_production_test.go:196:   ✗ SQL injection patterns not escaped
    validation_production_test.go:197:   ✗ Invalid messages processed
    validation_production_test.go:198:   ✗ Malformed data can cause errors
    validation_production_test.go:199:   ✗ No length limits enforced
    validation_production_test.go:200:   ✗ No timestamp validation
    validation_production_test.go:201: 
    validation_production_test.go:202: RECOMMENDED FIX:
    validation_production_test.go:203:   In internal/websocket/handler.go readPump(), after line ~540:
    validation_production_test.go:204:   
    validation_production_test.go:205:     // Validate message
    validation_production_test.go:206:     if err := msg.Validate(); err != nil {
    validation_production_test.go:207:         h.logger.Warn("Message validation failed", "error", err)
    validation_production_test.go:208:         metrics.MessageErrors.Inc()
    validation_production_test.go:209:         // Send error response
    validation_production_test.go:210:         continue
    validation_production_test.go:211:     }
    validation_production_test.go:212:   
    validation_production_test.go:213:     // Sanitize message
    validation_production_test.go:214:     msg.Sanitize()
    validation_production_test.go:215: 
--- PASS: TestProductionIssue07_ValidationCalled (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/ValidationMethodExists (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/SanitizationMethodExists (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/InvalidMessageNotRejected (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/MaliciousContentNotSanitized (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/SQLInjectionNotSanitized (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/FutureTimestampNotRejected (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/ExcessiveLengthNotRejected (0.00s)
    --- PASS: TestProductionIssue07_ValidationCalled/InvalidSenderTypeNotRejected (0.00s)
=== RUN   TestProperty_InputSanitization
+ sanitize removes malicious content from all fields: OK, passed 20 tests.
--- PASS: TestProperty_InputSanitization (0.00s)
=== RUN   TestProperty_XSSPrevention
+ sanitize prevents XSS attacks: OK, passed 20 tests.
--- PASS: TestProperty_XSSPrevention (0.00s)
=== RUN   TestProperty_SQLInjectionPrevention
+ sanitize escapes SQL injection patterns: OK, passed 20 tests.
--- PASS: TestProperty_SQLInjectionPrevention (0.00s)
=== RUN   TestProperty_MetadataSanitization
+ sanitize escapes metadata keys and values: OK, passed 20 tests.
--- PASS: TestProperty_MetadataSanitization (0.00s)
=== RUN   TestProperty_ErrorInfoSanitization
+ sanitize escapes error info fields: OK, passed 20 tests.
--- PASS: TestProperty_ErrorInfoSanitization (0.00s)
=== RUN   TestValidate_ValidMessages
=== RUN   TestValidate_ValidMessages/valid_user_message
=== RUN   TestValidate_ValidMessages/valid_ai_response
=== RUN   TestValidate_ValidMessages/valid_file_upload
=== RUN   TestValidate_ValidMessages/valid_voice_message
=== RUN   TestValidate_ValidMessages/valid_error_message
=== RUN   TestValidate_ValidMessages/valid_model_select
=== RUN   TestValidate_ValidMessages/valid_admin_join
=== RUN   TestValidate_ValidMessages/valid_help_request
=== RUN   TestValidate_ValidMessages/valid_connection_status
=== RUN   TestValidate_ValidMessages/valid_typing_indicator
=== RUN   TestValidate_ValidMessages/valid_loading_message
--- PASS: TestValidate_ValidMessages (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_user_message (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_ai_response (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_file_upload (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_voice_message (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_error_message (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_model_select (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_admin_join (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_help_request (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_connection_status (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_typing_indicator (0.00s)
    --- PASS: TestValidate_ValidMessages/valid_loading_message (0.00s)
=== RUN   TestValidate_MissingRequiredFields
=== RUN   TestValidate_MissingRequiredFields/missing_type
=== RUN   TestValidate_MissingRequiredFields/missing_sender
=== RUN   TestValidate_MissingRequiredFields/missing_timestamp
=== RUN   TestValidate_MissingRequiredFields/invalid_message_type
=== RUN   TestValidate_MissingRequiredFields/invalid_sender_type
=== RUN   TestValidate_MissingRequiredFields/future_timestamp
--- PASS: TestValidate_MissingRequiredFields (0.00s)
    --- PASS: TestValidate_MissingRequiredFields/missing_type (0.00s)
    --- PASS: TestValidate_MissingRequiredFields/missing_sender (0.00s)
    --- PASS: TestValidate_MissingRequiredFields/missing_timestamp (0.00s)
    --- PASS: TestValidate_MissingRequiredFields/invalid_message_type (0.00s)
    --- PASS: TestValidate_MissingRequiredFields/invalid_sender_type (0.00s)
    --- PASS: TestValidate_MissingRequiredFields/future_timestamp (0.00s)
=== RUN   TestValidate_TypeSpecificFields
=== RUN   TestValidate_TypeSpecificFields/user_message_missing_content
=== RUN   TestValidate_TypeSpecificFields/ai_response_missing_content
=== RUN   TestValidate_TypeSpecificFields/file_upload_missing_file_id
=== RUN   TestValidate_TypeSpecificFields/file_upload_missing_file_url
=== RUN   TestValidate_TypeSpecificFields/voice_message_missing_file_id
=== RUN   TestValidate_TypeSpecificFields/voice_message_missing_file_url
=== RUN   TestValidate_TypeSpecificFields/error_message_missing_error_info
=== RUN   TestValidate_TypeSpecificFields/error_message_missing_error_code
=== RUN   TestValidate_TypeSpecificFields/error_message_missing_error_message
=== RUN   TestValidate_TypeSpecificFields/model_select_missing_model_id
=== RUN   TestValidate_TypeSpecificFields/admin_join_with_non-admin_sender
=== RUN   TestValidate_TypeSpecificFields/admin_leave_with_non-admin_sender
=== RUN   TestValidate_TypeSpecificFields/help_request_with_non-user_sender
--- PASS: TestValidate_TypeSpecificFields (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/user_message_missing_content (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/ai_response_missing_content (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/file_upload_missing_file_id (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/file_upload_missing_file_url (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/voice_message_missing_file_id (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/voice_message_missing_file_url (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/error_message_missing_error_info (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/error_message_missing_error_code (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/error_message_missing_error_message (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/model_select_missing_model_id (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/admin_join_with_non-admin_sender (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/admin_leave_with_non-admin_sender (0.00s)
    --- PASS: TestValidate_TypeSpecificFields/help_request_with_non-user_sender (0.00s)
=== RUN   TestValidate_FieldLengths
=== RUN   TestValidate_FieldLengths/content_exceeds_max_length
=== RUN   TestValidate_FieldLengths/file_id_exceeds_max_length
=== RUN   TestValidate_FieldLengths/model_id_exceeds_max_length
=== RUN   TestValidate_FieldLengths/metadata_value_exceeds_max_length
--- PASS: TestValidate_FieldLengths (0.00s)
    --- PASS: TestValidate_FieldLengths/content_exceeds_max_length (0.00s)
    --- PASS: TestValidate_FieldLengths/file_id_exceeds_max_length (0.00s)
    --- PASS: TestValidate_FieldLengths/model_id_exceeds_max_length (0.00s)
    --- PASS: TestValidate_FieldLengths/metadata_value_exceeds_max_length (0.00s)
=== RUN   TestValidate_EdgeCases
=== RUN   TestValidate_EdgeCases/empty_content_is_valid_for_non-content_messages
=== RUN   TestValidate_EdgeCases/content_at_max_length_is_valid
=== RUN   TestValidate_EdgeCases/empty_metadata_is_valid
=== RUN   TestValidate_EdgeCases/nil_metadata_is_valid
=== RUN   TestValidate_EdgeCases/timestamp_with_clock_skew_tolerance
--- PASS: TestValidate_EdgeCases (0.00s)
    --- PASS: TestValidate_EdgeCases/empty_content_is_valid_for_non-content_messages (0.00s)
    --- PASS: TestValidate_EdgeCases/content_at_max_length_is_valid (0.00s)
    --- PASS: TestValidate_EdgeCases/empty_metadata_is_valid (0.00s)
    --- PASS: TestValidate_EdgeCases/nil_metadata_is_valid (0.00s)
    --- PASS: TestValidate_EdgeCases/timestamp_with_clock_skew_tolerance (0.00s)
=== RUN   TestSanitize_XSSPrevention
=== RUN   TestSanitize_XSSPrevention/script_tag
=== RUN   TestSanitize_XSSPrevention/img_tag_with_onerror
=== RUN   TestSanitize_XSSPrevention/javascript_protocol
=== RUN   TestSanitize_XSSPrevention/html_entities
--- PASS: TestSanitize_XSSPrevention (0.00s)
    --- PASS: TestSanitize_XSSPrevention/script_tag (0.00s)
    --- PASS: TestSanitize_XSSPrevention/img_tag_with_onerror (0.00s)
    --- PASS: TestSanitize_XSSPrevention/javascript_protocol (0.00s)
    --- PASS: TestSanitize_XSSPrevention/html_entities (0.00s)
=== RUN   TestSanitize_SQLInjectionPrevention
=== RUN   TestSanitize_SQLInjectionPrevention/sql_injection_attempt
=== RUN   TestSanitize_SQLInjectionPrevention/union_select
=== RUN   TestSanitize_SQLInjectionPrevention/comment_injection
--- PASS: TestSanitize_SQLInjectionPrevention (0.00s)
    --- PASS: TestSanitize_SQLInjectionPrevention/sql_injection_attempt (0.00s)
    --- PASS: TestSanitize_SQLInjectionPrevention/union_select (0.00s)
    --- PASS: TestSanitize_SQLInjectionPrevention/comment_injection (0.00s)
=== RUN   TestSanitize_SpecialCharacters
=== RUN   TestSanitize_SpecialCharacters/null_bytes
=== RUN   TestSanitize_SpecialCharacters/leading_and_trailing_whitespace
=== RUN   TestSanitize_SpecialCharacters/newlines_and_tabs
=== RUN   TestSanitize_SpecialCharacters/unicode_characters
--- PASS: TestSanitize_SpecialCharacters (0.00s)
    --- PASS: TestSanitize_SpecialCharacters/null_bytes (0.00s)
    --- PASS: TestSanitize_SpecialCharacters/leading_and_trailing_whitespace (0.00s)
    --- PASS: TestSanitize_SpecialCharacters/newlines_and_tabs (0.00s)
    --- PASS: TestSanitize_SpecialCharacters/unicode_characters (0.00s)
=== RUN   TestSanitize_AllFields
--- PASS: TestSanitize_AllFields (0.00s)
=== RUN   TestSanitize_EmptyStrings
--- PASS: TestSanitize_EmptyStrings (0.00s)
=== RUN   TestSanitize_VeryLongStrings
--- PASS: TestSanitize_VeryLongStrings (0.00s)
=== RUN   TestValidationError_Error
--- PASS: TestValidationError_Error (0.00s)
=== RUN   TestIsValidMessageType
=== RUN   TestIsValidMessageType/user_message
=== RUN   TestIsValidMessageType/ai_response
=== RUN   TestIsValidMessageType/file_upload
=== RUN   TestIsValidMessageType/voice_message
=== RUN   TestIsValidMessageType/error
=== RUN   TestIsValidMessageType/connection_status
=== RUN   TestIsValidMessageType/typing_indicator
=== RUN   TestIsValidMessageType/help_request
=== RUN   TestIsValidMessageType/admin_join
=== RUN   TestIsValidMessageType/admin_leave
=== RUN   TestIsValidMessageType/model_select
=== RUN   TestIsValidMessageType/loading
=== RUN   TestIsValidMessageType/invalid
=== RUN   TestIsValidMessageType/unknown
=== RUN   TestIsValidMessageType/#00
--- PASS: TestIsValidMessageType (0.00s)
    --- PASS: TestIsValidMessageType/user_message (0.00s)
    --- PASS: TestIsValidMessageType/ai_response (0.00s)
    --- PASS: TestIsValidMessageType/file_upload (0.00s)
    --- PASS: TestIsValidMessageType/voice_message (0.00s)
    --- PASS: TestIsValidMessageType/error (0.00s)
    --- PASS: TestIsValidMessageType/connection_status (0.00s)
    --- PASS: TestIsValidMessageType/typing_indicator (0.00s)
    --- PASS: TestIsValidMessageType/help_request (0.00s)
    --- PASS: TestIsValidMessageType/admin_join (0.00s)
    --- PASS: TestIsValidMessageType/admin_leave (0.00s)
    --- PASS: TestIsValidMessageType/model_select (0.00s)
    --- PASS: TestIsValidMessageType/loading (0.00s)
    --- PASS: TestIsValidMessageType/invalid (0.00s)
    --- PASS: TestIsValidMessageType/unknown (0.00s)
    --- PASS: TestIsValidMessageType/#00 (0.00s)
=== RUN   TestIsValidSenderType
=== RUN   TestIsValidSenderType/user
=== RUN   TestIsValidSenderType/ai
=== RUN   TestIsValidSenderType/admin
=== RUN   TestIsValidSenderType/invalid
=== RUN   TestIsValidSenderType/system
=== RUN   TestIsValidSenderType/#00
--- PASS: TestIsValidSenderType (0.00s)
    --- PASS: TestIsValidSenderType/user (0.00s)
    --- PASS: TestIsValidSenderType/ai (0.00s)
    --- PASS: TestIsValidSenderType/admin (0.00s)
    --- PASS: TestIsValidSenderType/invalid (0.00s)
    --- PASS: TestIsValidSenderType/system (0.00s)
    --- PASS: TestIsValidSenderType/#00 (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/message	3.692s
=== RUN   TestMetricsRegistration
=== RUN   TestMetricsRegistration/WebSocketConnections
=== RUN   TestMetricsRegistration/MessagesReceived
=== RUN   TestMetricsRegistration/MessagesSent
=== RUN   TestMetricsRegistration/LLMRequests
=== RUN   TestMetricsRegistration/LLMLatency
=== RUN   TestMetricsRegistration/LLMErrors
=== RUN   TestMetricsRegistration/ActiveSessions
=== RUN   TestMetricsRegistration/SessionsCreated
=== RUN   TestMetricsRegistration/SessionsEnded
=== RUN   TestMetricsRegistration/AdminTakeovers
=== RUN   TestMetricsRegistration/MessageErrors
=== RUN   TestMetricsRegistration/TokensUsed
--- PASS: TestMetricsRegistration (0.00s)
    --- PASS: TestMetricsRegistration/WebSocketConnections (0.00s)
    --- PASS: TestMetricsRegistration/MessagesReceived (0.00s)
    --- PASS: TestMetricsRegistration/MessagesSent (0.00s)
    --- PASS: TestMetricsRegistration/LLMRequests (0.00s)
    --- PASS: TestMetricsRegistration/LLMLatency (0.00s)
    --- PASS: TestMetricsRegistration/LLMErrors (0.00s)
    --- PASS: TestMetricsRegistration/ActiveSessions (0.00s)
    --- PASS: TestMetricsRegistration/SessionsCreated (0.00s)
    --- PASS: TestMetricsRegistration/SessionsEnded (0.00s)
    --- PASS: TestMetricsRegistration/AdminTakeovers (0.00s)
    --- PASS: TestMetricsRegistration/MessageErrors (0.00s)
    --- PASS: TestMetricsRegistration/TokensUsed (0.00s)
=== RUN   TestWebSocketConnectionsMetric
--- PASS: TestWebSocketConnectionsMetric (0.00s)
=== RUN   TestMessagesReceivedMetric
--- PASS: TestMessagesReceivedMetric (0.00s)
=== RUN   TestLLMMetricsWithLabels
=== RUN   TestLLMMetricsWithLabels/openai
=== RUN   TestLLMMetricsWithLabels/anthropic
=== RUN   TestLLMMetricsWithLabels/dify
--- PASS: TestLLMMetricsWithLabels (0.00s)
    --- PASS: TestLLMMetricsWithLabels/openai (0.00s)
    --- PASS: TestLLMMetricsWithLabels/anthropic (0.00s)
    --- PASS: TestLLMMetricsWithLabels/dify (0.00s)
=== RUN   TestSessionMetrics
--- PASS: TestSessionMetrics (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/metrics	4.584s
=== RUN   TestProperty_HelpRequestNotification
+ help request notification completes without error: OK, passed 100 tests.
Elapsed time: 2.84325ms
--- PASS: TestProperty_HelpRequestNotification (0.00s)
=== RUN   TestProperty_CriticalErrorNotification
+ critical error notification completes without error: OK, passed 100
   tests.
Elapsed time: 3.432833ms
--- PASS: TestProperty_CriticalErrorNotification (0.00s)
=== RUN   TestProperty_NotificationTypeSupport
+ all notification types are supported: OK, passed 100 tests.
Elapsed time: 1.732333ms
--- PASS: TestProperty_NotificationTypeSupport (0.00s)
=== RUN   TestProperty_NotificationRateLimiting
+ rate limiting prevents notification flooding: OK, passed 100 tests.
Elapsed time: 1.220625ms
--- PASS: TestProperty_NotificationRateLimiting (0.00s)
=== RUN   TestProperty_NotificationContentCompleteness
+ notification includes all required information: OK, passed 100 tests.
Elapsed time: 2.822708ms
--- PASS: TestProperty_NotificationContentCompleteness (0.00s)
=== RUN   TestNewNotificationService
--- PASS: TestNewNotificationService (0.00s)
=== RUN   TestRateLimiter_Allow
--- PASS: TestRateLimiter_Allow (1.10s)
=== RUN   TestRateLimiter_DifferentKeys
--- PASS: TestRateLimiter_DifferentKeys (0.00s)
=== RUN   TestSendHelpRequestAlert
--- PASS: TestSendHelpRequestAlert (0.89s)
=== RUN   TestSendCriticalError
--- PASS: TestSendCriticalError (0.28s)
=== RUN   TestSendSystemAlert
    notification_test.go:109: SendSystemAlert returned error (expected in test env): failed to send email: AWS SES error: InvalidClientTokenId: The security token included in the request is invalid.
        	status code: 403, request id: 358a7b18-8d94-4600-9d60-3b42af0ed279
--- PASS: TestSendSystemAlert (0.28s)
=== RUN   TestGetAdminEmails
    notification_test.go:120: Admin emails: [admin@example.com]
--- PASS: TestGetAdminEmails (0.00s)
=== RUN   TestGetAdminPhones
    notification_test.go:129: Admin phones: []
--- PASS: TestGetAdminPhones (0.00s)
=== RUN   TestSplitAndTrim
=== RUN   TestSplitAndTrim/empty_string
=== RUN   TestSplitAndTrim/single_value
=== RUN   TestSplitAndTrim/multiple_values
=== RUN   TestSplitAndTrim/values_with_spaces
=== RUN   TestSplitAndTrim/trailing_comma
--- PASS: TestSplitAndTrim (0.00s)
    --- PASS: TestSplitAndTrim/empty_string (0.00s)
    --- PASS: TestSplitAndTrim/single_value (0.00s)
    --- PASS: TestSplitAndTrim/multiple_values (0.00s)
    --- PASS: TestSplitAndTrim/values_with_spaces (0.00s)
    --- PASS: TestSplitAndTrim/trailing_comma (0.00s)
=== RUN   TestValidateEmails
    notification_test.go:185: Valid emails: [valid@example.com another@example.com]
--- PASS: TestValidateEmails (0.09s)
=== RUN   TestRateLimiting_HelpRequest
--- PASS: TestRateLimiting_HelpRequest (1.93s)
=== RUN   TestRateLimiting_CriticalError
--- PASS: TestRateLimiting_CriticalError (1.23s)
PASS
ok  	github.com/real-rm/chatbox/internal/notification	10.894s
=== RUN   TestProperty_AdminRateLimitEnforcement
--- PASS: TestProperty_AdminRateLimitEnforcement (0.00s)
=== RUN   TestProperty_AdminRateLimitRetryAfter
--- PASS: TestProperty_AdminRateLimitRetryAfter (0.00s)
=== RUN   TestProperty_IndependentRateLimits
--- PASS: TestProperty_IndependentRateLimits (0.00s)
=== RUN   TestProductionIssue11_CleanupMethod
    ratelimit_production_test.go:55: STATUS: Cleanup() method works correctly
    ratelimit_production_test.go:56: FINDING: Expired events are properly removed
    ratelimit_production_test.go:57: RECOMMENDATION: Call Cleanup() periodically to prevent memory growth
--- PASS: TestProductionIssue11_CleanupMethod (0.15s)
=== RUN   TestProductionIssue11_MemoryGrowth
    ratelimit_production_test.go:106: Total users tracked: 100
    ratelimit_production_test.go:107: Total events stored: 10000
    ratelimit_production_test.go:116: Estimated memory usage: ~244800 bytes (239.06 KB)
    ratelimit_production_test.go:119: 
    ratelimit_production_test.go:120: === UNBOUNDED GROWTH DOCUMENTATION ===
    ratelimit_production_test.go:121: FINDING: Events accumulate in memory without automatic cleanup
    ratelimit_production_test.go:122: IMPACT: Memory grows unbounded with user activity
    ratelimit_production_test.go:123: DETAILS:
    ratelimit_production_test.go:124:   - 10000 events stored indefinitely
    ratelimit_production_test.go:125:   - 100 users tracked in memory
    ratelimit_production_test.go:126:   - Estimated minimum memory: 239.06 KB
    ratelimit_production_test.go:127:   - No automatic cleanup mechanism
    ratelimit_production_test.go:128:   - Events remain until Cleanup() is manually called
    ratelimit_production_test.go:129: RECOMMENDATION: Implement periodic cleanup goroutine or automatic expiration
    ratelimit_production_test.go:130: WORKAROUND: Call Cleanup() periodically in production
--- PASS: TestProductionIssue11_MemoryGrowth (0.02s)
=== RUN   TestProductionIssue11_CleanupEffectiveness
    ratelimit_production_test.go:172: STATUS: Cleanup correctly removes only expired events
    ratelimit_production_test.go:173: FINDING: Active events are preserved during cleanup
--- PASS: TestProductionIssue11_CleanupEffectiveness (0.25s)
=== RUN   TestProperty_RateLimitingEnforcement
+ message limiter enforces rate limits: OK, passed 100 tests.
+ connection limiter enforces connection limits: OK, passed 100 tests.
+ rate limiter isolates users: OK, passed 100 tests.
+ rate limiter resets after window expires: OK, passed 100 tests.
+ connection limiter releases connections correctly: OK, passed 100 tests.
+ retry after value is reasonable: OK, passed 100 tests.
+ cleanup removes expired events: OK, passed 100 tests.
--- PASS: TestProperty_RateLimitingEnforcement (19.06s)
=== RUN   TestProperty_RateLimitingConcurrency
+ message limiter handles concurrent access safely: OK, passed 50 tests.
+ connection limiter handles concurrent access safely: OK, passed 50 tests.
--- PASS: TestProperty_RateLimitingConcurrency (0.01s)
=== RUN   TestProperty_CleanupRemovesOldEvents
+ cleanup removes all events older than window: OK, passed 100 tests.
--- PASS: TestProperty_CleanupRemovesOldEvents (15.16s)
=== RUN   TestProperty_CleanupRunsPeriodically
+ cleanup runs at configured interval: OK, passed 10 tests.
--- PASS: TestProperty_CleanupRunsPeriodically (2.17s)
=== RUN   TestProperty_CleanupGoroutineTerminates
+ cleanup goroutine terminates on stop: OK, passed 100 tests.
--- PASS: TestProperty_CleanupGoroutineTerminates (5.45s)
=== RUN   TestConnectionLimiter_Allow
--- PASS: TestConnectionLimiter_Allow (0.00s)
=== RUN   TestConnectionLimiter_Release
--- PASS: TestConnectionLimiter_Release (0.00s)
=== RUN   TestConnectionLimiter_GetCount
--- PASS: TestConnectionLimiter_GetCount (0.00s)
=== RUN   TestMessageLimiter_Allow
--- PASS: TestMessageLimiter_Allow (0.00s)
=== RUN   TestMessageLimiter_WindowExpiry
--- PASS: TestMessageLimiter_WindowExpiry (0.15s)
=== RUN   TestMessageLimiter_GetRetryAfter
--- PASS: TestMessageLimiter_GetRetryAfter (0.00s)
=== RUN   TestMessageLimiter_Reset
--- PASS: TestMessageLimiter_Reset (0.00s)
=== RUN   TestMessageLimiter_Cleanup
--- PASS: TestMessageLimiter_Cleanup (0.15s)
=== RUN   TestMessageLimiter_ConcurrentAccess
--- PASS: TestMessageLimiter_ConcurrentAccess (0.00s)
=== RUN   TestConnectionLimiter_ConcurrentAccess
--- PASS: TestConnectionLimiter_ConcurrentAccess (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/ratelimit	46.702s
=== RUN   TestAdminNameDisplay
--- PASS: TestAdminNameDisplay (0.10s)
=== RUN   TestAdminNameFallback
--- PASS: TestAdminNameFallback (0.00s)
=== RUN   TestAdminJoinMessageFormat
--- PASS: TestAdminJoinMessageFormat (0.00s)
=== RUN   TestAdminLeaveMessageIncludesName
--- PASS: TestAdminLeaveMessageIncludesName (0.00s)
=== RUN   TestMultipleAdminTakeoversPreserveName
--- PASS: TestMultipleAdminTakeoversPreserveName (0.00s)
=== RUN   TestAdminJoinMessageMetadata
--- PASS: TestAdminJoinMessageMetadata (0.00s)
=== RUN   TestProperty_BidirectionalMessageRoutingDuringTakeover
+ admin and user connections can be registered for a session: OK, passed
   100 tests.
Elapsed time: 5.35775ms
--- PASS: TestProperty_BidirectionalMessageRoutingDuringTakeover (0.01s)
=== RUN   TestProperty_SessionTakeoverEventLogging
+ admin takeover and leave operations complete successfully: OK, passed
   100 tests.
Elapsed time: 4.276083ms
--- PASS: TestProperty_SessionTakeoverEventLogging (0.00s)
=== RUN   TestCriticalFix_C1_SessionOwnershipEnforced
    critical_fixes_test.go:74: ✓ Session ownership is properly enforced - IDOR vulnerability fixed
--- PASS: TestCriticalFix_C1_SessionOwnershipEnforced (0.00s)
=== RUN   TestCriticalFix_C2_MessageSanitizationCalled
    critical_fixes_test.go:102: ✓ Message sanitization is working correctly - XSS vulnerability fixed
--- PASS: TestCriticalFix_C2_MessageSanitizationCalled (0.00s)
=== RUN   TestCriticalFix_C3_DoubleCloseProtection
    critical_fixes_test.go:132: ✓ Double-close protection is working - panic vulnerability fixed
--- PASS: TestCriticalFix_C3_DoubleCloseProtection (0.00s)
=== RUN   TestCriticalFix_C4_ErrorComparisonWithErrorsIs
    critical_fixes_test.go:144: ✓ Error comparison uses errors.Is - wrapped error handling fixed
--- PASS: TestCriticalFix_C4_ErrorComparisonWithErrorsIs (0.00s)
=== RUN   TestCriticalFix_M3_RetryAfterHeaderNotTruncated
=== RUN   TestCriticalFix_M3_RetryAfterHeaderNotTruncated/Small_value_rounds_up
=== RUN   TestCriticalFix_M3_RetryAfterHeaderNotTruncated/Exactly_1_second
=== RUN   TestCriticalFix_M3_RetryAfterHeaderNotTruncated/1.5_seconds_rounds_up
=== RUN   TestCriticalFix_M3_RetryAfterHeaderNotTruncated/2_seconds
=== RUN   TestCriticalFix_M3_RetryAfterHeaderNotTruncated/Zero_milliseconds
=== NAME  TestCriticalFix_M3_RetryAfterHeaderNotTruncated
    critical_fixes_test.go:176: ✓ Retry-After header calculation is correct - truncation bug fixed
--- PASS: TestCriticalFix_M3_RetryAfterHeaderNotTruncated (0.00s)
    --- PASS: TestCriticalFix_M3_RetryAfterHeaderNotTruncated/Small_value_rounds_up (0.00s)
    --- PASS: TestCriticalFix_M3_RetryAfterHeaderNotTruncated/Exactly_1_second (0.00s)
    --- PASS: TestCriticalFix_M3_RetryAfterHeaderNotTruncated/1.5_seconds_rounds_up (0.00s)
    --- PASS: TestCriticalFix_M3_RetryAfterHeaderNotTruncated/2_seconds (0.00s)
    --- PASS: TestCriticalFix_M3_RetryAfterHeaderNotTruncated/Zero_milliseconds (0.00s)
=== RUN   TestCriticalFix_M5_CorrectErrorCodes
    critical_fixes_test.go:237: ✓ Correct error codes are used - error code bug fixed
--- PASS: TestCriticalFix_M5_CorrectErrorCodes (0.00s)
=== RUN   TestEdgeCase_EmptyMessageContent
=== RUN   TestEdgeCase_EmptyMessageContent/empty_user_message_content
=== RUN   TestEdgeCase_EmptyMessageContent/whitespace_only_content
=== RUN   TestEdgeCase_EmptyMessageContent/empty_help_request
--- PASS: TestEdgeCase_EmptyMessageContent (0.00s)
    --- PASS: TestEdgeCase_EmptyMessageContent/empty_user_message_content (0.00s)
    --- PASS: TestEdgeCase_EmptyMessageContent/whitespace_only_content (0.00s)
    --- PASS: TestEdgeCase_EmptyMessageContent/empty_help_request (0.00s)
=== RUN   TestEdgeCase_VeryLongMessages
=== RUN   TestEdgeCase_VeryLongMessages/1KB_message
=== RUN   TestEdgeCase_VeryLongMessages/10KB_message
=== RUN   TestEdgeCase_VeryLongMessages/100KB_message
=== RUN   TestEdgeCase_VeryLongMessages/1MB_message
--- PASS: TestEdgeCase_VeryLongMessages (0.00s)
    --- PASS: TestEdgeCase_VeryLongMessages/1KB_message (0.00s)
    --- PASS: TestEdgeCase_VeryLongMessages/10KB_message (0.00s)
    --- PASS: TestEdgeCase_VeryLongMessages/100KB_message (0.00s)
    --- PASS: TestEdgeCase_VeryLongMessages/1MB_message (0.00s)
=== RUN   TestEdgeCase_ConcurrentMessageRouting
--- PASS: TestEdgeCase_ConcurrentMessageRouting (0.00s)
=== RUN   TestEdgeCase_ConcurrentMessageRoutingSameSession
    edge_case_test.go:286: Total errors (may include rate limit errors): 0
--- PASS: TestEdgeCase_ConcurrentMessageRoutingSameSession (0.00s)
=== RUN   TestEdgeCase_AdminTakeoverNilConnection
--- PASS: TestEdgeCase_AdminTakeoverNilConnection (0.00s)
=== RUN   TestEdgeCase_AdminTakeoverEmptySessionID
--- PASS: TestEdgeCase_AdminTakeoverEmptySessionID (0.00s)
=== RUN   TestEdgeCase_AdminTakeoverNonExistentSession
--- PASS: TestEdgeCase_AdminTakeoverNonExistentSession (0.00s)
=== RUN   TestEdgeCase_AdminTakeoverAlreadyAssisted
--- PASS: TestEdgeCase_AdminTakeoverAlreadyAssisted (0.00s)
=== RUN   TestEdgeCase_AdminTakeoverSameAdminTwice
--- PASS: TestEdgeCase_AdminTakeoverSameAdminTwice (0.00s)
=== RUN   TestEdgeCase_AdminLeaveNotAssisting
--- PASS: TestEdgeCase_AdminLeaveNotAssisting (0.00s)
=== RUN   TestEdgeCase_AdminLeaveEmptyParameters
=== RUN   TestEdgeCase_AdminLeaveEmptyParameters/empty_admin_ID
=== RUN   TestEdgeCase_AdminLeaveEmptyParameters/empty_session_ID
--- PASS: TestEdgeCase_AdminLeaveEmptyParameters (0.00s)
    --- PASS: TestEdgeCase_AdminLeaveEmptyParameters/empty_admin_ID (0.00s)
    --- PASS: TestEdgeCase_AdminLeaveEmptyParameters/empty_session_ID (0.00s)
=== RUN   TestEdgeCase_AdminTakeoverAndLeaveFlow
--- PASS: TestEdgeCase_AdminTakeoverAndLeaveFlow (0.00s)
=== RUN   TestEdgeCase_BroadcastToSessionWithAdmin
--- PASS: TestEdgeCase_BroadcastToSessionWithAdmin (0.00s)
=== RUN   TestErrorHandling_NilConnection
--- PASS: TestErrorHandling_NilConnection (0.00s)
=== RUN   TestErrorHandling_NilMessage
--- PASS: TestErrorHandling_NilMessage (0.00s)
=== RUN   TestErrorHandling_InvalidSessionID
=== RUN   TestErrorHandling_InvalidSessionID/empty_session_ID
=== RUN   TestErrorHandling_InvalidSessionID/non-existent_session_ID_for_model_selection
--- PASS: TestErrorHandling_InvalidSessionID (0.00s)
    --- PASS: TestErrorHandling_InvalidSessionID/empty_session_ID (0.00s)
    --- PASS: TestErrorHandling_InvalidSessionID/non-existent_session_ID_for_model_selection (0.00s)
=== RUN   TestErrorHandling_RateLimitExceeded
--- PASS: TestErrorHandling_RateLimitExceeded (0.00s)
=== RUN   TestErrorHandling_RateLimitOnlyAppliesToUserMessages
--- PASS: TestErrorHandling_RateLimitOnlyAppliesToUserMessages (0.00s)
=== RUN   TestSendFileUploadError
=== RUN   TestSendFileUploadError/empty_session_ID
=== RUN   TestSendFileUploadError/valid_error_with_connection
=== RUN   TestSendFileUploadError/valid_error_without_connection
--- PASS: TestSendFileUploadError (0.00s)
    --- PASS: TestSendFileUploadError/empty_session_ID (0.00s)
    --- PASS: TestSendFileUploadError/valid_error_with_connection (0.00s)
    --- PASS: TestSendFileUploadError/valid_error_without_connection (0.00s)
=== RUN   TestHandleAIGeneratedFile
=== RUN   TestHandleAIGeneratedFile/empty_file_URL
=== RUN   TestHandleAIGeneratedFile/session_not_found
=== RUN   TestHandleAIGeneratedFile/valid_AI_generated_file
=== RUN   TestHandleAIGeneratedFile/valid_file_without_connection
--- PASS: TestHandleAIGeneratedFile (0.00s)
    --- PASS: TestHandleAIGeneratedFile/empty_file_URL (0.00s)
    --- PASS: TestHandleAIGeneratedFile/session_not_found (0.00s)
    --- PASS: TestHandleAIGeneratedFile/valid_AI_generated_file (0.00s)
    --- PASS: TestHandleAIGeneratedFile/valid_file_without_connection (0.00s)
=== RUN   TestUnregisterAdminConnection
--- PASS: TestUnregisterAdminConnection (0.00s)
=== RUN   TestSendErrorMessage
=== RUN   TestSendErrorMessage/send_recoverable_error
=== RUN   TestSendErrorMessage/send_non-recoverable_error
=== RUN   TestSendErrorMessage/send_error_without_connection
--- PASS: TestSendErrorMessage (0.00s)
    --- PASS: TestSendErrorMessage/send_recoverable_error (0.00s)
    --- PASS: TestSendErrorMessage/send_non-recoverable_error (0.00s)
    --- PASS: TestSendErrorMessage/send_error_without_connection (0.00s)
=== RUN   TestShutdown
--- PASS: TestShutdown (0.00s)
=== RUN   TestHandleChatError
=== RUN   TestHandleChatError/with_connection_and_session
=== RUN   TestHandleChatError/without_connection
=== RUN   TestHandleChatError/without_session
--- PASS: TestHandleChatError (0.00s)
    --- PASS: TestHandleChatError/with_connection_and_session (0.00s)
    --- PASS: TestHandleChatError/without_connection (0.00s)
    --- PASS: TestHandleChatError/without_session (0.00s)
=== RUN   TestHandleError
=== RUN   TestHandleError/chat_error_with_connection
=== RUN   TestHandleError/generic_error_with_connection
=== RUN   TestHandleError/error_without_connection
--- PASS: TestHandleError (0.00s)
    --- PASS: TestHandleError/chat_error_with_connection (0.00s)
    --- PASS: TestHandleError/generic_error_with_connection (0.00s)
    --- PASS: TestHandleError/error_without_connection (0.00s)
=== RUN   TestRegisterAdminConnection
=== RUN   TestRegisterAdminConnection/valid_admin_connection
=== RUN   TestRegisterAdminConnection/empty_admin_ID
=== RUN   TestRegisterAdminConnection/nil_connection
--- PASS: TestRegisterAdminConnection (0.00s)
    --- PASS: TestRegisterAdminConnection/valid_admin_connection (0.00s)
    --- PASS: TestRegisterAdminConnection/empty_admin_ID (0.00s)
    --- PASS: TestRegisterAdminConnection/nil_connection (0.00s)
=== RUN   TestHandleAIGeneratedFileEmptySessionID
--- PASS: TestHandleAIGeneratedFileEmptySessionID (0.00s)
=== RUN   TestHandleHelpRequest
--- PASS: TestHandleHelpRequest (0.00s)
=== RUN   TestHandleHelpRequestEdgeCases
=== RUN   TestHandleHelpRequestEdgeCases/nil_connection
=== RUN   TestHandleHelpRequestEdgeCases/nil_message
=== RUN   TestHandleHelpRequestEdgeCases/empty_session_ID
=== RUN   TestHandleHelpRequestEdgeCases/session_not_found
--- PASS: TestHandleHelpRequestEdgeCases (0.00s)
    --- PASS: TestHandleHelpRequestEdgeCases/nil_connection (0.00s)
    --- PASS: TestHandleHelpRequestEdgeCases/nil_message (0.00s)
    --- PASS: TestHandleHelpRequestEdgeCases/empty_session_ID (0.00s)
    --- PASS: TestHandleHelpRequestEdgeCases/session_not_found (0.00s)
=== RUN   TestIntegration_CompleteMessageFlow
--- PASS: TestIntegration_CompleteMessageFlow (0.00s)
=== RUN   TestIntegration_AdminTakeoverFlow
--- PASS: TestIntegration_AdminTakeoverFlow (0.00s)
=== RUN   TestIntegration_FileUploadFlow
--- PASS: TestIntegration_FileUploadFlow (0.00s)
=== RUN   TestIntegration_VoiceMessageFlow
--- PASS: TestIntegration_VoiceMessageFlow (0.00s)
=== RUN   TestIntegration_MultipleFlowsCombined
--- PASS: TestIntegration_MultipleFlowsCombined (0.00s)
=== RUN   TestProductionIssue02_SessionIDConsistency
    router_production_test.go:102: Testing getOrCreateSession flow with non-existent session...
    router_production_test.go:107: ✓ getOrCreateSession successfully created new session
    router_production_test.go:110: Verifying SessionManager generated a unique ID...
    router_production_test.go:115: ✓ SessionManager generated ID: 865dc1f4b4a097447197dc5e7afa7b11
    router_production_test.go:118: Verifying ID consistency across SessionManager and Storage...
    router_production_test.go:132: ✓ Session ID is consistent between SessionManager and Storage
    router_production_test.go:135: Testing connection registration with generated session ID...
    router_production_test.go:146: ✓ Connection successfully registered with session ID: 865dc1f4b4a097447197dc5e7afa7b11
    router_production_test.go:155: 
    router_production_test.go:156: FINDING: Session ID consistency is maintained throughout the flow
    router_production_test.go:157: STATUS: No issue detected - session IDs are consistent
    router_production_test.go:158: VERIFIED: SessionManager generates IDs, Router uses them consistently
--- PASS: TestProductionIssue02_SessionIDConsistency (0.00s)
=== RUN   TestProductionIssue02_CreateNewSessionFlow
=== RUN   TestProductionIssue02_CreateNewSessionFlow/Sub-task_2.3.1-2.3.4:_Successful_session_creation_flow
    router_production_test.go:186: Sub-task 2.3.1: Creating mock StorageService...
    router_production_test.go:189: ✓ Mock StorageService created successfully
    router_production_test.go:201: Sub-task 2.3.2: Testing createNewSession method...
    router_production_test.go:208: ✓ createNewSession succeeded with session ID: a941fca5ce7b33b7fc6fc9d701511ad9
    router_production_test.go:211: Sub-task 2.3.3: Verifying SessionManager.CreateSession was called...
    router_production_test.go:217: ✓ SessionManager.CreateSession was called and session exists in memory
    router_production_test.go:220: Sub-task 2.3.4: Verifying StorageService.CreateSession was called...
    router_production_test.go:225: ✓ StorageService.CreateSession was called with session ID: a941fca5ce7b33b7fc6fc9d701511ad9
    router_production_test.go:228: Verifying session ID consistency between memory and storage...
    router_production_test.go:231: ✓ Session ID is consistent across all components
    router_production_test.go:233: 
    router_production_test.go:234: FINDING: Session creation flow is atomic and consistent
    router_production_test.go:235: STATUS: All components receive the same session ID
    router_production_test.go:236: VERIFIED: SessionManager → Storage flow works correctly
=== RUN   TestProductionIssue02_CreateNewSessionFlow/Sub-task_2.3.5:_Rollback_on_storage_failure
    router_production_test.go:240: Sub-task 2.3.5: Testing rollback on storage failure...
    router_production_test.go:262: Attempting to create session with failing storage...
    router_production_test.go:249: Storage received session ID: e2c6a09ed14546b06cacc2ceee5840bd (will fail)
    router_production_test.go:268: ✓ createNewSession returned error as expected
    router_production_test.go:272: ✓ Storage CreateSession was attempted
    router_production_test.go:275: Verifying rollback behavior...
    router_production_test.go:280: Checking rollback for session ID: e2c6a09ed14546b06cacc2ceee5840bd
    router_production_test.go:291: ✓ Session was rolled back (marked inactive)
    router_production_test.go:292: 
    router_production_test.go:293: FINDING: Rollback calls EndSession, leaving session in memory
    router_production_test.go:294: BEHAVIOR: Session exists but is marked inactive with EndTime set
    router_production_test.go:295: IMPACT: Failed session creation leaves inactive session in memory
    router_production_test.go:296: RECOMMENDATION: Consider removing session entirely on rollback
    router_production_test.go:308: Verifying user mapping was cleaned up...
    router_production_test.go:313: ✓ User session mapping was cleaned up (user can create new session)
    router_production_test.go:316: 
    router_production_test.go:317: STATUS: Rollback mechanism works correctly
    router_production_test.go:318: VERIFIED: Storage failure triggers proper cleanup
=== NAME  TestProductionIssue02_CreateNewSessionFlow
    router_production_test.go:321: 
    router_production_test.go:322: === OVERALL FINDINGS ===
    router_production_test.go:323: 1. Session creation flow is atomic and consistent
    router_production_test.go:324: 2. SessionManager and Storage receive the same session ID
    router_production_test.go:325: 3. Rollback mechanism activates on storage failure
    router_production_test.go:326: 4. Failed sessions are marked inactive (not removed)
    router_production_test.go:327: 5. User mappings are properly cleaned up on rollback
    router_production_test.go:328: 
    router_production_test.go:329: STATUS: Session creation flow works correctly with proper error handling
--- PASS: TestProductionIssue02_CreateNewSessionFlow (0.00s)
    --- PASS: TestProductionIssue02_CreateNewSessionFlow/Sub-task_2.3.1-2.3.4:_Successful_session_creation_flow (0.00s)
    --- PASS: TestProductionIssue02_CreateNewSessionFlow/Sub-task_2.3.5:_Rollback_on_storage_failure (0.00s)
=== RUN   TestProductionIssue03_ConnectionReplacement
    router_production_test.go:363: Sub-task 3.1.1: Registering first connection...
    router_production_test.go:372: ✓ First connection registered successfully
    router_production_test.go:382: ✓ First connection verified in connections map (total: 1)
    router_production_test.go:385: 
    router_production_test.go:386: Sub-task 3.1.2: Registering second connection for same session...
    router_production_test.go:395: Goroutines before replacement: 239
    router_production_test.go:399: ✓ Second connection registered successfully
    router_production_test.go:402: 
    router_production_test.go:403: Sub-task 3.1.3: Verifying replacement occurred...
    router_production_test.go:412: ✓ Second connection successfully replaced first connection
    router_production_test.go:413: ✓ Connection count remains at 1 (no duplicate entries)
    router_production_test.go:418: ✓ Confirmed: conn1 and conn2 are different connection objects
    router_production_test.go:421: 
    router_production_test.go:422: Sub-task 3.1.4: Documenting cleanup behavior...
    router_production_test.go:429: Goroutines after replacement: 239
    router_production_test.go:436: ✓ Goroutine count stable (delta: 0)
    router_production_test.go:439: 
    router_production_test.go:440: === CLEANUP BEHAVIOR DOCUMENTATION ===
    router_production_test.go:441: FINDING: Connection replacement occurs without explicit cleanup
    router_production_test.go:442: BEHAVIOR: RegisterConnection() simply overwrites the map entry
    router_production_test.go:443: IMPACT: Old connection (conn1) is not explicitly closed before replacement
    router_production_test.go:444: CONSEQUENCE: If conn1 has active goroutines or resources, they may leak
    router_production_test.go:445: 
    router_production_test.go:446: CODE ANALYSIS:
    router_production_test.go:447:   Location: router/router.go RegisterConnection()
    router_production_test.go:448:   Current: mr.connections[sessionID] = conn
    router_production_test.go:449:   Missing: No check for existing connection
    router_production_test.go:450:   Missing: No call to close old connection before replacement
    router_production_test.go:451: 
    router_production_test.go:452: RECOMMENDATION:
    router_production_test.go:453:   1. Check if connection already exists for sessionID
    router_production_test.go:454:   2. If exists, close old connection before replacement
    router_production_test.go:455:   3. Add logging for connection replacement events
    router_production_test.go:456:   4. Consider notifying old connection about replacement
    router_production_test.go:457: 
    router_production_test.go:458: EXAMPLE FIX:
    router_production_test.go:459:   if oldConn, exists := mr.connections[sessionID]; exists {
    router_production_test.go:460:       logger.Warn("Replacing existing connection", "sessionID", sessionID)
    router_production_test.go:461:       oldConn.Close() // Close old connection
    router_production_test.go:462:   }
    router_production_test.go:463:   mr.connections[sessionID] = conn
    router_production_test.go:464: 
    router_production_test.go:465: STATUS: Test documents current behavior - fix needed in production code
--- PASS: TestProductionIssue03_ConnectionReplacement (0.10s)
=== RUN   TestProductionIssue03_UnregisterConnection
    router_production_test.go:497: Sub-task 3.2.1: Registering connection...
    router_production_test.go:506: ✓ Connection registered successfully
    router_production_test.go:516: ✓ Connection verified in map (total connections: 1)
    router_production_test.go:523: Goroutines before unregister: 240
    router_production_test.go:526: 
    router_production_test.go:527: Sub-task 3.2.2: Unregistering connection...
    router_production_test.go:529: ✓ UnregisterConnection() called
    router_production_test.go:532: 
    router_production_test.go:533: Sub-task 3.2.3: Verifying removal from map...
    router_production_test.go:542: ✓ Connection successfully removed from map
    router_production_test.go:543: ✓ Connection count: 1 → 0
    router_production_test.go:557: ✓ Confirmed: session ID completely removed from map
    router_production_test.go:560: 
    router_production_test.go:561: Sub-task 3.2.4: Checking for goroutine leaks...
    router_production_test.go:572: Goroutines after unregister: 240
    router_production_test.go:573: Goroutine delta: 0
    router_production_test.go:585: ✓ Goroutine count stable (delta: 0, within acceptable range)
    router_production_test.go:590: ✓ No significant goroutine leak detected
    router_production_test.go:593: 
    router_production_test.go:594: Additional test: Verifying idempotent unregister...
    router_production_test.go:602: ✓ UnregisterConnection is idempotent (safe to call multiple times)
    router_production_test.go:604: 
    router_production_test.go:605: === CLEANUP BEHAVIOR DOCUMENTATION ===
    router_production_test.go:606: FINDING: UnregisterConnection properly removes connection from map
    router_production_test.go:607: BEHAVIOR: Connection is deleted from mr.connections map
    router_production_test.go:608: VERIFIED: No significant goroutine leaks detected
    router_production_test.go:609: VERIFIED: Operation is idempotent (safe to call multiple times)
    router_production_test.go:610: 
    router_production_test.go:611: CODE ANALYSIS:
    router_production_test.go:612:   Location: router/router.go UnregisterConnection()
    router_production_test.go:613:   Current: delete(mr.connections, sessionID)
    router_production_test.go:614:   Behavior: Simple map deletion with mutex protection
    router_production_test.go:615: 
    router_production_test.go:616: STATUS: UnregisterConnection properly cleans up resources
    router_production_test.go:617: RECOMMENDATION: Current implementation is correct
--- PASS: TestProductionIssue03_UnregisterConnection (0.21s)
=== RUN   TestProductionIssue08_StreamingContext
    router_production_test.go:635: Sub-task 8.1.1: Creating mock LLM service...
    router_production_test.go:644: ✓ Mock LLM service created
    router_production_test.go:659: ✓ MessageRouter created with timeout: 2m0s
    router_production_test.go:675: ✓ Connection registered
    router_production_test.go:685: 
    router_production_test.go:686: Sub-task 8.1.2: Calling HandleUserMessage...
    router_production_test.go:689: ✓ HandleUserMessage completed successfully
    router_production_test.go:692: 
    router_production_test.go:693: Sub-task 8.1.3: Verifying context type...
    router_production_test.go:695: ✓ Context type: *context.timerCtx
    router_production_test.go:698: 
    router_production_test.go:699: Sub-task 8.1.4: Checking for timeout configuration...
    router_production_test.go:705: ✓ Context has timeout configured
    router_production_test.go:706: ✓ Time until deadline: 1m59.99990125s
    router_production_test.go:714: ✓ Timeout is within expected range (110s-125s)
    router_production_test.go:720: 
    router_production_test.go:721: Sub-task 8.1.5: Documenting context usage...
    router_production_test.go:722: 
    router_production_test.go:723: === CONTEXT USAGE DOCUMENTATION ===
    router_production_test.go:724: FINDING: Context has proper timeout configuration
    router_production_test.go:725: IMPLEMENTATION: Uses context.WithTimeout(context.Background(), timeout)
    router_production_test.go:726: LOCATION: router/router.go:221
    router_production_test.go:727: BEHAVIOR:
    router_production_test.go:728:   1. Router is initialized with llmStreamTimeout parameter
    router_production_test.go:729:   2. HandleUserMessage creates context with timeout
    router_production_test.go:730:   3. Default timeout is 120 seconds if not configured
    router_production_test.go:731:   4. Context is passed to LLM StreamMessage()
    router_production_test.go:732:   5. Timeout prevents indefinite hangs
    router_production_test.go:733: 
    router_production_test.go:734: VERIFICATION:
    router_production_test.go:735:   - Context type: *context.timerCtx
    router_production_test.go:736:   - Has deadline: true
    router_production_test.go:738:   - Configured timeout: 2m0s
    router_production_test.go:739:   - Actual deadline: 1m59.999597375s from now
    router_production_test.go:741: 
    router_production_test.go:742: STATUS: ✓ VERIFIED - Timeout is properly configured
    router_production_test.go:743: IMPACT: Streaming operations will timeout after configured duration
    router_production_test.go:744: RECOMMENDATION: Current implementation is correct
    router_production_test.go:745: 
    router_production_test.go:746: CODE ANALYSIS:
    router_production_test.go:747:   timeout := mr.llmStreamTimeout
    router_production_test.go:748:   if timeout == 0 {
    router_production_test.go:749:       timeout = 120 * time.Second // Default 2 minutes
    router_production_test.go:750:   }
    router_production_test.go:751:   ctx, cancel := context.WithTimeout(context.Background(), timeout)
    router_production_test.go:752:   defer cancel()
    router_production_test.go:753: 
    router_production_test.go:754: CONCLUSION: Production readiness issue #8 has been RESOLVED
--- PASS: TestProductionIssue08_StreamingContext (0.00s)
=== RUN   TestProductionIssue08_StreamingTimeout
    router_production_test.go:780: Sub-task 8.2.1: Creating hanging LLM mock...
    router_production_test.go:794: ✓ Hanging LLM mock created (will never send data)
    router_production_test.go:800: ✓ MessageRouter created with SHORT timeout: 2s
    router_production_test.go:816: ✓ Connection registered
    router_production_test.go:826: 
    router_production_test.go:827: Sub-task 8.2.2: Calling HandleUserMessage with hanging LLM...
    router_production_test.go:830: 
    router_production_test.go:831: Sub-task 8.2.3: Measuring completion time...
    router_production_test.go:788: ✓ Context was cancelled (timeout triggered)
    router_production_test.go:838: ✓ Request completed in 2.0007295s
    router_production_test.go:846: ✓ Function returned nil (channel closed cleanly after timeout)
    router_production_test.go:855: ✓ Timeout was enforced (completed in 2.0007295s, expected ~2s)
    router_production_test.go:858: 
    router_production_test.go:859: Sub-task 8.2.4: Documenting timeout behavior...
    router_production_test.go:860: 
    router_production_test.go:861: === TIMEOUT BEHAVIOR DOCUMENTATION ===
    router_production_test.go:862: FINDING: Timeout is properly enforced
    router_production_test.go:863: IMPLEMENTATION: context.WithTimeout prevents indefinite hangs
    router_production_test.go:864: LOCATION: router/router.go:221-245
    router_production_test.go:865: 
    router_production_test.go:866: TEST SCENARIO:
    router_production_test.go:867:   1. LLM mock never sends data (simulates hang)
    router_production_test.go:868:   2. Context timeout is set to 2 seconds
    router_production_test.go:869:   3. HandleUserMessage is called
    router_production_test.go:870:   4. Request times out after configured duration
    router_production_test.go:871:   5. Error is returned to caller
    router_production_test.go:872: 
    router_production_test.go:873: VERIFICATION:
    router_production_test.go:874:   - Configured timeout: 2s
    router_production_test.go:875:   - Actual duration: 2.0007295s
    router_production_test.go:879:   - Error returned: nil (channel closed cleanly)
    router_production_test.go:881:   - Timeout enforced: true
    router_production_test.go:882: 
    router_production_test.go:883: BEHAVIOR ANALYSIS:
    router_production_test.go:884:   1. Context deadline is set before calling LLM
    router_production_test.go:885:   2. LLM receives context with deadline
    router_production_test.go:886:   3. When deadline expires, ctx.Done() is signaled
    router_production_test.go:887:   4. LLM operation is cancelled
    router_production_test.go:888:   5. Error is propagated back to caller
    router_production_test.go:889:   6. Client receives error message via WebSocket
    router_production_test.go:890: 
    router_production_test.go:891: ERROR HANDLING:
    router_production_test.go:892:   - Timeout errors are detected via ctx.Err() == context.DeadlineExceeded
    router_production_test.go:893:   - Custom error message is created: ErrLLMTimeout
    router_production_test.go:894:   - Error is sent to client via WebSocket
    router_production_test.go:895:   - Session state is preserved (not corrupted)
    router_production_test.go:896: 
    router_production_test.go:897: STATUS: ✓ VERIFIED - Timeout is properly enforced
    router_production_test.go:898: IMPACT: Requests will NOT hang indefinitely
    router_production_test.go:899: RECOMMENDATION: Current implementation is correct
    router_production_test.go:900: 
    router_production_test.go:901: PRODUCTION CONFIGURATION:
    router_production_test.go:902:   - Default timeout: 120 seconds (2 minutes)
    router_production_test.go:903:   - Configurable via MessageRouter initialization
    router_production_test.go:904:   - Fallback to 120s if timeout is 0
    router_production_test.go:905: 
    router_production_test.go:906: CONCLUSION: Production readiness issue #8 has been RESOLVED
    router_production_test.go:907:   - Context has proper timeout configuration
    router_production_test.go:908:   - Timeout is enforced correctly
    router_production_test.go:909:   - Errors are handled gracefully
    router_production_test.go:910:   - No indefinite hangs possible
--- PASS: TestProductionIssue08_StreamingTimeout (2.00s)
=== RUN   TestProperty_MessageOrderPreservation
+ messages are processed in order within a session: OK, passed 20 tests.
--- PASS: TestProperty_MessageOrderPreservation (0.02s)
=== RUN   TestProperty_ConnectionTracking
+ connections are tracked by session ID: OK, passed 20 tests.
--- PASS: TestProperty_ConnectionTracking (0.00s)
=== RUN   TestProperty_MessageRoutingToCorrectHandler
+ messages are routed to correct handlers based on type: OK, passed 20
   tests.
--- PASS: TestProperty_MessageRoutingToCorrectHandler (0.00s)
=== RUN   TestProperty_ErrorHandlingForInvalidMessages
+ router handles invalid messages gracefully: OK, passed 20 tests.
--- PASS: TestProperty_ErrorHandlingForInvalidMessages (0.00s)
=== RUN   TestProperty_ConcurrentConnectionAccessSafety
+ router handles concurrent access safely: OK, passed 20 tests.
--- PASS: TestProperty_ConcurrentConnectionAccessSafety (0.00s)
=== RUN   TestProperty_BroadcastToSessionParticipants
+ broadcast sends to all session participants: OK, passed 20 tests.
--- PASS: TestProperty_BroadcastToSessionParticipants (0.00s)
=== RUN   TestProperty_VoiceMessageRouting
+ voice messages are routed with audio file reference: OK, passed 20 tests.
--- PASS: TestProperty_VoiceMessageRouting (2.03s)
=== RUN   TestProperty_VoiceResponseFormatting
+ voice responses include audio file URL: OK, passed 20 tests.
--- PASS: TestProperty_VoiceResponseFormatting (0.00s)
=== RUN   TestProperty_StreamingRequestsHaveTimeout
+ all streaming requests have context deadline: OK, passed 100 tests.
--- PASS: TestProperty_StreamingRequestsHaveTimeout (0.00s)
=== RUN   TestProperty_TimeoutCancelsStreaming
+ timeout cancels streaming and returns error: OK, passed 50 tests.
--- PASS: TestProperty_TimeoutCancelsStreaming (5.07s)
=== RUN   TestNewMessageRouter
--- PASS: TestNewMessageRouter (0.00s)
=== RUN   TestRegisterConnection
=== RUN   TestRegisterConnection/valid_connection
=== RUN   TestRegisterConnection/nil_connection
=== RUN   TestRegisterConnection/empty_session_ID
--- PASS: TestRegisterConnection (0.00s)
    --- PASS: TestRegisterConnection/valid_connection (0.00s)
    --- PASS: TestRegisterConnection/nil_connection (0.00s)
    --- PASS: TestRegisterConnection/empty_session_ID (0.00s)
=== RUN   TestUnregisterConnection
--- PASS: TestUnregisterConnection (0.00s)
=== RUN   TestRouteMessage_UserMessage
--- PASS: TestRouteMessage_UserMessage (0.00s)
=== RUN   TestRouteMessage_InvalidMessageType
--- PASS: TestRouteMessage_InvalidMessageType (0.00s)
=== RUN   TestRouteMessage_NilInputs
--- PASS: TestRouteMessage_NilInputs (0.00s)
=== RUN   TestHandleUserMessage
=== RUN   TestHandleUserMessage/valid_user_message
=== RUN   TestHandleUserMessage/missing_session_ID
=== RUN   TestHandleUserMessage/non-existent_session_-_auto-creates
=== RUN   TestHandleUserMessage/nil_message
--- PASS: TestHandleUserMessage (0.00s)
    --- PASS: TestHandleUserMessage/valid_user_message (0.00s)
    --- PASS: TestHandleUserMessage/missing_session_ID (0.00s)
    --- PASS: TestHandleUserMessage/non-existent_session_-_auto-creates (0.00s)
    --- PASS: TestHandleUserMessage/nil_message (0.00s)
=== RUN   TestHandleUserMessage_NilConnection
--- PASS: TestHandleUserMessage_NilConnection (0.00s)
=== RUN   TestBroadcastToSession
=== RUN   TestBroadcastToSession/valid_broadcast
=== RUN   TestBroadcastToSession/nil_message
=== RUN   TestBroadcastToSession/empty_session_ID
=== RUN   TestBroadcastToSession/non-existent_session
--- PASS: TestBroadcastToSession (0.00s)
    --- PASS: TestBroadcastToSession/valid_broadcast (0.00s)
    --- PASS: TestBroadcastToSession/nil_message (0.00s)
    --- PASS: TestBroadcastToSession/empty_session_ID (0.00s)
    --- PASS: TestBroadcastToSession/non-existent_session (0.00s)
=== RUN   TestGetConnection
--- PASS: TestGetConnection (0.00s)
=== RUN   TestMessageOrderPreservation
--- PASS: TestMessageOrderPreservation (0.00s)
=== RUN   TestConcurrentConnectionAccess
--- PASS: TestConcurrentConnectionAccess (0.00s)
=== RUN   TestHandleModelSelection
--- PASS: TestHandleModelSelection (0.00s)
=== RUN   TestHandleModelSelection_EmptySessionID
--- PASS: TestHandleModelSelection_EmptySessionID (0.00s)
=== RUN   TestHandleModelSelection_EmptyModelID
--- PASS: TestHandleModelSelection_EmptyModelID (0.00s)
=== RUN   TestHandleModelSelection_NonExistentSession
--- PASS: TestHandleModelSelection_NonExistentSession (0.00s)
=== RUN   TestHandleModelSelection_UpdateModel
--- PASS: TestHandleModelSelection_UpdateModel (0.00s)
=== RUN   TestHandleModelSelection_NilConnection
--- PASS: TestHandleModelSelection_NilConnection (0.00s)
=== RUN   TestHandleModelSelection_NilMessage
--- PASS: TestHandleModelSelection_NilMessage (0.00s)
=== RUN   TestModelSelection_Persistence
--- PASS: TestModelSelection_Persistence (0.00s)
=== RUN   TestHandleUserMessage_Timeout
--- PASS: TestHandleUserMessage_Timeout (0.10s)
=== RUN   TestHandleUserMessage_TimeoutConfiguration
=== RUN   TestHandleUserMessage_TimeoutConfiguration/configured_timeout
=== RUN   TestHandleUserMessage_TimeoutConfiguration/zero_timeout_uses_default
--- PASS: TestHandleUserMessage_TimeoutConfiguration (0.00s)
    --- PASS: TestHandleUserMessage_TimeoutConfiguration/configured_timeout (0.00s)
    --- PASS: TestHandleUserMessage_TimeoutConfiguration/zero_timeout_uses_default (0.00s)
=== RUN   TestIntegration_SessionCreationFlow
=== RUN   TestIntegration_SessionCreationFlow/new_user_connects_and_sends_message_-_session_created
=== RUN   TestIntegration_SessionCreationFlow/reconnect_with_session_ID_-_session_restored
=== RUN   TestIntegration_SessionCreationFlow/concurrent_messages_from_same_user_-_single_session
=== RUN   TestIntegration_SessionCreationFlow/database_failure_-_error_handling
--- PASS: TestIntegration_SessionCreationFlow (0.00s)
    --- PASS: TestIntegration_SessionCreationFlow/new_user_connects_and_sends_message_-_session_created (0.00s)
    --- PASS: TestIntegration_SessionCreationFlow/reconnect_with_session_ID_-_session_restored (0.00s)
    --- PASS: TestIntegration_SessionCreationFlow/concurrent_messages_from_same_user_-_single_session (0.00s)
    --- PASS: TestIntegration_SessionCreationFlow/database_failure_-_error_handling (0.00s)
=== RUN   TestIntegration_SessionCreationWithMessages
=== RUN   TestIntegration_SessionCreationWithMessages/first_message_creates_session_and_routes_correctly
=== RUN   TestIntegration_SessionCreationWithMessages/subsequent_messages_use_existing_session
--- PASS: TestIntegration_SessionCreationWithMessages (0.00s)
    --- PASS: TestIntegration_SessionCreationWithMessages/first_message_creates_session_and_routes_correctly (0.00s)
    --- PASS: TestIntegration_SessionCreationWithMessages/subsequent_messages_use_existing_session (0.00s)
=== RUN   TestIntegration_SessionCreationErrorRecovery
=== RUN   TestIntegration_SessionCreationErrorRecovery/database_failure_then_recovery
--- PASS: TestIntegration_SessionCreationErrorRecovery (0.00s)
    --- PASS: TestIntegration_SessionCreationErrorRecovery/database_failure_then_recovery (0.00s)
=== RUN   TestIntegration_SessionCreationWithDifferentUsers
=== RUN   TestIntegration_SessionCreationWithDifferentUsers/multiple_users_create_independent_sessions
--- PASS: TestIntegration_SessionCreationWithDifferentUsers (0.00s)
    --- PASS: TestIntegration_SessionCreationWithDifferentUsers/multiple_users_create_independent_sessions (0.00s)
=== RUN   TestProperty_AutomaticSessionCreationForNewUsers
+ new session is created for users without existing session: OK, passed
   100 tests.
--- PASS: TestProperty_AutomaticSessionCreationForNewUsers (0.01s)
=== RUN   TestProperty_ExistingSessionReuse
+ existing sessions are reused instead of creating new ones: OK, passed
   100 tests.
--- PASS: TestProperty_ExistingSessionReuse (0.00s)
=== RUN   TestProperty_SessionCreationWithProvidedID
+ new session is created when provided ID does not exist: OK, passed 100
   tests.
--- PASS: TestProperty_SessionCreationWithProvidedID (0.01s)
=== RUN   TestProperty_DualStorageConsistency
+ sessions exist in both memory and database with consistent data: OK,
   passed 100 tests.
--- PASS: TestProperty_DualStorageConsistency (0.00s)
=== RUN   TestProperty_UserAssociationCorrectness
+ session user ID matches connection user ID: OK, passed 100 tests.
--- PASS: TestProperty_UserAssociationCorrectness (0.00s)
=== RUN   TestProperty_SessionCreationErrorHandling
+ session creation failures return appropriate errors: OK, passed 100
   tests.
--- PASS: TestProperty_SessionCreationErrorHandling (0.00s)
=== RUN   TestProperty_ConcurrentSessionCreationSafety
+ concurrent session creation is handled safely: OK, passed 100 tests.
--- PASS: TestProperty_ConcurrentSessionCreationSafety (0.01s)
=== RUN   TestProperty_SessionRestorationFromDatabase
+ sessions can be restored from database with data intact: OK, passed 100
   tests.
--- PASS: TestProperty_SessionRestorationFromDatabase (0.00s)
=== RUN   TestGetOrCreateSession_AutomaticCreation
--- PASS: TestGetOrCreateSession_AutomaticCreation (0.00s)
=== RUN   TestGetOrCreateSession_ExistingSessionReuse
--- PASS: TestGetOrCreateSession_ExistingSessionReuse (0.00s)
=== RUN   TestGetOrCreateSession_SessionCreationWithProvidedID
--- PASS: TestGetOrCreateSession_SessionCreationWithProvidedID (0.00s)
=== RUN   TestCreateNewSession_DualStorage
--- PASS: TestCreateNewSession_DualStorage (0.00s)
=== RUN   TestCreateNewSession_UserIDAssociation
=== RUN   TestCreateNewSession_UserIDAssociation/user_with_alphanumeric_ID
=== RUN   TestCreateNewSession_UserIDAssociation/user_with_UUID
=== RUN   TestCreateNewSession_UserIDAssociation/user_with_numeric_ID
--- PASS: TestCreateNewSession_UserIDAssociation (0.00s)
    --- PASS: TestCreateNewSession_UserIDAssociation/user_with_alphanumeric_ID (0.00s)
    --- PASS: TestCreateNewSession_UserIDAssociation/user_with_UUID (0.00s)
    --- PASS: TestCreateNewSession_UserIDAssociation/user_with_numeric_ID (0.00s)
=== RUN   TestCreateNewSession_DatabaseFailure
--- PASS: TestCreateNewSession_DatabaseFailure (0.00s)
=== RUN   TestCreateNewSession_RollbackOnPartialFailure
--- PASS: TestCreateNewSession_RollbackOnPartialFailure (0.00s)
=== RUN   TestGetOrCreateSession_ConcurrentCreation
--- PASS: TestGetOrCreateSession_ConcurrentCreation (0.00s)
=== RUN   TestGetOrCreateSession_EmptyUserID
--- PASS: TestGetOrCreateSession_EmptyUserID (0.00s)
=== RUN   TestGetOrCreateSession_NilConnection
--- PASS: TestGetOrCreateSession_NilConnection (0.00s)
=== RUN   TestCreateNewSession_SessionMetadata
--- PASS: TestCreateNewSession_SessionMetadata (0.00s)
=== RUN   TestGetOrCreateSession_MultipleUsers
--- PASS: TestGetOrCreateSession_MultipleUsers (0.00s)
=== RUN   TestStreamingResponseForwarding
=== RUN   TestStreamingResponseForwarding/single_chunk
=== RUN   TestStreamingResponseForwarding/multiple_chunks
=== RUN   TestStreamingResponseForwarding/empty_chunk_in_middle
--- PASS: TestStreamingResponseForwarding (0.06s)
    --- PASS: TestStreamingResponseForwarding/single_chunk (0.00s)
    --- PASS: TestStreamingResponseForwarding/multiple_chunks (0.04s)
    --- PASS: TestStreamingResponseForwarding/empty_chunk_in_middle (0.02s)
=== RUN   TestStreamingErrorHandling
--- PASS: TestStreamingErrorHandling (0.00s)
=== RUN   TestLLMErrorScenarios
=== RUN   TestLLMErrorScenarios/network_timeout
=== RUN   TestLLMErrorScenarios/service_unavailable
=== RUN   TestLLMErrorScenarios/rate_limit_exceeded
--- PASS: TestLLMErrorScenarios (0.00s)
    --- PASS: TestLLMErrorScenarios/network_timeout (0.00s)
    --- PASS: TestLLMErrorScenarios/service_unavailable (0.00s)
    --- PASS: TestLLMErrorScenarios/rate_limit_exceeded (0.00s)
=== RUN   TestStreamingChunkError
--- PASS: TestStreamingChunkError (0.01s)
=== RUN   TestLLMErrorDoesNotLeakInternalDetails
--- PASS: TestLLMErrorDoesNotLeakInternalDetails (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/router	15.952s
=== RUN   TestProperty_HelpRequestStateUpdate
+ marking help requested updates session state: OK, passed 100 tests.
Elapsed time: 1.197041ms
--- PASS: TestProperty_HelpRequestStateUpdate (0.00s)
=== RUN   TestProperty_AdminTakeoverConnection
+ admin takeover marks session with admin info: OK, passed 100 tests.
Elapsed time: 2.857208ms
--- PASS: TestProperty_AdminTakeoverConnection (0.00s)
=== RUN   TestProperty_AdminAssistedSessionMarking
+ admin assistance persists after admin leaves: OK, passed 100 tests.
Elapsed time: 2.645375ms
--- PASS: TestProperty_AdminAssistedSessionMarking (0.00s)
=== RUN   TestProperty_AdminSessionLocking
+ only one admin can assist a session at a time: OK, passed 100 tests.
Elapsed time: 4.193875ms
--- PASS: TestProperty_AdminSessionLocking (0.00s)
=== RUN   TestProperty_ResponseTimesBounded
--- PASS: TestProperty_ResponseTimesBounded (0.04s)
=== RUN   TestProperty_RollingWindowMaintainsRecent
--- PASS: TestProperty_RollingWindowMaintainsRecent (0.03s)
=== RUN   TestProperty_SessionCleanupRemovesExpiredSessions
+ expired sessions are removed after TTL: OK, passed 20 tests.
Elapsed time: 2.101161708s
--- PASS: TestProperty_SessionCleanupRemovesExpiredSessions (2.10s)
=== RUN   TestProperty_SessionCleanupRemovesMultipleExpiredSessions
+ multiple expired sessions are removed after TTL: OK, passed 100 tests.
Elapsed time: 10.142112625s
--- PASS: TestProperty_SessionCleanupRemovesMultipleExpiredSessions (10.14s)
=== RUN   TestProperty_SessionCleanupHandlesNilEndTime
+ sessions with nil EndTime are not removed: OK, passed 100 tests.
Elapsed time: 10.147704583s
--- PASS: TestProperty_SessionCleanupHandlesNilEndTime (10.15s)
=== RUN   TestProperty_SessionCleanupRespectsTimeWindow
+ sessions are not removed before TTL expires: OK, passed 100 tests.
Elapsed time: 10.135606084s
--- PASS: TestProperty_SessionCleanupRespectsTimeWindow (10.14s)
=== RUN   TestProperty_ActiveSessionsNeverCleanedUp
+ active sessions are never removed by cleanup: OK, passed 20 tests.
Elapsed time: 1.06632075s
--- PASS: TestProperty_ActiveSessionsNeverCleanedUp (1.07s)
=== RUN   TestProperty_MultipleActiveSessionsPreservedDuringCleanup
+ multiple active sessions preserved across cleanup cycles: OK, passed 100
   tests.
Elapsed time: 10.136369833s
--- PASS: TestProperty_MultipleActiveSessionsPreservedDuringCleanup (10.14s)
=== RUN   TestProperty_CleanupSelectivelyRemovesInactiveSessions
+ cleanup removes inactive but preserves active sessions: OK, passed 100
   tests.
Elapsed time: 10.143650417s
--- PASS: TestProperty_CleanupSelectivelyRemovesInactiveSessions (10.14s)
=== RUN   TestCleanupExpiredSessions_RemovesExpiredSessions
--- PASS: TestCleanupExpiredSessions_RemovesExpiredSessions (0.15s)
=== RUN   TestCleanupExpiredSessions_PreservesActiveSessions
--- PASS: TestCleanupExpiredSessions_PreservesActiveSessions (0.15s)
=== RUN   TestCleanupExpiredSessions_PreservesRecentlyEndedSessions
--- PASS: TestCleanupExpiredSessions_PreservesRecentlyEndedSessions (0.10s)
=== RUN   TestCleanupExpiredSessions_LogsStatistics
--- PASS: TestCleanupExpiredSessions_LogsStatistics (0.15s)
=== RUN   TestCleanupExpiredSessions_HandlesNilEndTime
--- PASS: TestCleanupExpiredSessions_HandlesNilEndTime (0.00s)
=== RUN   TestGetMemoryStats_AccurateCounts
--- PASS: TestGetMemoryStats_AccurateCounts (0.00s)
=== RUN   TestGetMemoryStats_ThreadSafe
--- PASS: TestGetMemoryStats_ThreadSafe (0.00s)
=== RUN   TestProductionIssue01_SessionCleanup
    session_production_test.go:75: FINDING: Sessions remain in memory after EndSession() is called
    session_production_test.go:76: IMPACT: Unbounded memory growth as sessions accumulate
    session_production_test.go:77: RECOMMENDATION: Implement periodic cleanup or TTL-based removal
--- PASS: TestProductionIssue01_SessionCleanup (0.00s)
=== RUN   TestProductionIssue01_MemoryGrowth
    session_production_test.go:148: Created and ended 1000 sessions
    session_production_test.go:149: Sessions remaining in memory: 1000
    session_production_test.go:150: Memory growth: 1525712 bytes (1.46 MB)
    session_production_test.go:156: FINDING: All ended sessions remain in memory indefinitely
    session_production_test.go:157: IMPACT: Memory grows unbounded with session count
    session_production_test.go:158: RISK: Production deployment will eventually OOM crash
    session_production_test.go:159: RECOMMENDATION: Implement cleanup mechanism (TTL, LRU, or manual cleanup)
--- PASS: TestProductionIssue01_MemoryGrowth (0.11s)
=== RUN   TestProductionIssue12_ResponseTimesGrowth
    session_production_test.go:227: Recorded 10000 response times
    session_production_test.go:228: Stored response times: 100 (capped at MaxResponseTimes)
    session_production_test.go:229: Approximate memory usage: 800 bytes (0.78 KB)
    session_production_test.go:232: FINDING: ResponseTimes slice is now capped with rolling window
    session_production_test.go:233: STATUS: FIXED - Issue #12 has been resolved
    session_production_test.go:234: IMPLEMENTATION: MaxResponseTimes constant limits array size to 100 entries
    session_production_test.go:235: IMPACT: Memory usage per session is now bounded
--- PASS: TestProductionIssue12_ResponseTimesGrowth (0.00s)
=== RUN   TestProductionIssue01_RestoreSessionAfterTimeout
    session_production_test.go:289: FINDING: Timed-out sessions remain in memory
    session_production_test.go:290: IMPACT: Sessions that can't be restored still consume memory
--- PASS: TestProductionIssue01_RestoreSessionAfterTimeout (0.15s)
=== RUN   TestProductionIssue04_ConcurrentSessionAccess
    session_production_test.go:417: FINDING: Session fields are properly protected by mutex
    session_production_test.go:418: RESULT: No data races detected with concurrent access
    session_production_test.go:419: NOTE: Run with -race flag to verify: go test -race -run TestProductionIssue04_ConcurrentSessionAccess
--- PASS: TestProductionIssue04_ConcurrentSessionAccess (0.01s)
=== RUN   TestProperty_SessionContinuityTimeout
+ session restored within timeout, new session after timeout: OK, passed
   20 tests.
--- PASS: TestProperty_SessionContinuityTimeout (3.14s)
=== RUN   TestProperty_MultipleSessionsPerUser
+ user can have multiple session records over time: OK, passed 20 tests.
--- PASS: TestProperty_MultipleSessionsPerUser (0.00s)
=== RUN   TestProperty_SingleActiveSessionConstraint
+ user cannot have multiple concurrent active sessions: OK, passed 20
   tests.
--- PASS: TestProperty_SingleActiveSessionConstraint (0.00s)
=== RUN   TestProperty_AutomaticSessionNameGeneration
+ session name is generated from first message: OK, passed 20 tests.
--- PASS: TestProperty_AutomaticSessionNameGeneration (0.00s)
=== RUN   TestNewSessionManager
--- PASS: TestNewSessionManager (0.00s)
=== RUN   TestCreateSession_ValidUser
--- PASS: TestCreateSession_ValidUser (0.00s)
=== RUN   TestCreateSession_EmptyUserID
--- PASS: TestCreateSession_EmptyUserID (0.00s)
=== RUN   TestCreateSession_SingleActiveSessionConstraint
--- PASS: TestCreateSession_SingleActiveSessionConstraint (0.00s)
=== RUN   TestCreateSession_AfterEndingPreviousSession
--- PASS: TestCreateSession_AfterEndingPreviousSession (0.00s)
=== RUN   TestGetSession_ExistingSession
--- PASS: TestGetSession_ExistingSession (0.00s)
=== RUN   TestGetSession_NonExistentSession
--- PASS: TestGetSession_NonExistentSession (0.00s)
=== RUN   TestGetSession_EmptySessionID
--- PASS: TestGetSession_EmptySessionID (0.00s)
=== RUN   TestRestoreSession_WithinTimeout
--- PASS: TestRestoreSession_WithinTimeout (0.00s)
=== RUN   TestRestoreSession_AfterTimeout
--- PASS: TestRestoreSession_AfterTimeout (0.15s)
=== RUN   TestRestoreSession_NonExistentSession
--- PASS: TestRestoreSession_NonExistentSession (0.00s)
=== RUN   TestRestoreSession_WrongUser
--- PASS: TestRestoreSession_WrongUser (0.00s)
=== RUN   TestEndSession_ExistingSession
--- PASS: TestEndSession_ExistingSession (0.00s)
=== RUN   TestEndSession_NonExistentSession
--- PASS: TestEndSession_NonExistentSession (0.00s)
=== RUN   TestEndSession_EmptySessionID
--- PASS: TestEndSession_EmptySessionID (0.00s)
=== RUN   TestSessionTimeout_DefaultValue
--- PASS: TestSessionTimeout_DefaultValue (0.00s)
=== RUN   TestSessionTimeout_CustomValue
--- PASS: TestSessionTimeout_CustomValue (0.00s)
=== RUN   TestUserToSessionMapping
--- PASS: TestUserToSessionMapping (0.00s)
=== RUN   TestUserToSessionMapping_RemovedAfterEnd
--- PASS: TestUserToSessionMapping_RemovedAfterEnd (0.00s)
=== RUN   TestSession_InitialState
--- PASS: TestSession_InitialState (0.00s)
=== RUN   TestConcurrentSessionCreation
--- PASS: TestConcurrentSessionCreation (0.00s)
=== RUN   TestConcurrentGetSession
--- PASS: TestConcurrentGetSession (0.00s)
=== RUN   TestRestoreSession_ReactivatesSession
--- PASS: TestRestoreSession_ReactivatesSession (0.00s)
=== RUN   TestRestoreSession_UpdatesUserMapping
--- PASS: TestRestoreSession_UpdatesUserMapping (0.00s)
=== RUN   TestGenerateSessionName
=== RUN   TestGenerateSessionName/short_message
=== RUN   TestGenerateSessionName/long_message_gets_truncated
=== RUN   TestGenerateSessionName/message_with_multiple_sentences_uses_first_sentence
=== RUN   TestGenerateSessionName/empty_message_returns_default
=== RUN   TestGenerateSessionName/whitespace_only_returns_default
=== RUN   TestGenerateSessionName/message_with_newlines_uses_first_line
=== RUN   TestGenerateSessionName/message_with_special_characters
=== RUN   TestGenerateSessionName/very_short_max_length
=== RUN   TestGenerateSessionName/message_exactly_at_max_length
--- PASS: TestGenerateSessionName (0.00s)
    --- PASS: TestGenerateSessionName/short_message (0.00s)
    --- PASS: TestGenerateSessionName/long_message_gets_truncated (0.00s)
    --- PASS: TestGenerateSessionName/message_with_multiple_sentences_uses_first_sentence (0.00s)
    --- PASS: TestGenerateSessionName/empty_message_returns_default (0.00s)
    --- PASS: TestGenerateSessionName/whitespace_only_returns_default (0.00s)
    --- PASS: TestGenerateSessionName/message_with_newlines_uses_first_line (0.00s)
    --- PASS: TestGenerateSessionName/message_with_special_characters (0.00s)
    --- PASS: TestGenerateSessionName/very_short_max_length (0.00s)
    --- PASS: TestGenerateSessionName/message_exactly_at_max_length (0.00s)
=== RUN   TestGenerateSessionName_DefaultMaxLength
--- PASS: TestGenerateSessionName_DefaultMaxLength (0.00s)
=== RUN   TestSetSessionNameFromMessage
--- PASS: TestSetSessionNameFromMessage (0.00s)
=== RUN   TestSetSessionNameFromMessage_OnlyFirstMessage
--- PASS: TestSetSessionNameFromMessage_OnlyFirstMessage (0.00s)
=== RUN   TestSetSessionNameFromMessage_NonExistentSession
--- PASS: TestSetSessionNameFromMessage_NonExistentSession (0.00s)
=== RUN   TestSetSessionNameFromMessage_EmptySessionID
--- PASS: TestSetSessionNameFromMessage_EmptySessionID (0.00s)
=== RUN   TestUpdateTokenUsage
--- PASS: TestUpdateTokenUsage (0.00s)
=== RUN   TestUpdateTokenUsage_NonExistentSession
--- PASS: TestUpdateTokenUsage_NonExistentSession (0.00s)
=== RUN   TestUpdateTokenUsage_EmptySessionID
--- PASS: TestUpdateTokenUsage_EmptySessionID (0.00s)
=== RUN   TestUpdateTokenUsage_NegativeTokens
--- PASS: TestUpdateTokenUsage_NegativeTokens (0.00s)
=== RUN   TestRecordResponseTime
--- PASS: TestRecordResponseTime (0.00s)
=== RUN   TestRecordResponseTime_NonExistentSession
--- PASS: TestRecordResponseTime_NonExistentSession (0.00s)
=== RUN   TestRecordResponseTime_EmptySessionID
--- PASS: TestRecordResponseTime_EmptySessionID (0.00s)
=== RUN   TestRecordResponseTime_NegativeDuration
--- PASS: TestRecordResponseTime_NegativeDuration (0.00s)
=== RUN   TestGetMaxResponseTime
--- PASS: TestGetMaxResponseTime (0.00s)
=== RUN   TestGetMaxResponseTime_NoResponseTimes
--- PASS: TestGetMaxResponseTime_NoResponseTimes (0.00s)
=== RUN   TestGetMaxResponseTime_NonExistentSession
--- PASS: TestGetMaxResponseTime_NonExistentSession (0.00s)
=== RUN   TestGetMaxResponseTime_EmptySessionID
--- PASS: TestGetMaxResponseTime_EmptySessionID (0.00s)
=== RUN   TestGetAverageResponseTime
--- PASS: TestGetAverageResponseTime (0.00s)
=== RUN   TestGetAverageResponseTime_NoResponseTimes
--- PASS: TestGetAverageResponseTime_NoResponseTimes (0.00s)
=== RUN   TestGetAverageResponseTime_NonExistentSession
--- PASS: TestGetAverageResponseTime_NonExistentSession (0.00s)
=== RUN   TestGetAverageResponseTime_EmptySessionID
--- PASS: TestGetAverageResponseTime_EmptySessionID (0.00s)
=== RUN   TestGetSessionDuration
--- PASS: TestGetSessionDuration (0.10s)
=== RUN   TestGetSessionDuration_ActiveSession
--- PASS: TestGetSessionDuration_ActiveSession (0.05s)
=== RUN   TestGetSessionDuration_NonExistentSession
--- PASS: TestGetSessionDuration_NonExistentSession (0.00s)
=== RUN   TestGetSessionDuration_EmptySessionID
--- PASS: TestGetSessionDuration_EmptySessionID (0.00s)
=== RUN   TestConcurrentMetricsUpdates
--- PASS: TestConcurrentMetricsUpdates (0.00s)
=== RUN   TestSetModelID
--- PASS: TestSetModelID (0.00s)
=== RUN   TestSetModelID_EmptySessionID
--- PASS: TestSetModelID_EmptySessionID (0.00s)
=== RUN   TestSetModelID_EmptyModelID
--- PASS: TestSetModelID_EmptyModelID (0.00s)
=== RUN   TestSetModelID_NonExistentSession
--- PASS: TestSetModelID_NonExistentSession (0.00s)
=== RUN   TestSetModelID_UpdateExistingModel
--- PASS: TestSetModelID_UpdateExistingModel (0.00s)
=== RUN   TestGetModelID
--- PASS: TestGetModelID (0.00s)
=== RUN   TestGetModelID_EmptySessionID
--- PASS: TestGetModelID_EmptySessionID (0.00s)
=== RUN   TestGetModelID_NonExistentSession
--- PASS: TestGetModelID_NonExistentSession (0.00s)
=== RUN   TestGetModelID_NoModelSet
--- PASS: TestGetModelID_NoModelSet (0.00s)
=== RUN   TestModelSelection_Persistence
--- PASS: TestModelSelection_Persistence (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/session	65.533s
=== RUN   TestProperty_SessionMetricsCalculation
+ metrics calculation returns valid data structure: OK, passed 50 tests.
Elapsed time: 52.416µs
--- PASS: TestProperty_SessionMetricsCalculation (0.00s)
=== RUN   TestProperty_AdminAuthorizationCheck
+ session metadata structure is valid: OK, passed 100 tests.
Elapsed time: 1.364917ms
--- PASS: TestProperty_AdminAuthorizationCheck (0.00s)
=== RUN   TestEncryptionRoundTrip_CompleteFlow
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Simple_message
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Message_with_special_characters
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Message_with_unicode
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Long_message
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Empty_message
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Message_with_newlines
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Message_with_tabs
=== RUN   TestEncryptionRoundTrip_CompleteFlow/Sensitive_data
--- PASS: TestEncryptionRoundTrip_CompleteFlow (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Simple_message (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Message_with_special_characters (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Message_with_unicode (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Long_message (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Empty_message (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Message_with_newlines (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Message_with_tabs (0.00s)
    --- PASS: TestEncryptionRoundTrip_CompleteFlow/Sensitive_data (0.00s)
=== RUN   TestEncryptionRoundTrip_SessionConversion
--- PASS: TestEncryptionRoundTrip_SessionConversion (0.00s)
=== RUN   TestEncryptionRoundTrip_MultipleKeys
--- PASS: TestEncryptionRoundTrip_MultipleKeys (0.00s)
=== RUN   TestEncryptionRoundTrip_NonDeterministic
--- PASS: TestEncryptionRoundTrip_NonDeterministic (0.00s)
=== RUN   TestEncryptionRoundTrip_WithoutKey
--- PASS: TestEncryptionRoundTrip_WithoutKey (0.00s)
=== RUN   TestEncryptionRoundTrip_KeyLength
=== RUN   TestEncryptionRoundTrip_KeyLength/Valid_32-byte_key_(AES-256)
=== RUN   TestEncryptionRoundTrip_KeyLength/Valid_16-byte_key_(AES-128)
=== RUN   TestEncryptionRoundTrip_KeyLength/Valid_24-byte_key_(AES-192)
=== RUN   TestEncryptionRoundTrip_KeyLength/Invalid_31-byte_key
=== RUN   TestEncryptionRoundTrip_KeyLength/Invalid_33-byte_key
--- PASS: TestEncryptionRoundTrip_KeyLength (0.00s)
    --- PASS: TestEncryptionRoundTrip_KeyLength/Valid_32-byte_key_(AES-256) (0.00s)
    --- PASS: TestEncryptionRoundTrip_KeyLength/Valid_16-byte_key_(AES-128) (0.00s)
    --- PASS: TestEncryptionRoundTrip_KeyLength/Valid_24-byte_key_(AES-192) (0.00s)
    --- PASS: TestEncryptionRoundTrip_KeyLength/Invalid_31-byte_key (0.00s)
    --- PASS: TestEncryptionRoundTrip_KeyLength/Invalid_33-byte_key (0.00s)
=== RUN   TestEncryption_KeySizes
=== RUN   TestEncryption_KeySizes/AES-128_(16_bytes)
=== RUN   TestEncryption_KeySizes/AES-192_(24_bytes)
=== RUN   TestEncryption_KeySizes/AES-256_(32_bytes)
=== RUN   TestEncryption_KeySizes/Invalid_8_bytes
=== RUN   TestEncryption_KeySizes/Invalid_15_bytes
=== RUN   TestEncryption_KeySizes/Invalid_17_bytes
=== RUN   TestEncryption_KeySizes/Invalid_31_bytes
=== RUN   TestEncryption_KeySizes/Invalid_33_bytes
=== RUN   TestEncryption_KeySizes/Invalid_64_bytes
--- PASS: TestEncryption_KeySizes (0.00s)
    --- PASS: TestEncryption_KeySizes/AES-128_(16_bytes) (0.00s)
    --- PASS: TestEncryption_KeySizes/AES-192_(24_bytes) (0.00s)
    --- PASS: TestEncryption_KeySizes/AES-256_(32_bytes) (0.00s)
    --- PASS: TestEncryption_KeySizes/Invalid_8_bytes (0.00s)
    --- PASS: TestEncryption_KeySizes/Invalid_15_bytes (0.00s)
    --- PASS: TestEncryption_KeySizes/Invalid_17_bytes (0.00s)
    --- PASS: TestEncryption_KeySizes/Invalid_31_bytes (0.00s)
    --- PASS: TestEncryption_KeySizes/Invalid_33_bytes (0.00s)
    --- PASS: TestEncryption_KeySizes/Invalid_64_bytes (0.00s)
=== RUN   TestDecryption_Failures
=== RUN   TestDecryption_Failures/Invalid_base64
=== RUN   TestDecryption_Failures/Empty_ciphertext
=== RUN   TestDecryption_Failures/Valid_base64_but_too_short
=== RUN   TestDecryption_Failures/Valid_base64_but_corrupted_data
=== RUN   TestDecryption_Failures/Tampered_nonce
--- PASS: TestDecryption_Failures (0.00s)
    --- PASS: TestDecryption_Failures/Invalid_base64 (0.00s)
    --- PASS: TestDecryption_Failures/Empty_ciphertext (0.00s)
    --- PASS: TestDecryption_Failures/Valid_base64_but_too_short (0.00s)
    --- PASS: TestDecryption_Failures/Valid_base64_but_corrupted_data (0.00s)
    --- PASS: TestDecryption_Failures/Tampered_nonce (0.00s)
=== RUN   TestDecryption_WrongKey
--- PASS: TestDecryption_WrongKey (0.00s)
=== RUN   TestEncryption_RoundTrip
=== RUN   TestEncryption_RoundTrip/Empty_string
=== RUN   TestEncryption_RoundTrip/Single_character
=== RUN   TestEncryption_RoundTrip/Short_message
=== RUN   TestEncryption_RoundTrip/Medium_message
=== RUN   TestEncryption_RoundTrip/Long_message
=== RUN   TestEncryption_RoundTrip/Unicode_characters
=== RUN   TestEncryption_RoundTrip/Special_characters
=== RUN   TestEncryption_RoundTrip/Newlines_and_tabs
=== RUN   TestEncryption_RoundTrip/JSON-like_content
=== RUN   TestEncryption_RoundTrip/SQL-like_content
=== RUN   TestEncryption_RoundTrip/Binary-like_content
=== RUN   TestEncryption_RoundTrip/Repeated_patterns
=== RUN   TestEncryption_RoundTrip/Mixed_content
--- PASS: TestEncryption_RoundTrip (0.00s)
    --- PASS: TestEncryption_RoundTrip/Empty_string (0.00s)
    --- PASS: TestEncryption_RoundTrip/Single_character (0.00s)
    --- PASS: TestEncryption_RoundTrip/Short_message (0.00s)
    --- PASS: TestEncryption_RoundTrip/Medium_message (0.00s)
    --- PASS: TestEncryption_RoundTrip/Long_message (0.00s)
    --- PASS: TestEncryption_RoundTrip/Unicode_characters (0.00s)
    --- PASS: TestEncryption_RoundTrip/Special_characters (0.00s)
    --- PASS: TestEncryption_RoundTrip/Newlines_and_tabs (0.00s)
    --- PASS: TestEncryption_RoundTrip/JSON-like_content (0.00s)
    --- PASS: TestEncryption_RoundTrip/SQL-like_content (0.00s)
    --- PASS: TestEncryption_RoundTrip/Binary-like_content (0.00s)
    --- PASS: TestEncryption_RoundTrip/Repeated_patterns (0.00s)
    --- PASS: TestEncryption_RoundTrip/Mixed_content (0.00s)
=== RUN   TestEncryption_NonDeterministic
--- PASS: TestEncryption_NonDeterministic (0.00s)
=== RUN   TestEncryption_NoKey
=== RUN   TestEncryption_NoKey/#00
=== RUN   TestEncryption_NoKey/Simple_message
=== RUN   TestEncryption_NoKey/Message_with_unicode:_你好
=== RUN   TestEncryption_NoKey/Message_with_special_chars:_!@#$%
--- PASS: TestEncryption_NoKey (0.00s)
    --- PASS: TestEncryption_NoKey/#00 (0.00s)
    --- PASS: TestEncryption_NoKey/Simple_message (0.00s)
    --- PASS: TestEncryption_NoKey/Message_with_unicode:_你好 (0.00s)
    --- PASS: TestEncryption_NoKey/Message_with_special_chars:_!@#$% (0.00s)
=== RUN   TestEncryption_EmptyKey
--- PASS: TestEncryption_EmptyKey (0.00s)
=== RUN   TestEncryption_ConcurrentOperations
--- PASS: TestEncryption_ConcurrentOperations (0.00s)
=== RUN   TestEncryption_LargeData
=== RUN   TestEncryption_LargeData/1KB
=== RUN   TestEncryption_LargeData/10KB
=== RUN   TestEncryption_LargeData/100KB
=== RUN   TestEncryption_LargeData/1MB
--- PASS: TestEncryption_LargeData (0.00s)
    --- PASS: TestEncryption_LargeData/1KB (0.00s)
    --- PASS: TestEncryption_LargeData/10KB (0.00s)
    --- PASS: TestEncryption_LargeData/100KB (0.00s)
    --- PASS: TestEncryption_LargeData/1MB (0.00s)
=== RUN   TestEncryption_KeyRotation
--- PASS: TestEncryption_KeyRotation (0.00s)
=== RUN   TestEncryption_AESGCMProperties
--- PASS: TestEncryption_AESGCMProperties (0.00s)
=== RUN   TestProperty_TransientErrorRetry
--- PASS: TestProperty_TransientErrorRetry (26.33s)
=== RUN   TestProperty_ExponentialBackoff
--- PASS: TestProperty_ExponentialBackoff (1.53s)
=== RUN   TestProperty_NonTransientErrorFailsImmediately
--- PASS: TestProperty_NonTransientErrorFailsImmediately (0.05s)
=== RUN   TestConcurrentSessionCreation
2026-02-17T23:00:16.333+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:00:26.336+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-21]) incomplete read of message header: read tcp [::1]:52349->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-21]) incomplete read of message header: read tcp [::1]:52349->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-21]) incomplete read of message header: read tcp [::1]:52349->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-21]) incomplete read of message header: read tcp [::1]:52349->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestConcurrentSessionCreation (10.00s)
=== RUN   TestConcurrentMessageAddition
2026-02-17T23:00:26.339+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:00:36.341+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-42]) incomplete read of message header: read tcp [::1]:52374->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-42]) incomplete read of message header: read tcp [::1]:52374->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-42]) incomplete read of message header: read tcp [::1]:52374->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-42]) incomplete read of message header: read tcp [::1]:52374->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestConcurrentMessageAddition (10.00s)
=== RUN   TestConcurrentSessionUpdates
2026-02-17T23:00:36.343+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:00:46.343+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-63]) incomplete read of message header: read tcp [::1]:52399->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-63]) incomplete read of message header: read tcp [::1]:52399->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-63]) incomplete read of message header: read tcp [::1]:52399->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-63]) incomplete read of message header: read tcp [::1]:52399->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestConcurrentSessionUpdates (10.00s)
=== RUN   TestConcurrentMixedOperations
2026-02-17T23:00:46.345+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:00:56.344+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-84]) incomplete read of message header: read tcp [::1]:52424->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-84]) incomplete read of message header: read tcp [::1]:52424->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-84]) incomplete read of message header: read tcp [::1]:52424->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-84]) incomplete read of message header: read tcp [::1]:52424->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestConcurrentMixedOperations (10.00s)
=== RUN   TestConcurrentSessionCreationWithEncryption
2026-02-17T23:00:56.346+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:01:06.348+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-105]) incomplete read of message header: read tcp [::1]:52449->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-105]) incomplete read of message header: read tcp [::1]:52449->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-105]) incomplete read of message header: read tcp [::1]:52449->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-105]) incomplete read of message header: read tcp [::1]:52449->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestConcurrentSessionCreationWithEncryption (10.00s)
=== RUN   TestConcurrentListOperations
2026-02-17T23:01:06.349+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:01:16.351+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-126]) incomplete read of message header: read tcp [::1]:52475->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-126]) incomplete read of message header: read tcp [::1]:52475->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-126]) incomplete read of message header: read tcp [::1]:52475->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-126]) incomplete read of message header: read tcp [::1]:52475->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestConcurrentListOperations (10.00s)
=== RUN   TestMongoDBFieldNaming_CreateAndRead
2026-02-17T23:01:16.353+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:01:26.354+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-147]) incomplete read of message header: read tcp [::1]:52508->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-147]) incomplete read of message header: read tcp [::1]:52508->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-147]) incomplete read of message header: read tcp [::1]:52508->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-147]) incomplete read of message header: read tcp [::1]:52508->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_CreateAndRead (10.00s)
=== RUN   TestMongoDBFieldNaming_QueryByUserID
2026-02-17T23:01:26.356+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:01:36.357+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-168]) incomplete read of message header: read tcp [::1]:52536->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-168]) incomplete read of message header: read tcp [::1]:52536->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-168]) incomplete read of message header: read tcp [::1]:52536->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-168]) incomplete read of message header: read tcp [::1]:52536->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_QueryByUserID (10.00s)
=== RUN   TestMongoDBFieldNaming_QueryByStartTime
2026-02-17T23:01:36.359+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:01:46.361+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-189]) incomplete read of message header: read tcp [::1]:52564->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-189]) incomplete read of message header: read tcp [::1]:52564->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-189]) incomplete read of message header: read tcp [::1]:52564->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-189]) incomplete read of message header: read tcp [::1]:52564->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_QueryByStartTime (10.00s)
=== RUN   TestMongoDBFieldNaming_QueryByAdminAssisted
2026-02-17T23:01:46.362+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:01:56.363+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-210]) incomplete read of message header: read tcp [::1]:52596->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-210]) incomplete read of message header: read tcp [::1]:52596->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-210]) incomplete read of message header: read tcp [::1]:52596->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-210]) incomplete read of message header: read tcp [::1]:52596->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_QueryByAdminAssisted (10.00s)
=== RUN   TestMongoDBFieldNaming_QueryByActiveStatus
2026-02-17T23:01:56.365+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:02:06.365+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-231]) incomplete read of message header: read tcp [::1]:52629->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-231]) incomplete read of message header: read tcp [::1]:52629->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-231]) incomplete read of message header: read tcp [::1]:52629->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-231]) incomplete read of message header: read tcp [::1]:52629->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_QueryByActiveStatus (10.00s)
=== RUN   TestMongoDBFieldNaming_SortByStartTime
2026-02-17T23:02:06.366+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:02:16.367+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-251]) incomplete read of message header: read tcp [::1]:52659->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-251]) incomplete read of message header: read tcp [::1]:52659->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-251]) incomplete read of message header: read tcp [::1]:52659->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-251]) incomplete read of message header: read tcp [::1]:52659->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_SortByStartTime (10.00s)
=== RUN   TestMongoDBFieldNaming_SortByTotalTokens
2026-02-17T23:02:16.370+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:02:26.372+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-272]) incomplete read of message header: read tcp [::1]:52682->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-272]) incomplete read of message header: read tcp [::1]:52682->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-272]) incomplete read of message header: read tcp [::1]:52682->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-272]) incomplete read of message header: read tcp [::1]:52682->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_SortByTotalTokens (10.00s)
=== RUN   TestMongoDBFieldNaming_SortByUserID
2026-02-17T23:02:26.373+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:02:36.373+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-293]) incomplete read of message header: read tcp [::1]:52715->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-293]) incomplete read of message header: read tcp [::1]:52715->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-293]) incomplete read of message header: read tcp [::1]:52715->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-293]) incomplete read of message header: read tcp [::1]:52715->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_SortByUserID (10.00s)
=== RUN   TestMongoDBFieldNaming_UpdateSession
2026-02-17T23:02:36.375+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:02:46.377+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-314]) incomplete read of message header: read tcp [::1]:52741->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-314]) incomplete read of message header: read tcp [::1]:52741->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-314]) incomplete read of message header: read tcp [::1]:52741->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-314]) incomplete read of message header: read tcp [::1]:52741->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_UpdateSession (10.00s)
=== RUN   TestMongoDBFieldNaming_AddMessage
2026-02-17T23:02:46.379+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:02:56.381+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-335]) incomplete read of message header: read tcp [::1]:52769->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-335]) incomplete read of message header: read tcp [::1]:52769->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-335]) incomplete read of message header: read tcp [::1]:52769->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-335]) incomplete read of message header: read tcp [::1]:52769->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_AddMessage (10.00s)
=== RUN   TestMongoDBFieldNaming_EndSession
2026-02-17T23:02:56.383+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:03:06.384+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-356]) incomplete read of message header: read tcp [::1]:52793->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-356]) incomplete read of message header: read tcp [::1]:52793->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-356]) incomplete read of message header: read tcp [::1]:52793->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-356]) incomplete read of message header: read tcp [::1]:52793->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_EndSession (10.00s)
=== RUN   TestMongoDBFieldNaming_CombinedOperations
2026-02-17T23:03:06.386+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:03:16.387+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-377]) incomplete read of message header: read tcp [::1]:52819->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-377]) incomplete read of message header: read tcp [::1]:52819->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-377]) incomplete read of message header: read tcp [::1]:52819->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-377]) incomplete read of message header: read tcp [::1]:52819->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestMongoDBFieldNaming_CombinedOperations (10.00s)
=== RUN   TestSortByMessageCount_LargeDataset
=== RUN   TestSortByMessageCount_LargeDataset/1000_sessions_ascending
    storage_large_dataset_test.go:70: Sorted 1000 sessions in 274.5µs
=== RUN   TestSortByMessageCount_LargeDataset/1000_sessions_descending
    storage_large_dataset_test.go:70: Sorted 1000 sessions in 155.417µs
=== RUN   TestSortByMessageCount_LargeDataset/5000_sessions_ascending
    storage_large_dataset_test.go:70: Sorted 5000 sessions in 969.5µs
=== RUN   TestSortByMessageCount_LargeDataset/5000_sessions_descending
    storage_large_dataset_test.go:70: Sorted 5000 sessions in 884.417µs
=== RUN   TestSortByMessageCount_LargeDataset/10000_sessions_ascending
    storage_large_dataset_test.go:70: Sorted 10000 sessions in 1.485083ms
=== RUN   TestSortByMessageCount_LargeDataset/10000_sessions_descending
    storage_large_dataset_test.go:70: Sorted 10000 sessions in 1.253292ms
--- PASS: TestSortByMessageCount_LargeDataset (0.02s)
    --- PASS: TestSortByMessageCount_LargeDataset/1000_sessions_ascending (0.00s)
    --- PASS: TestSortByMessageCount_LargeDataset/1000_sessions_descending (0.00s)
    --- PASS: TestSortByMessageCount_LargeDataset/5000_sessions_ascending (0.01s)
    --- PASS: TestSortByMessageCount_LargeDataset/5000_sessions_descending (0.00s)
    --- PASS: TestSortByMessageCount_LargeDataset/10000_sessions_ascending (0.01s)
    --- PASS: TestSortByMessageCount_LargeDataset/10000_sessions_descending (0.01s)
=== RUN   TestSortByMessageCount_LargeDataset_EdgeCases
=== RUN   TestSortByMessageCount_LargeDataset_EdgeCases/AllSameMessageCount
=== RUN   TestSortByMessageCount_LargeDataset_EdgeCases/AlreadySorted
    storage_large_dataset_test.go:118: Sorted 10000 already-sorted sessions in 34.375µs
=== RUN   TestSortByMessageCount_LargeDataset_EdgeCases/ReverseSorted
    storage_large_dataset_test.go:142: Sorted 10000 reverse-sorted sessions in 46.875µs
=== RUN   TestSortByMessageCount_LargeDataset_EdgeCases/ManyDuplicates
--- PASS: TestSortByMessageCount_LargeDataset_EdgeCases (0.01s)
    --- PASS: TestSortByMessageCount_LargeDataset_EdgeCases/AllSameMessageCount (0.00s)
    --- PASS: TestSortByMessageCount_LargeDataset_EdgeCases/AlreadySorted (0.00s)
    --- PASS: TestSortByMessageCount_LargeDataset_EdgeCases/ReverseSorted (0.00s)
    --- PASS: TestSortByMessageCount_LargeDataset_EdgeCases/ManyDuplicates (0.00s)
=== RUN   TestListAllSessionsWithOptions_LargeDataset_Sorting
2026-02-17T23:03:16.418+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:03:26.420+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-398]) incomplete read of message header: read tcp [::1]:52843->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-398]) incomplete read of message header: read tcp [::1]:52843->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-398]) incomplete read of message header: read tcp [::1]:52843->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-398]) incomplete read of message header: read tcp [::1]:52843->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestListAllSessionsWithOptions_LargeDataset_Sorting (10.00s)
=== RUN   TestSortByMessageCount_StressTest
=== RUN   TestSortByMessageCount_StressTest/Size_10000
    storage_large_dataset_test.go:328: Sorted 10000 sessions in 3.512834ms (0.35 µs per item)
=== RUN   TestSortByMessageCount_StressTest/Size_50000
    storage_large_dataset_test.go:328: Sorted 50000 sessions in 8.019791ms (0.16 µs per item)
=== RUN   TestSortByMessageCount_StressTest/Size_100000
    storage_large_dataset_test.go:328: Sorted 100000 sessions in 11.839125ms (0.12 µs per item)
--- PASS: TestSortByMessageCount_StressTest (0.05s)
    --- PASS: TestSortByMessageCount_StressTest/Size_10000 (0.01s)
    --- PASS: TestSortByMessageCount_StressTest/Size_50000 (0.02s)
    --- PASS: TestSortByMessageCount_StressTest/Size_100000 (0.02s)
=== RUN   TestProductionIssue09_MongoDBRetry
=== RUN   TestProductionIssue09_MongoDBRetry/RetryOnTransientError
    storage_production_test.go:60: VERIFIED: Retry logic successfully retries transient errors
=== RUN   TestProductionIssue09_MongoDBRetry/MaxRetryAttempts
    storage_production_test.go:97: VERIFIED: Retry logic respects max attempts limit
=== RUN   TestProductionIssue09_MongoDBRetry/TimeoutDuration
    storage_production_test.go:113: Operation: AddMessage, Timeout: 5s
    storage_production_test.go:113: Operation: EndSession, Timeout: 5s
    storage_production_test.go:113: Operation: ListSessions, Timeout: 10s
    storage_production_test.go:113: Operation: GetMetrics, Timeout: 30s
    storage_production_test.go:113: Operation: CreateSession, Timeout: 10s
    storage_production_test.go:113: Operation: UpdateSession, Timeout: 5s
    storage_production_test.go:113: Operation: GetSession, Timeout: 5s
    storage_production_test.go:116: VERIFIED: Timeouts are configured for all operations
=== RUN   TestProductionIssue09_MongoDBRetry/NoRetryOnNonRetryableError
    storage_production_test.go:153: VERIFIED: Non-retryable errors fail immediately without retry
=== NAME  TestProductionIssue09_MongoDBRetry
    storage_production_test.go:156: STATUS: MongoDB retry logic is implemented with exponential backoff
    storage_production_test.go:157: FINDING: Operations retry up to 3 times for transient errors
    storage_production_test.go:158: FINDING: Exponential backoff with 100ms initial delay
    storage_production_test.go:159: FINDING: Non-retryable errors fail immediately
--- PASS: TestProductionIssue09_MongoDBRetry (0.41s)
    --- PASS: TestProductionIssue09_MongoDBRetry/RetryOnTransientError (0.10s)
    --- PASS: TestProductionIssue09_MongoDBRetry/MaxRetryAttempts (0.30s)
    --- PASS: TestProductionIssue09_MongoDBRetry/TimeoutDuration (0.00s)
    --- PASS: TestProductionIssue09_MongoDBRetry/NoRetryOnNonRetryableError (0.00s)
=== RUN   TestProductionIssue10_SerializationDataRace
    storage_production_test.go:231: STATUS: No data race detected with proper locking
    storage_production_test.go:232: FINDING: sessionToDocument now acquires session.RLock() before reading fields
    storage_production_test.go:233: FINDING: Concurrent modifications use session.Lock() for writes
    storage_production_test.go:234: IMPACT: Thread-safe serialization - no data corruption risk
    storage_production_test.go:235: 
    storage_production_test.go:236: FIXED LOCKING BEHAVIOR:
    storage_production_test.go:237:   - Session struct has mu sync.RWMutex for field protection
    storage_production_test.go:238:   - SessionManager methods use session.Lock() for updates
    storage_production_test.go:239:   - sessionToDocument() now acquires session.RLock() before reading fields
    storage_production_test.go:240:   - External packages can use sess.Lock()/RLock() for thread-safe access
    storage_production_test.go:241: 
    storage_production_test.go:242: RECOMMENDATION: Always use Lock()/RLock() when accessing session fields from multiple goroutines
--- PASS: TestProductionIssue10_SerializationDataRace (0.00s)
=== RUN   TestProductionIssue10_SerializationAccuracy
=== RUN   TestProductionIssue10_SerializationAccuracy/BasicFieldConversion
    storage_production_test.go:329: VERIFIED: All session fields are correctly converted to document format
=== RUN   TestProductionIssue10_SerializationAccuracy/ConcurrentModifications
    storage_production_test.go:430: Successful serializations: 5/5
    storage_production_test.go:438: STATUS: No data races or panics with proper locking
    storage_production_test.go:439: FINDING: sessionToDocument now acquires session.RLock() before reading fields
    storage_production_test.go:440: FINDING: Concurrent modifications use session.Lock() for writes
    storage_production_test.go:441: IMPACT: Thread-safe serialization - no crashes or data corruption
    storage_production_test.go:442: RECOMMENDATION: Always use Lock()/RLock() when accessing session fields from multiple goroutines
=== RUN   TestProductionIssue10_SerializationAccuracy/EmptyResponseTimes
    storage_production_test.go:476: VERIFIED: Empty response times are handled correctly
=== RUN   TestProductionIssue10_SerializationAccuracy/NilEndTime
    storage_production_test.go:512: VERIFIED: Nil end time is handled correctly, duration calculated from current time
=== NAME  TestProductionIssue10_SerializationAccuracy
    storage_production_test.go:515: STATUS: Session serialization accuracy is verified
    storage_production_test.go:516: FINDING: All fields are correctly converted to document format
    storage_production_test.go:517: FINDING: Concurrent modifications are now properly synchronized with locking
    storage_production_test.go:518: RECOMMENDATION: Thread-safe serialization is now implemented and working correctly
--- PASS: TestProductionIssue10_SerializationAccuracy (0.00s)
    --- PASS: TestProductionIssue10_SerializationAccuracy/BasicFieldConversion (0.00s)
    --- PASS: TestProductionIssue10_SerializationAccuracy/ConcurrentModifications (0.00s)
    --- PASS: TestProductionIssue10_SerializationAccuracy/EmptyResponseTimes (0.00s)
    --- PASS: TestProductionIssue10_SerializationAccuracy/NilEndTime (0.00s)
=== RUN   TestProperty_SessionCreationAndPersistence
2026-02-17T23:03:26.887+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:03:36.889+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-419]) incomplete read of message header: read tcp [::1]:52866->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-419]) incomplete read of message header: read tcp [::1]:52866->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-419]) incomplete read of message header: read tcp [::1]:52866->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-419]) incomplete read of message header: read tcp [::1]:52866->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestProperty_SessionCreationAndPersistence (10.00s)
=== RUN   TestProperty_MessagePersistence
2026-02-17T23:03:36.891+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:03:46.892+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-440]) incomplete read of message header: read tcp [::1]:52890->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-440]) incomplete read of message header: read tcp [::1]:52890->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-440]) incomplete read of message header: read tcp [::1]:52890->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-440]) incomplete read of message header: read tcp [::1]:52890->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestProperty_MessagePersistence (10.00s)
=== RUN   TestProperty_ConversationHistoryRetrieval
2026-02-17T23:03:46.896+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:03:56.897+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-461]) incomplete read of message header: read tcp [::1]:52917->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-461]) incomplete read of message header: read tcp [::1]:52917->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-461]) incomplete read of message header: read tcp [::1]:52917->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-461]) incomplete read of message header: read tcp [::1]:52917->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestProperty_ConversationHistoryRetrieval (10.00s)
=== RUN   TestProperty_SessionLifecycleTracking
2026-02-17T23:03:56.901+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:04:06.902+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-482]) incomplete read of message header: read tcp [::1]:52946->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-482]) incomplete read of message header: read tcp [::1]:52946->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-482]) incomplete read of message header: read tcp [::1]:52946->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-482]) incomplete read of message header: read tcp [::1]:52946->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestProperty_SessionLifecycleTracking (10.00s)
=== RUN   TestProperty_DataEncryptionAtRest
2026-02-17T23:04:06.904+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:04:16.905+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-503]) incomplete read of message header: read tcp [::1]:52973->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-503]) incomplete read of message header: read tcp [::1]:52973->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-503]) incomplete read of message header: read tcp [::1]:52973->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-503]) incomplete read of message header: read tcp [::1]:52973->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestProperty_DataEncryptionAtRest (10.00s)
=== RUN   TestProperty_SessionListOrdering
2026-02-17T23:04:16.906+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:04:26.907+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-524]) incomplete read of message header: read tcp [::1]:52999->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-524]) incomplete read of message header: read tcp [::1]:52999->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-524]) incomplete read of message header: read tcp [::1]:52999->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-524]) incomplete read of message header: read tcp [::1]:52999->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestProperty_SessionListOrdering (10.00s)
=== RUN   TestNewStorageService
2026-02-17T23:04:26.913+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:04:36.914+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-545]) incomplete read of message header: read tcp [::1]:53021->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-545]) incomplete read of message header: read tcp [::1]:53021->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-545]) incomplete read of message header: read tcp [::1]:53021->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-545]) incomplete read of message header: read tcp [::1]:53021->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestNewStorageService (10.01s)
=== RUN   TestCreateSession_ValidSession
2026-02-17T23:04:36.916+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:04:46.917+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-566]) incomplete read of message header: read tcp [::1]:53046->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-566]) incomplete read of message header: read tcp [::1]:53046->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-566]) incomplete read of message header: read tcp [::1]:53046->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-566]) incomplete read of message header: read tcp [::1]:53046->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestCreateSession_ValidSession (10.00s)
=== RUN   TestCreateSession_NilSession
2026-02-17T23:04:46.919+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:04:56.919+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-587]) incomplete read of message header: read tcp [::1]:53073->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-587]) incomplete read of message header: read tcp [::1]:53073->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-587]) incomplete read of message header: read tcp [::1]:53073->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-587]) incomplete read of message header: read tcp [::1]:53073->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestCreateSession_NilSession (10.00s)
=== RUN   TestCreateSession_EmptySessionID
2026-02-17T23:04:56.921+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:05:06.921+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-608]) incomplete read of message header: read tcp [::1]:53096->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-608]) incomplete read of message header: read tcp [::1]:53096->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-608]) incomplete read of message header: read tcp [::1]:53096->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-608]) incomplete read of message header: read tcp [::1]:53096->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestCreateSession_EmptySessionID (10.00s)
=== RUN   TestUpdateSession_ValidSession
2026-02-17T23:05:06.923+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:05:16.925+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-628]) incomplete read of message header: read tcp [::1]:53121->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-628]) incomplete read of message header: read tcp [::1]:53121->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-628]) incomplete read of message header: read tcp [::1]:53121->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-628]) incomplete read of message header: read tcp [::1]:53121->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestUpdateSession_ValidSession (10.00s)
=== RUN   TestUpdateSession_NonExistentSession
2026-02-17T23:05:16.927+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:05:26.928+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-649]) incomplete read of message header: read tcp [::1]:53146->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-649]) incomplete read of message header: read tcp [::1]:53146->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-649]) incomplete read of message header: read tcp [::1]:53146->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-649]) incomplete read of message header: read tcp [::1]:53146->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestUpdateSession_NonExistentSession (10.00s)
=== RUN   TestGetSession_ValidSession
2026-02-17T23:05:26.930+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:05:36.932+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-670]) incomplete read of message header: read tcp [::1]:53171->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-670]) incomplete read of message header: read tcp [::1]:53171->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-670]) incomplete read of message header: read tcp [::1]:53171->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-670]) incomplete read of message header: read tcp [::1]:53171->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetSession_ValidSession (10.00s)
=== RUN   TestGetSession_NonExistentSession
2026-02-17T23:05:36.934+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:05:46.934+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-691]) incomplete read of message header: read tcp [::1]:53193->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-691]) incomplete read of message header: read tcp [::1]:53193->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-691]) incomplete read of message header: read tcp [::1]:53193->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-691]) incomplete read of message header: read tcp [::1]:53193->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetSession_NonExistentSession (10.00s)
=== RUN   TestGetSession_EmptySessionID
2026-02-17T23:05:46.936+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:05:56.936+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-712]) incomplete read of message header: read tcp [::1]:53219->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-712]) incomplete read of message header: read tcp [::1]:53219->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-712]) incomplete read of message header: read tcp [::1]:53219->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-712]) incomplete read of message header: read tcp [::1]:53219->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetSession_EmptySessionID (10.00s)
=== RUN   TestSessionToDocument_WithMessages
2026-02-17T23:05:56.939+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:06:06.940+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-733]) incomplete read of message header: read tcp [::1]:53244->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-733]) incomplete read of message header: read tcp [::1]:53244->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-733]) incomplete read of message header: read tcp [::1]:53244->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-733]) incomplete read of message header: read tcp [::1]:53244->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestSessionToDocument_WithMessages (10.00s)
=== RUN   TestSessionToDocument_WithEndTime
2026-02-17T23:06:06.942+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:06:16.943+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-754]) incomplete read of message header: read tcp [::1]:53268->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-754]) incomplete read of message header: read tcp [::1]:53268->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-754]) incomplete read of message header: read tcp [::1]:53268->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-754]) incomplete read of message header: read tcp [::1]:53268->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestSessionToDocument_WithEndTime (10.00s)
=== RUN   TestSessionToDocument_Conversion
--- PASS: TestSessionToDocument_Conversion (0.00s)
=== RUN   TestDocumentToSession_Conversion
--- PASS: TestDocumentToSession_Conversion (0.00s)
=== RUN   TestSessionToDocument_EmptyMessages
--- PASS: TestSessionToDocument_EmptyMessages (0.00s)
=== RUN   TestSessionToDocument_ActiveSession
--- PASS: TestSessionToDocument_ActiveSession (0.00s)
=== RUN   TestDocumentToSession_ActiveSession
--- PASS: TestDocumentToSession_ActiveSession (0.00s)
=== RUN   TestDocumentToSession_NoResponseTimes
--- PASS: TestDocumentToSession_NoResponseTimes (0.00s)
=== RUN   TestAdminNameRoundTrip
--- PASS: TestAdminNameRoundTrip (0.00s)
=== RUN   TestAddMessage_ValidMessage
2026-02-17T23:06:16.945+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:06:26.946+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-775]) incomplete read of message header: read tcp [::1]:53292->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-775]) incomplete read of message header: read tcp [::1]:53292->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-775]) incomplete read of message header: read tcp [::1]:53292->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-775]) incomplete read of message header: read tcp [::1]:53292->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestAddMessage_ValidMessage (10.00s)
=== RUN   TestAddMessage_WithEncryption
2026-02-17T23:06:26.948+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:06:36.951+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-796]) incomplete read of message header: read tcp [::1]:53318->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-796]) incomplete read of message header: read tcp [::1]:53318->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-796]) incomplete read of message header: read tcp [::1]:53318->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-796]) incomplete read of message header: read tcp [::1]:53318->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestAddMessage_WithEncryption (10.00s)
=== RUN   TestAddMessage_NonExistentSession
2026-02-17T23:06:36.953+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:06:46.955+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-817]) incomplete read of message header: read tcp [::1]:53348->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-817]) incomplete read of message header: read tcp [::1]:53348->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-817]) incomplete read of message header: read tcp [::1]:53348->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-817]) incomplete read of message header: read tcp [::1]:53348->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestAddMessage_NonExistentSession (10.00s)
=== RUN   TestAddMessage_EmptySessionID
2026-02-17T23:06:46.957+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:06:56.959+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-838]) incomplete read of message header: read tcp [::1]:53372->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-838]) incomplete read of message header: read tcp [::1]:53372->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-838]) incomplete read of message header: read tcp [::1]:53372->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-838]) incomplete read of message header: read tcp [::1]:53372->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestAddMessage_EmptySessionID (10.00s)
=== RUN   TestAddMessage_NilMessage
2026-02-17T23:06:56.960+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:07:06.961+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-859]) incomplete read of message header: read tcp [::1]:53397->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-859]) incomplete read of message header: read tcp [::1]:53397->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-859]) incomplete read of message header: read tcp [::1]:53397->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-859]) incomplete read of message header: read tcp [::1]:53397->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestAddMessage_NilMessage (10.00s)
=== RUN   TestEndSession_ValidSession
2026-02-17T23:07:06.965+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:07:16.966+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-880]) incomplete read of message header: read tcp [::1]:53423->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-880]) incomplete read of message header: read tcp [::1]:53423->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-880]) incomplete read of message header: read tcp [::1]:53423->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-880]) incomplete read of message header: read tcp [::1]:53423->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestEndSession_ValidSession (10.01s)
=== RUN   TestEndSession_NonExistentSession
2026-02-17T23:07:16.971+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:07:26.973+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-901]) incomplete read of message header: read tcp [::1]:53450->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-901]) incomplete read of message header: read tcp [::1]:53450->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-901]) incomplete read of message header: read tcp [::1]:53450->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-901]) incomplete read of message header: read tcp [::1]:53450->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestEndSession_NonExistentSession (10.00s)
=== RUN   TestEndSession_EmptySessionID
2026-02-17T23:07:26.974+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:07:36.975+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-922]) incomplete read of message header: read tcp [::1]:53475->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-922]) incomplete read of message header: read tcp [::1]:53475->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-922]) incomplete read of message header: read tcp [::1]:53475->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-922]) incomplete read of message header: read tcp [::1]:53475->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestEndSession_EmptySessionID (10.00s)
=== RUN   TestEncryptDecrypt_RoundTrip
--- PASS: TestEncryptDecrypt_RoundTrip (0.00s)
=== RUN   TestEncrypt_NoKey
--- PASS: TestEncrypt_NoKey (0.00s)
=== RUN   TestDecrypt_NoKey
--- PASS: TestDecrypt_NoKey (0.00s)
=== RUN   TestEncrypt_EmptyString
--- PASS: TestEncrypt_EmptyString (0.00s)
=== RUN   TestDecrypt_InvalidCiphertext
--- PASS: TestDecrypt_InvalidCiphertext (0.00s)
=== RUN   TestDecrypt_TooShortCiphertext
--- PASS: TestDecrypt_TooShortCiphertext (0.00s)
=== RUN   TestEncrypt_LongText
--- PASS: TestEncrypt_LongText (0.00s)
=== RUN   TestListUserSessions_ValidUser
2026-02-17T23:07:36.977+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:07:46.978+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-943]) incomplete read of message header: read tcp [::1]:53501->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-943]) incomplete read of message header: read tcp [::1]:53501->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-943]) incomplete read of message header: read tcp [::1]:53501->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-943]) incomplete read of message header: read tcp [::1]:53501->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestListUserSessions_ValidUser (10.00s)
=== RUN   TestListUserSessions_WithLimit
2026-02-17T23:07:46.980+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:07:56.981+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-964]) incomplete read of message header: read tcp [::1]:53579->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-964]) incomplete read of message header: read tcp [::1]:53579->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-964]) incomplete read of message header: read tcp [::1]:53579->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-964]) incomplete read of message header: read tcp [::1]:53579->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestListUserSessions_WithLimit (10.00s)
=== RUN   TestListUserSessions_EmptyUserID
2026-02-17T23:07:56.985+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:08:06.985+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-985]) incomplete read of message header: read tcp [::1]:53683->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-985]) incomplete read of message header: read tcp [::1]:53683->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-985]) incomplete read of message header: read tcp [::1]:53683->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-985]) incomplete read of message header: read tcp [::1]:53683->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestListUserSessions_EmptyUserID (10.00s)
=== RUN   TestListUserSessions_NoSessions
2026-02-17T23:08:06.988+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:08:16.990+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1006]) incomplete read of message header: read tcp [::1]:53771->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1006]) incomplete read of message header: read tcp [::1]:53771->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1006]) incomplete read of message header: read tcp [::1]:53771->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1006]) incomplete read of message header: read tcp [::1]:53771->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestListUserSessions_NoSessions (10.00s)
=== RUN   TestListUserSessions_LastMessageTime
2026-02-17T23:08:16.992+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:08:26.993+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1027]) incomplete read of message header: read tcp [::1]:53796->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1027]) incomplete read of message header: read tcp [::1]:53796->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1027]) incomplete read of message header: read tcp [::1]:53796->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1027]) incomplete read of message header: read tcp [::1]:53796->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestListUserSessions_LastMessageTime (10.00s)
=== RUN   TestGetSessionMetrics_ValidTimeRange
2026-02-17T23:08:26.995+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:08:36.997+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1048]) incomplete read of message header: read tcp [::1]:53823->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1048]) incomplete read of message header: read tcp [::1]:53823->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1048]) incomplete read of message header: read tcp [::1]:53823->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1048]) incomplete read of message header: read tcp [::1]:53823->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetSessionMetrics_ValidTimeRange (10.00s)
=== RUN   TestGetSessionMetrics_EmptyTimeRange
2026-02-17T23:08:36.999+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:08:47.001+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1069]) incomplete read of message header: read tcp [::1]:53848->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1069]) incomplete read of message header: read tcp [::1]:53848->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1069]) incomplete read of message header: read tcp [::1]:53848->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1069]) incomplete read of message header: read tcp [::1]:53848->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetSessionMetrics_EmptyTimeRange (10.00s)
=== RUN   TestGetSessionMetrics_InvalidTimeRange
2026-02-17T23:08:47.003+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:08:57.003+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1090]) incomplete read of message header: read tcp [::1]:53873->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1090]) incomplete read of message header: read tcp [::1]:53873->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1090]) incomplete read of message header: read tcp [::1]:53873->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1090]) incomplete read of message header: read tcp [::1]:53873->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetSessionMetrics_InvalidTimeRange (10.00s)
=== RUN   TestGetSessionMetrics_ConcurrentSessions
2026-02-17T23:08:57.006+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:09:07.008+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1111]) incomplete read of message header: read tcp [::1]:53896->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1111]) incomplete read of message header: read tcp [::1]:53896->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1111]) incomplete read of message header: read tcp [::1]:53896->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1111]) incomplete read of message header: read tcp [::1]:53896->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetSessionMetrics_ConcurrentSessions (10.01s)
=== RUN   TestGetTokenUsage_ValidTimeRange
2026-02-17T23:09:07.010+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:09:17.012+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1132]) incomplete read of message header: read tcp [::1]:53921->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1132]) incomplete read of message header: read tcp [::1]:53921->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1132]) incomplete read of message header: read tcp [::1]:53921->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1132]) incomplete read of message header: read tcp [::1]:53921->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetTokenUsage_ValidTimeRange (10.00s)
=== RUN   TestGetTokenUsage_EmptyTimeRange
2026-02-17T23:09:17.014+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:09:27.015+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1153]) incomplete read of message header: read tcp [::1]:53944->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1153]) incomplete read of message header: read tcp [::1]:53944->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1153]) incomplete read of message header: read tcp [::1]:53944->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1153]) incomplete read of message header: read tcp [::1]:53944->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetTokenUsage_EmptyTimeRange (10.00s)
=== RUN   TestGetTokenUsage_InvalidTimeRange
2026-02-17T23:09:27.017+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:09:37.018+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1174]) incomplete read of message header: read tcp [::1]:53971->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1174]) incomplete read of message header: read tcp [::1]:53971->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1174]) incomplete read of message header: read tcp [::1]:53971->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1174]) incomplete read of message header: read tcp [::1]:53971->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetTokenUsage_InvalidTimeRange (10.00s)
=== RUN   TestGetTokenUsage_PartialTimeRange
2026-02-17T23:09:37.020+07:00 level=INFO msg=verboseLevel, verboseLevel=1
2026-02-17T23:09:47.021+07:00 level=ERROR msg=failed to ping MongoDB, dbName="test_chat_db", error=server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1195]) incomplete read of message header: read tcp [::1]:53998->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1195]) incomplete read of message header: read tcp [::1]:53998->[::1]:27017: read: connection reset by peer }, ] }, file="mongodb.go:303"
    storage_test.go:91: Skipping MongoDB tests: failed to initialize gomongo: server selection error: context deadline exceeded, current topology: { Type: Unknown, Servers: [{ Addr: localhost:27017, Type: Unknown, Last error:  connection(localhost:27017[-1195]) incomplete read of message header: read tcp [::1]:53998->[::1]:27017: read: connection reset by peer: connection(localhost:27017[-1195]) incomplete read of message header: read tcp [::1]:53998->[::1]:27017: read: connection reset by peer }, ] }
--- SKIP: TestGetTokenUsage_PartialTimeRange (10.00s)
=== RUN   TestListAllSessionsWithOptions_Pagination
2026-02-17T23:09:47.022+07:00 level=INFO msg=verboseLevel, verboseLevel=1
panic: test timed out after 10m0s
	running tests:
		TestListAllSessionsWithOptions_Pagination (1s)

goroutine 7778 [running]:
testing.(*M).startAlarm.func1()
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:2682 +0x2b0
created by time.goFunc
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/time/sleep.go:215 +0x38

goroutine 1 [chan receive]:
testing.(*T).Run(0x140001cd340, {0x100d28038?, 0x1400019bb38?}, 0x100f32fc8)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:2005 +0x378
testing.runTests.func1(0x140001cd340)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:2477 +0x38
testing.tRunner(0x140001cd340, 0x1400019bc68)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:1934 +0xc8
testing.runTests(0x140000107c8, {0x101330d40, 0x7f, 0x7f}, {0x140000c75c0?, 0x7?, 0x101336680?})
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:2475 +0x3b8
testing.(*M).Run(0x1400028e0a0)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:2337 +0x530
main.main()
	_testmain.go:303 +0x80

goroutine 7737 [select]:
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*Topology).selectServerFromSubscription(0x140003aa000, {0x100f3f2a8, 0x140003a2420}, 0x140004f7960, {{0x100f3b740?, 0x140003a23c0?}, 0x140004f7880?})
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/topology.go:741 +0x224
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*Topology).SelectServer(0x140003aa000, {0x100f3f2a8, 0x140003a2420}, {0x100f3b740, 0x140003a23c0})
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/topology.go:589 +0x294
go.mongodb.org/mongo-driver/x/mongo/driver.Operation.selectServer({0x1400036ee80, {0x100d0b3cb, 0x5}, {0x100f3d050, 0x140003aa000}, 0x1400036ee90, {0x100f3ad00, 0x14000011938}, 0x140003a20c0, 0x0, ...}, ...)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/operation.go:425 +0x39c
go.mongodb.org/mongo-driver/x/mongo/driver.Operation.getServerAndConnection({0x1400036ee80, {0x100d0b3cb, 0x5}, {0x100f3d050, 0x140003aa000}, 0x1400036ee90, {0x100f3ad00, 0x14000011938}, 0x140003a20c0, 0x0, ...}, ...)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/operation.go:434 +0x54
go.mongodb.org/mongo-driver/x/mongo/driver.Operation.Execute({0x1400036ee80, {0x100d0b3cb, 0x5}, {0x100f3d050, 0x140003aa000}, 0x1400036ee90, {0x100f3ad00, 0x14000011938}, 0x140003a20c0, 0x0, ...}, ...)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/operation.go:639 +0x5b4
go.mongodb.org/mongo-driver/x/mongo/driver/operation.(*Command).Execute(0x14000414140, {0x100f3f350, 0x140004f7730})
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/operation/command.go:112 +0x16c
go.mongodb.org/mongo-driver/mongo.(*Database).RunCommand(0x14000303bc0, {0x100f3f350?, 0x140004f7730?}, {0x100e6e900?, 0x14000011920?}, {0x14000125450?, 0x10?, 0x100e4d0c0?})
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/mongo/database.go:224 +0x10c
go.mongodb.org/mongo-driver/mongo.(*Client).Ping(0x140000118a8?, {0x100f3f350?, 0x140004f7730?}, 0x100f37cb0?)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/mongo/client.go:375 +0x118
github.com/real-rm/gomongo.InitMongoDB(0x140000118a8, 0x14000216298)
	/Users/fx/go/pkg/mod/github.com/real-rm/gomongo@v0.2.0/mongodb.go:301 +0x10a8
github.com/real-rm/chatbox/internal/storage.setupTestMongoDB(0x14000402fc0)
	/Users/fx/work/chatbox/internal/storage/storage_test.go:89 +0x3cc
github.com/real-rm/chatbox/internal/storage.TestListAllSessionsWithOptions_Pagination(0x14000402fc0)
	/Users/fx/work/chatbox/internal/storage/storage_test.go:1358 +0x30
testing.tRunner(0x14000402fc0, 0x100f32fc8)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:1934 +0xc8
created by testing.(*T).Run in goroutine 1
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/testing/testing.go:1997 +0x364

goroutine 7741 [select]:
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*Server).update.func2(...)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/server.go:584
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*Server).update(0x140003147e0)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/server.go:675 +0x68c
created by go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*Server).Connect in goroutine 7737
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/server.go:252 +0x16c

goroutine 7738 [sync.Cond.Wait]:
sync.runtime_notifyListWait(0x14000226790, 0x1)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/runtime/sema.go:606 +0x140
sync.(*Cond).Wait(0x14000226780)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/sync/cond.go:71 +0xa4
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*pool).createConnections.func2()
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:1165 +0x9c
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*pool).createConnections(0x14000316480, {0x100f3f2e0, 0x14000384f50}, 0xffffffffffffffff?)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:1187 +0xa0
created by go.mongodb.org/mongo-driver/x/mongo/driver/topology.newPool in goroutine 7737
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:243 +0x5bc

goroutine 7739 [sync.Cond.Wait]:
sync.runtime_notifyListWait(0x14000226790, 0x0)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/runtime/sema.go:606 +0x140
sync.(*Cond).Wait(0x14000226780)
	/opt/homebrew/Cellar/go/1.25.6/libexec/src/sync/cond.go:71 +0xa4
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*pool).createConnections.func2()
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:1165 +0x9c
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*pool).createConnections(0x14000316480, {0x100f3f2e0, 0x14000384f50}, 0x100f32f58?)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:1187 +0xa0
created by go.mongodb.org/mongo-driver/x/mongo/driver/topology.newPool in goroutine 7737
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:243 +0x5bc

goroutine 7740 [select]:
go.mongodb.org/mongo-driver/x/mongo/driver/topology.(*pool).maintain(0x14000316480, {0x100f3f2e0, 0x14000384f50}, 0xffffffffffffffff?)
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:1299 +0x168
created by go.mongodb.org/mongo-driver/x/mongo/driver/topology.newPool in goroutine 7737
	/Users/fx/go/pkg/mod/go.mongodb.org/mongo-driver@v1.17.9/x/mongo/driver/topology/pool.go:250 +0x6c8
FAIL	github.com/real-rm/chatbox/internal/storage	606.663s
=== RUN   TestMockStorageService
=== RUN   TestMockStorageService/CreateSession_tracking
=== RUN   TestMockStorageService/CreateSession_with_error
=== RUN   TestMockStorageService/Reset_clears_tracking
--- PASS: TestMockStorageService (0.00s)
    --- PASS: TestMockStorageService/CreateSession_tracking (0.00s)
    --- PASS: TestMockStorageService/CreateSession_with_error (0.00s)
    --- PASS: TestMockStorageService/Reset_clears_tracking (0.00s)
=== RUN   TestMockLLMService
=== RUN   TestMockLLMService/StreamMessage_tracking
=== RUN   TestMockLLMService/SendMessage_tracking
=== RUN   TestMockLLMService/Reset_clears_tracking
--- PASS: TestMockLLMService (0.00s)
    --- PASS: TestMockLLMService/StreamMessage_tracking (0.00s)
    --- PASS: TestMockLLMService/SendMessage_tracking (0.00s)
    --- PASS: TestMockLLMService/Reset_clears_tracking (0.00s)
=== RUN   TestMockConnection
=== RUN   TestMockConnection/creates_connection_with_defaults
=== RUN   TestMockConnection/creates_connection_with_custom_roles
--- PASS: TestMockConnection (0.00s)
    --- PASS: TestMockConnection/creates_connection_with_defaults (0.00s)
    --- PASS: TestMockConnection/creates_connection_with_custom_roles (0.00s)
=== RUN   TestCreateTestSession
=== RUN   TestCreateTestSession/creates_session_with_defaults
=== RUN   TestCreateTestSession/creates_session_with_custom_ID
--- PASS: TestCreateTestSession (0.00s)
    --- PASS: TestCreateTestSession/creates_session_with_defaults (0.00s)
    --- PASS: TestCreateTestSession/creates_session_with_custom_ID (0.00s)
=== RUN   TestCreateTestSessionWithMessages
--- PASS: TestCreateTestSessionWithMessages (0.00s)
=== RUN   TestAssertMemoryGrowth
    helpers_test.go:178: Memory growth (test allocation): -39608 bytes (-0.04 MB)
--- PASS: TestAssertMemoryGrowth (0.00s)
=== RUN   TestAssertGoroutineCount
    helpers_test.go:199: Goroutine count (test goroutine): 2 → 2 (delta: 0)
    helpers_test.go:199:   ✓ Goroutine count stable (within tolerance of ±5)
--- PASS: TestAssertGoroutineCount (0.11s)
=== RUN   TestAssertNoDataRace
    helpers_test.go:205: Data race check: test data race check
    helpers_test.go:205: NOTE: Run with 'go test -race' to detect data races
--- PASS: TestAssertNoDataRace (0.00s)
=== RUN   TestMeasureMemory
--- PASS: TestMeasureMemory (0.00s)
=== RUN   TestMeasureGoroutines
--- PASS: TestMeasureGoroutines (0.00s)
=== RUN   TestWaitForGoroutines
--- PASS: TestWaitForGoroutines (0.10s)
=== RUN   TestConcurrentMockAccess
=== RUN   TestConcurrentMockAccess/MockStorageService_concurrent_access
=== RUN   TestConcurrentMockAccess/MockLLMService_concurrent_access
--- PASS: TestConcurrentMockAccess (0.00s)
    --- PASS: TestConcurrentMockAccess/MockStorageService_concurrent_access (0.00s)
    --- PASS: TestConcurrentMockAccess/MockLLMService_concurrent_access (0.00s)
=== RUN   TestExample_MockStorageService_sessionCreation
--- PASS: TestExample_MockStorageService_sessionCreation (0.00s)
=== RUN   TestExample_MockStorageService_errorInjection
--- PASS: TestExample_MockStorageService_errorInjection (0.00s)
=== RUN   TestExample_MemoryGrowth_sessionAccumulation
    example_usage_test.go:68: Memory growth (1000 sessions with 10 messages each): -3016 bytes (-0.00 MB)
--- PASS: TestExample_MemoryGrowth_sessionAccumulation (0.00s)
=== RUN   TestExample_GoroutineCount_connectionCleanup
    example_usage_test.go:94: Goroutine count (connection cleanup): 2 → 2 (delta: 0)
    example_usage_test.go:94:   ✓ Goroutine count stable (within tolerance of ±5)
--- PASS: TestExample_GoroutineCount_connectionCleanup (0.11s)
=== RUN   TestExample_DataRace_concurrentSessionAccess
    example_usage_test.go:100: Data race check: concurrent session field access
    example_usage_test.go:100: NOTE: Run with 'go test -race' to detect data races
--- PASS: TestExample_DataRace_concurrentSessionAccess (0.00s)
=== RUN   TestExample_MockLLMService_streaming
--- PASS: TestExample_MockLLMService_streaming (0.00s)
=== RUN   TestExample_MockConnection_creation
--- PASS: TestExample_MockConnection_creation (0.00s)
=== RUN   TestExample_MockReset_reusingMocks
--- PASS: TestExample_MockReset_reusingMocks (0.00s)
=== RUN   TestAllExamples
=== RUN   TestAllExamples/Example_1:_Session_Creation
=== RUN   TestAllExamples/Example_2:_Error_Injection
=== RUN   TestAllExamples/Example_3:_Memory_Growth
    example_usage_test.go:68: Memory growth (1000 sessions with 10 messages each): -2984 bytes (-0.00 MB)
=== RUN   TestAllExamples/Example_4:_Goroutine_Count
    example_usage_test.go:94: Goroutine count (connection cleanup): 3 → 3 (delta: 0)
    example_usage_test.go:94:   ✓ Goroutine count stable (within tolerance of ±5)
=== RUN   TestAllExamples/Example_5:_Data_Race
    example_usage_test.go:100: Data race check: concurrent session field access
    example_usage_test.go:100: NOTE: Run with 'go test -race' to detect data races
=== RUN   TestAllExamples/Example_6:_LLM_Streaming
=== RUN   TestAllExamples/Example_7:_Mock_Connection
=== RUN   TestAllExamples/Example_8:_Mock_Reset
--- PASS: TestAllExamples (0.12s)
    --- PASS: TestAllExamples/Example_1:_Session_Creation (0.00s)
    --- PASS: TestAllExamples/Example_2:_Error_Injection (0.00s)
    --- PASS: TestAllExamples/Example_3:_Memory_Growth (0.00s)
    --- PASS: TestAllExamples/Example_4:_Goroutine_Count (0.11s)
    --- PASS: TestAllExamples/Example_5:_Data_Race (0.00s)
    --- PASS: TestAllExamples/Example_6:_LLM_Streaming (0.00s)
    --- PASS: TestAllExamples/Example_7:_Mock_Connection (0.00s)
    --- PASS: TestAllExamples/Example_8:_Mock_Reset (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/testutil	8.197s
=== RUN   TestNewUploadService
=== RUN   TestNewUploadService/empty_site
=== RUN   TestNewUploadService/empty_entry_name
=== RUN   TestNewUploadService/nil_stats_collection
--- PASS: TestNewUploadService (0.00s)
    --- PASS: TestNewUploadService/empty_site (0.00s)
    --- PASS: TestNewUploadService/empty_entry_name (0.00s)
    --- PASS: TestNewUploadService/nil_stats_collection (0.00s)
=== RUN   TestUploadService_UploadFile_Validation
=== RUN   TestUploadService_UploadFile_Validation/nil_file
=== RUN   TestUploadService_UploadFile_Validation/empty_filename
=== RUN   TestUploadService_UploadFile_Validation/empty_user_ID
--- PASS: TestUploadService_UploadFile_Validation (0.00s)
    --- PASS: TestUploadService_UploadFile_Validation/nil_file (0.00s)
    --- PASS: TestUploadService_UploadFile_Validation/empty_filename (0.00s)
    --- PASS: TestUploadService_UploadFile_Validation/empty_user_ID (0.00s)
=== RUN   TestUploadService_GenerateSignedURL_Validation
=== RUN   TestUploadService_GenerateSignedURL_Validation/empty_file_ID
=== RUN   TestUploadService_GenerateSignedURL_Validation/valid_file_ID
--- PASS: TestUploadService_GenerateSignedURL_Validation (0.00s)
    --- PASS: TestUploadService_GenerateSignedURL_Validation/empty_file_ID (0.00s)
    --- PASS: TestUploadService_GenerateSignedURL_Validation/valid_file_ID (0.00s)
=== RUN   TestUploadService_DownloadFile_Validation
=== RUN   TestUploadService_DownloadFile_Validation/empty_file_path
--- PASS: TestUploadService_DownloadFile_Validation (0.00s)
    --- PASS: TestUploadService_DownloadFile_Validation/empty_file_path (0.00s)
=== RUN   TestUploadService_DeleteFile_Validation
=== RUN   TestUploadService_DeleteFile_Validation/empty_file_ID
--- PASS: TestUploadService_DeleteFile_Validation (0.00s)
    --- PASS: TestUploadService_DeleteFile_Validation/empty_file_ID (0.00s)
=== RUN   TestUploadResult_Structure
--- PASS: TestUploadResult_Structure (0.00s)
=== RUN   TestUploadService_ContextCancellation
--- PASS: TestUploadService_ContextCancellation (0.00s)
=== RUN   TestUploadService_ValidateFile_Size
=== RUN   TestUploadService_ValidateFile_Size/file_within_size_limit
=== RUN   TestUploadService_ValidateFile_Size/file_exceeds_size_limit
=== RUN   TestUploadService_ValidateFile_Size/file_at_exact_size_limit
--- PASS: TestUploadService_ValidateFile_Size (0.00s)
    --- PASS: TestUploadService_ValidateFile_Size/file_within_size_limit (0.00s)
    --- PASS: TestUploadService_ValidateFile_Size/file_exceeds_size_limit (0.00s)
    --- PASS: TestUploadService_ValidateFile_Size/file_at_exact_size_limit (0.00s)
=== RUN   TestUploadService_ValidateFile_Type
=== RUN   TestUploadService_ValidateFile_Type/valid_text_file
=== RUN   TestUploadService_ValidateFile_Type/valid_JSON_file
=== RUN   TestUploadService_ValidateFile_Type/valid_PNG_image
=== RUN   TestUploadService_ValidateFile_Type/valid_JPEG_image
=== RUN   TestUploadService_ValidateFile_Type/valid_PDF_document
--- PASS: TestUploadService_ValidateFile_Type (0.00s)
    --- PASS: TestUploadService_ValidateFile_Type/valid_text_file (0.00s)
    --- PASS: TestUploadService_ValidateFile_Type/valid_JSON_file (0.00s)
    --- PASS: TestUploadService_ValidateFile_Type/valid_PNG_image (0.00s)
    --- PASS: TestUploadService_ValidateFile_Type/valid_JPEG_image (0.00s)
    --- PASS: TestUploadService_ValidateFile_Type/valid_PDF_document (0.00s)
=== RUN   TestUploadService_ValidateFile_MaliciousContent
=== RUN   TestUploadService_ValidateFile_MaliciousContent/Windows_executable_(MZ_signature)
=== RUN   TestUploadService_ValidateFile_MaliciousContent/ELF_executable
=== RUN   TestUploadService_ValidateFile_MaliciousContent/Shell_script_with_shebang
=== RUN   TestUploadService_ValidateFile_MaliciousContent/HTML_with_script_tag
=== RUN   TestUploadService_ValidateFile_MaliciousContent/SVG_with_embedded_script
=== RUN   TestUploadService_ValidateFile_MaliciousContent/file_with_double_extension
=== RUN   TestUploadService_ValidateFile_MaliciousContent/file_with_path_traversal
=== RUN   TestUploadService_ValidateFile_MaliciousContent/file_with_null_byte
=== RUN   TestUploadService_ValidateFile_MaliciousContent/safe_text_file
--- PASS: TestUploadService_ValidateFile_MaliciousContent (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/Windows_executable_(MZ_signature) (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/ELF_executable (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/Shell_script_with_shebang (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/HTML_with_script_tag (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/SVG_with_embedded_script (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/file_with_double_extension (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/file_with_path_traversal (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/file_with_null_byte (0.00s)
    --- PASS: TestUploadService_ValidateFile_MaliciousContent/safe_text_file (0.00s)
=== RUN   TestUploadService_SetMaxFileSize
--- PASS: TestUploadService_SetMaxFileSize (0.00s)
=== RUN   TestUploadService_ValidateFile_NilFile
--- PASS: TestUploadService_ValidateFile_NilFile (0.00s)
=== RUN   TestUploadService_ValidateFile_EmptyFilename
--- PASS: TestUploadService_ValidateFile_EmptyFilename (0.00s)
=== RUN   TestAllowedMimeTypes
--- PASS: TestAllowedMimeTypes (0.00s)
=== RUN   TestMaliciousPatterns
--- PASS: TestMaliciousPatterns (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/upload	7.432s
=== RUN   TestExtractBearerToken
=== RUN   TestExtractBearerToken/valid_bearer_token
=== RUN   TestExtractBearerToken/empty_header
=== RUN   TestExtractBearerToken/missing_Bearer_prefix
=== RUN   TestExtractBearerToken/wrong_prefix
=== RUN   TestExtractBearerToken/Bearer_with_no_token
=== RUN   TestExtractBearerToken/Bearer_with_whitespace_token
--- PASS: TestExtractBearerToken (0.00s)
    --- PASS: TestExtractBearerToken/valid_bearer_token (0.00s)
    --- PASS: TestExtractBearerToken/empty_header (0.00s)
    --- PASS: TestExtractBearerToken/missing_Bearer_prefix (0.00s)
    --- PASS: TestExtractBearerToken/wrong_prefix (0.00s)
    --- PASS: TestExtractBearerToken/Bearer_with_no_token (0.00s)
    --- PASS: TestExtractBearerToken/Bearer_with_whitespace_token (0.00s)
=== RUN   TestHasRole
=== RUN   TestHasRole/has_single_required_role
=== RUN   TestHasRole/has_one_of_multiple_required_roles
=== RUN   TestHasRole/has_none_of_required_roles
=== RUN   TestHasRole/empty_user_roles
=== RUN   TestHasRole/empty_required_roles
=== RUN   TestHasRole/both_empty
--- PASS: TestHasRole (0.00s)
    --- PASS: TestHasRole/has_single_required_role (0.00s)
    --- PASS: TestHasRole/has_one_of_multiple_required_roles (0.00s)
    --- PASS: TestHasRole/has_none_of_required_roles (0.00s)
    --- PASS: TestHasRole/empty_user_roles (0.00s)
    --- PASS: TestHasRole/empty_required_roles (0.00s)
    --- PASS: TestHasRole/both_empty (0.00s)
=== RUN   TestContainsWeakPattern
=== RUN   TestContainsWeakPattern/contains_password
=== RUN   TestContainsWeakPattern/contains_test
=== RUN   TestContainsWeakPattern/contains_admin
=== RUN   TestContainsWeakPattern/contains_12345
=== RUN   TestContainsWeakPattern/no_weak_pattern
=== RUN   TestContainsWeakPattern/case_insensitive
--- PASS: TestContainsWeakPattern (0.00s)
    --- PASS: TestContainsWeakPattern/contains_password (0.00s)
    --- PASS: TestContainsWeakPattern/contains_test (0.00s)
    --- PASS: TestContainsWeakPattern/contains_admin (0.00s)
    --- PASS: TestContainsWeakPattern/contains_12345 (0.00s)
    --- PASS: TestContainsWeakPattern/no_weak_pattern (0.00s)
    --- PASS: TestContainsWeakPattern/case_insensitive (0.00s)
=== RUN   TestNewTimeoutContext
--- PASS: TestNewTimeoutContext (0.00s)
=== RUN   TestNewDefaultTimeoutContext
--- PASS: TestNewDefaultTimeoutContext (0.00s)
=== RUN   TestContextCancellation
--- PASS: TestContextCancellation (0.00s)
=== RUN   TestContextTimeout
--- PASS: TestContextTimeout (0.05s)
=== RUN   TestMarshalJSON
=== RUN   TestMarshalJSON/valid_struct
=== RUN   TestMarshalJSON/valid_map
=== RUN   TestMarshalJSON/valid_slice
=== RUN   TestMarshalJSON/nil_value
--- PASS: TestMarshalJSON (0.00s)
    --- PASS: TestMarshalJSON/valid_struct (0.00s)
    --- PASS: TestMarshalJSON/valid_map (0.00s)
    --- PASS: TestMarshalJSON/valid_slice (0.00s)
    --- PASS: TestMarshalJSON/nil_value (0.00s)
=== RUN   TestUnmarshalJSON
=== RUN   TestUnmarshalJSON/valid_JSON_to_struct
=== RUN   TestUnmarshalJSON/valid_JSON_to_map
=== RUN   TestUnmarshalJSON/invalid_JSON
=== RUN   TestUnmarshalJSON/empty_JSON
--- PASS: TestUnmarshalJSON (0.00s)
    --- PASS: TestUnmarshalJSON/valid_JSON_to_struct (0.00s)
    --- PASS: TestUnmarshalJSON/valid_JSON_to_map (0.00s)
    --- PASS: TestUnmarshalJSON/invalid_JSON (0.00s)
    --- PASS: TestUnmarshalJSON/empty_JSON (0.00s)
=== RUN   TestMarshalUnmarshalRoundTrip
--- PASS: TestMarshalUnmarshalRoundTrip (0.00s)
=== RUN   TestLogError
=== RUN   TestLogError/basic_error_logging
=== RUN   TestLogError/error_with_additional_fields
=== RUN   TestLogError/error_with_numeric_fields
--- PASS: TestLogError (0.00s)
    --- PASS: TestLogError/basic_error_logging (0.00s)
    --- PASS: TestLogError/error_with_additional_fields (0.00s)
    --- PASS: TestLogError/error_with_numeric_fields (0.00s)
=== RUN   TestLogError_NilLogger
--- PASS: TestLogError_NilLogger (0.00s)
=== RUN   TestLogError_EmptyFields
--- PASS: TestLogError_EmptyFields (0.00s)
=== RUN   TestValidateNotEmpty
=== RUN   TestValidateNotEmpty/valid_string
=== RUN   TestValidateNotEmpty/empty_string
=== RUN   TestValidateNotEmpty/whitespace
--- PASS: TestValidateNotEmpty (0.00s)
    --- PASS: TestValidateNotEmpty/valid_string (0.00s)
    --- PASS: TestValidateNotEmpty/empty_string (0.00s)
    --- PASS: TestValidateNotEmpty/whitespace (0.00s)
=== RUN   TestValidateNotNil
=== RUN   TestValidateNotNil/non-nil_pointer
=== RUN   TestValidateNotNil/nil_pointer
=== RUN   TestValidateNotNil/nil_interface
=== RUN   TestValidateNotNil/non-nil_value
--- PASS: TestValidateNotNil (0.00s)
    --- PASS: TestValidateNotNil/non-nil_pointer (0.00s)
    --- PASS: TestValidateNotNil/nil_pointer (0.00s)
    --- PASS: TestValidateNotNil/nil_interface (0.00s)
    --- PASS: TestValidateNotNil/non-nil_value (0.00s)
=== RUN   TestValidateRange
=== RUN   TestValidateRange/within_range
=== RUN   TestValidateRange/at_minimum
=== RUN   TestValidateRange/at_maximum
=== RUN   TestValidateRange/below_minimum
=== RUN   TestValidateRange/above_maximum
--- PASS: TestValidateRange (0.00s)
    --- PASS: TestValidateRange/within_range (0.00s)
    --- PASS: TestValidateRange/at_minimum (0.00s)
    --- PASS: TestValidateRange/at_maximum (0.00s)
    --- PASS: TestValidateRange/below_minimum (0.00s)
    --- PASS: TestValidateRange/above_maximum (0.00s)
=== RUN   TestValidateMinLength
=== RUN   TestValidateMinLength/meets_minimum
=== RUN   TestValidateMinLength/exceeds_minimum
=== RUN   TestValidateMinLength/below_minimum
=== RUN   TestValidateMinLength/empty_string
--- PASS: TestValidateMinLength (0.00s)
    --- PASS: TestValidateMinLength/meets_minimum (0.00s)
    --- PASS: TestValidateMinLength/exceeds_minimum (0.00s)
    --- PASS: TestValidateMinLength/below_minimum (0.00s)
    --- PASS: TestValidateMinLength/empty_string (0.00s)
=== RUN   TestValidateExactLength
=== RUN   TestValidateExactLength/exact_length
=== RUN   TestValidateExactLength/empty_allowed
=== RUN   TestValidateExactLength/wrong_length
=== RUN   TestValidateExactLength/too_long
--- PASS: TestValidateExactLength (0.00s)
    --- PASS: TestValidateExactLength/exact_length (0.00s)
    --- PASS: TestValidateExactLength/empty_allowed (0.00s)
    --- PASS: TestValidateExactLength/wrong_length (0.00s)
    --- PASS: TestValidateExactLength/too_long (0.00s)
=== RUN   TestValidatePositive
=== RUN   TestValidatePositive/positive
=== RUN   TestValidatePositive/large_positive
=== RUN   TestValidatePositive/zero
=== RUN   TestValidatePositive/negative
--- PASS: TestValidatePositive (0.00s)
    --- PASS: TestValidatePositive/positive (0.00s)
    --- PASS: TestValidatePositive/large_positive (0.00s)
    --- PASS: TestValidatePositive/zero (0.00s)
    --- PASS: TestValidatePositive/negative (0.00s)
PASS
ok  	github.com/real-rm/chatbox/internal/util	7.703s
=== RUN   TestMessageFraming_SeparateFrames
--- PASS: TestMessageFraming_SeparateFrames (0.00s)
=== RUN   TestMessageFraming_NoNewlineConcatenation
--- PASS: TestMessageFraming_NoNewlineConcatenation (0.00s)
=== RUN   TestMessageFraming_RapidMessages
--- PASS: TestMessageFraming_RapidMessages (0.00s)
=== RUN   TestReadPump_RouterIntegration
--- PASS: TestReadPump_RouterIntegration (0.20s)
=== RUN   TestReadPump_SessionIDAssignment
--- PASS: TestReadPump_SessionIDAssignment (0.15s)
=== RUN   TestReadPump_InvalidJSON
--- PASS: TestReadPump_InvalidJSON (0.10s)
=== RUN   TestReadPump_RoutingErrorHandling
2026-02-17T22:59:51.490+07:00 level=ERROR module=websocket msg=Failed to route message, error=LLM_UNAVAILABLE: AI service is temporarily unavailable, component="websocket", user_id="test-user", session_id="test-session-error", connection_id="test-conn-error", message_type="user_message", file="logging.go:25"
--- PASS: TestReadPump_RoutingErrorHandling (0.20s)
=== RUN   TestReadPump_RegistrationErrorHandling
2026-02-17T22:59:51.694+07:00 level=ERROR module=websocket msg=Failed to register connection with router, error=DATABASE_ERROR: Database operation failed, component="websocket", user_id="test-user", session_id="test-session-reg-error", connection_id="test-conn-reg-error", file="logging.go:25"
--- PASS: TestReadPump_RegistrationErrorHandling (0.20s)
=== RUN   TestEndToEndMessageFlow
=== RUN   TestEndToEndMessageFlow/single_user_message
=== RUN   TestEndToEndMessageFlow/multiple_messages_in_sequence
=== RUN   TestEndToEndMessageFlow/message_with_metadata
=== RUN   TestEndToEndMessageFlow/empty_content_message
--- PASS: TestEndToEndMessageFlow (1.11s)
    --- PASS: TestEndToEndMessageFlow/single_user_message (0.25s)
    --- PASS: TestEndToEndMessageFlow/multiple_messages_in_sequence (0.36s)
    --- PASS: TestEndToEndMessageFlow/message_with_metadata (0.25s)
    --- PASS: TestEndToEndMessageFlow/empty_content_message (0.25s)
=== RUN   TestEndToEndMessageFlow_SessionRegistration
--- PASS: TestEndToEndMessageFlow_SessionRegistration (0.20s)
=== RUN   TestEndToEndMessageFlow_TimestampHandling
--- PASS: TestEndToEndMessageFlow_TimestampHandling (0.30s)
=== RUN   TestEndToEndMessageFlow_SenderHandling
--- PASS: TestEndToEndMessageFlow_SenderHandling (0.25s)
=== RUN   TestEndToEndMessageFlow_ConcurrentMessages
--- PASS: TestEndToEndMessageFlow_ConcurrentMessages (0.41s)
=== RUN   TestEndToEndMessageFlow_UnregistrationOnClose
--- PASS: TestEndToEndMessageFlow_UnregistrationOnClose (0.10s)
=== RUN   TestEndToEndStreamingFlow
--- PASS: TestEndToEndStreamingFlow (0.03s)
=== RUN   TestEndToEndStreamingFlow_MultipleMessages
--- PASS: TestEndToEndStreamingFlow_MultipleMessages (0.21s)
=== RUN   TestReadPump_NilRouterHandling
--- PASS: TestReadPump_NilRouterHandling (0.20s)
=== RUN   TestOversizedMessages_Integration
--- PASS: TestOversizedMessages_Integration (0.50s)
=== RUN   TestOversizedMessages_ExactLimit
--- PASS: TestOversizedMessages_ExactLimit (0.40s)
=== RUN   TestOversizedMessages_MultipleConnections
--- PASS: TestOversizedMessages_MultipleConnections (0.51s)
=== RUN   TestHandler_MultipleConnectionsPerUser
--- PASS: TestHandler_MultipleConnectionsPerUser (0.36s)
=== RUN   TestHandler_ConnectionIDUniqueness
--- PASS: TestHandler_ConnectionIDUniqueness (0.00s)
=== RUN   TestHandler_MultiConnectionMessageIsolation
--- PASS: TestHandler_MultiConnectionMessageIsolation (0.10s)
=== RUN   TestHandler_RateLimitPerUser
--- PASS: TestHandler_RateLimitPerUser (0.00s)
=== RUN   TestHandler_ShutdownWithMultipleConnections
--- PASS: TestHandler_ShutdownWithMultipleConnections (0.00s)
=== RUN   TestHandler_ConnectionLimitGracefulHandling
--- PASS: TestHandler_ConnectionLimitGracefulHandling (0.78s)
=== RUN   TestHandler_ConnectionLimitPerUser
--- PASS: TestHandler_ConnectionLimitPerUser (0.68s)
=== RUN   TestHandler_NotifyConnectionLimit
--- PASS: TestHandler_NotifyConnectionLimit (0.73s)
=== RUN   TestHandler_NotifyConnectionLimit_NoExistingConnections
--- PASS: TestHandler_NotifyConnectionLimit_NoExistingConnections (0.00s)
=== RUN   TestHandler_NotifyConnectionLimit_MessageFormat
--- PASS: TestHandler_NotifyConnectionLimit_MessageFormat (0.00s)
=== RUN   TestMultiDevice_MessageBroadcastToAllConnections
--- PASS: TestMultiDevice_MessageBroadcastToAllConnections (0.16s)
=== RUN   TestMultiDevice_IndependentSessions
--- PASS: TestMultiDevice_IndependentSessions (0.31s)
=== RUN   TestMultiDevice_ConnectionFailureIsolation
--- PASS: TestMultiDevice_ConnectionFailureIsolation (0.31s)
=== RUN   TestMultiDevice_ConcurrentMessageSending
--- PASS: TestMultiDevice_ConcurrentMessageSending (0.41s)
=== RUN   TestMultiDevice_ReconnectionScenario
--- PASS: TestMultiDevice_ReconnectionScenario (0.31s)
=== RUN   TestMultiDevice_MaxConnectionsEnforcement
--- PASS: TestMultiDevice_MaxConnectionsEnforcement (0.73s)
=== RUN   TestProductionIssue04_SessionIDDataRace
    handler_production_test.go:49: STATUS: No data race detected with proper locking
    handler_production_test.go:50: FINDING: Connection.SessionID access is thread-safe
--- PASS: TestProductionIssue04_SessionIDDataRace (0.00s)
=== RUN   TestProductionIssue04_ConcurrentSessionAccess
    handler_production_test.go:82: STATUS: No data race detected
    handler_production_test.go:83: FINDING: Concurrent access to connection fields is safe
--- PASS: TestProductionIssue04_ConcurrentSessionAccess (0.00s)
=== RUN   TestProductionIssue13_OriginValidationDataRace
    handler_production_test.go:134: STATUS: No data race detected with proper locking
    handler_production_test.go:135: FINDING: Origin validation is thread-safe with RLock in checkOrigin()
    handler_production_test.go:136: IMPACT: Concurrent origin checks and updates are safe
--- PASS: TestProductionIssue13_OriginValidationDataRace (0.00s)
=== RUN   TestProductionIssue13_DefaultOriginBehavior
    handler_production_test.go:173: FINDING: All origins are allowed when no origins configured
    handler_production_test.go:174: IMPACT: Development mode - no origin restrictions
    handler_production_test.go:175: RECOMMENDATION: Configure allowed origins for production
    handler_production_test.go:189: STATUS: Origin validation works correctly when configured
--- PASS: TestProductionIssue13_DefaultOriginBehavior (0.00s)
=== RUN   TestProperty_ConnectionUserAssociation
+ connection is associated with JWT user ID: OK, passed 20 tests.
--- PASS: TestProperty_ConnectionUserAssociation (0.01s)
=== RUN   TestProperty_WebSocketConnectionEstablishment
+ valid token allows connection establishment: OK, passed 20 tests.
--- PASS: TestProperty_WebSocketConnectionEstablishment (0.01s)
=== RUN   TestProperty_HeartbeatResponse
+ ping message receives pong response: OK, passed 20 tests.
--- PASS: TestProperty_HeartbeatResponse (0.00s)
=== RUN   TestProperty_ConnectionResourceCleanup
+ closed connection cleans up all resources: OK, passed 20 tests.
--- PASS: TestProperty_ConnectionResourceCleanup (0.01s)
=== RUN   TestProperty_ConnectionIDUniqueness
+ connection IDs are always unique for rapid connections: OK, passed 50
   tests.
--- PASS: TestProperty_ConnectionIDUniqueness (0.01s)
=== RUN   TestProperty_ConnectionIDFormat
+ connection IDs are non-empty and contain user ID: OK, passed 50 tests.
--- PASS: TestProperty_ConnectionIDFormat (0.00s)
=== RUN   TestProperty_ReadLimitEnforcement
+ all connections have read limit set: OK, passed 100 tests.
--- PASS: TestProperty_ReadLimitEnforcement (0.00s)
=== RUN   TestProperty_OversizedMessageRejection
+ handler enforces message size limits: OK, passed 100 tests.
--- PASS: TestProperty_OversizedMessageRejection (0.00s)
=== RUN   TestProperty_ConfigurationValueApplication
+ handler applies configured message size limit: OK, passed 100 tests.
--- PASS: TestProperty_ConfigurationValueApplication (0.00s)
=== RUN   TestProperty_OversizedMessageLogging
+ connections have user ID and connection ID for logging: OK, passed 100
   tests.
--- PASS: TestProperty_OversizedMessageLogging (0.00s)
=== RUN   TestProperty_OriginValidationThreadSafety
+ concurrent checkOrigin and SetAllowedOrigins are thread-safe: OK, passed
   100 tests.
--- PASS: TestProperty_OriginValidationThreadSafety (0.09s)
=== RUN   TestConnection_WritePump
=== RUN   TestConnection_WritePump/sends_messages_from_channel
=== RUN   TestConnection_WritePump/handles_channel_close
--- PASS: TestConnection_WritePump (0.20s)
    --- PASS: TestConnection_WritePump/sends_messages_from_channel (0.10s)
    --- PASS: TestConnection_WritePump/handles_channel_close (0.10s)
=== RUN   TestConnection_ReadPump
=== RUN   TestConnection_ReadPump/receives_messages
=== RUN   TestConnection_ReadPump/handles_empty_messages
--- PASS: TestConnection_ReadPump (0.21s)
    --- PASS: TestConnection_ReadPump/receives_messages (0.10s)
    --- PASS: TestConnection_ReadPump/handles_empty_messages (0.10s)
=== RUN   TestConnection_PingPong
--- PASS: TestConnection_PingPong (0.20s)
=== RUN   TestConnection_GracefulClose
--- PASS: TestConnection_GracefulClose (0.00s)
=== RUN   TestConnection_ResourceCleanup
--- PASS: TestConnection_ResourceCleanup (0.00s)
=== RUN   TestHandler_CheckOrigin
=== RUN   TestHandler_CheckOrigin/no_origins_configured_allows_all
=== RUN   TestHandler_CheckOrigin/exact_match_allowed
=== RUN   TestHandler_CheckOrigin/second_origin_allowed
=== RUN   TestHandler_CheckOrigin/disallowed_origin_rejected
=== RUN   TestHandler_CheckOrigin/subdomain_not_allowed_by_default
=== RUN   TestHandler_CheckOrigin/http_vs_https_mismatch
=== RUN   TestHandler_CheckOrigin/port_mismatch
=== RUN   TestHandler_CheckOrigin/empty_origin_with_restrictions
=== RUN   TestHandler_CheckOrigin/localhost_allowed
--- PASS: TestHandler_CheckOrigin (0.00s)
    --- PASS: TestHandler_CheckOrigin/no_origins_configured_allows_all (0.00s)
    --- PASS: TestHandler_CheckOrigin/exact_match_allowed (0.00s)
    --- PASS: TestHandler_CheckOrigin/second_origin_allowed (0.00s)
    --- PASS: TestHandler_CheckOrigin/disallowed_origin_rejected (0.00s)
    --- PASS: TestHandler_CheckOrigin/subdomain_not_allowed_by_default (0.00s)
    --- PASS: TestHandler_CheckOrigin/http_vs_https_mismatch (0.00s)
    --- PASS: TestHandler_CheckOrigin/port_mismatch (0.00s)
    --- PASS: TestHandler_CheckOrigin/empty_origin_with_restrictions (0.00s)
    --- PASS: TestHandler_CheckOrigin/localhost_allowed (0.00s)
=== RUN   TestHandler_SetAllowedOrigins
--- PASS: TestHandler_SetAllowedOrigins (0.00s)
=== RUN   TestHandler_OriginValidationIntegration
=== RUN   TestHandler_OriginValidationIntegration/allowed_origin_upgrades_successfully
=== RUN   TestHandler_OriginValidationIntegration/disallowed_origin_fails_upgrade
2026-02-17T23:00:01.766+07:00 level=ERROR module=websocket msg=Failed to upgrade connection, error=websocket: request origin not allowed by Upgrader.CheckOrigin, component="websocket", file="logging.go:25"
=== RUN   TestHandler_OriginValidationIntegration/no_restrictions_allows_upgrade
--- PASS: TestHandler_OriginValidationIntegration (0.00s)
    --- PASS: TestHandler_OriginValidationIntegration/allowed_origin_upgrades_successfully (0.00s)
    --- PASS: TestHandler_OriginValidationIntegration/disallowed_origin_fails_upgrade (0.00s)
    --- PASS: TestHandler_OriginValidationIntegration/no_restrictions_allows_upgrade (0.00s)
=== RUN   TestHandler_MessageSizeLimit
=== RUN   TestHandler_MessageSizeLimit/default_limit_is_1MB
=== RUN   TestHandler_MessageSizeLimit/custom_limit_512KB
=== RUN   TestHandler_MessageSizeLimit/custom_limit_2MB
=== RUN   TestHandler_MessageSizeLimit/custom_limit_100KB
--- PASS: TestHandler_MessageSizeLimit (0.00s)
    --- PASS: TestHandler_MessageSizeLimit/default_limit_is_1MB (0.00s)
    --- PASS: TestHandler_MessageSizeLimit/custom_limit_512KB (0.00s)
    --- PASS: TestHandler_MessageSizeLimit/custom_limit_2MB (0.00s)
    --- PASS: TestHandler_MessageSizeLimit/custom_limit_100KB (0.00s)
=== RUN   TestHandler_SetReadLimitCalled
=== RUN   TestHandler_SetReadLimitCalled/SetReadLimit_called_with_default_1MB
=== RUN   TestHandler_SetReadLimitCalled/SetReadLimit_called_with_custom_512KB
=== RUN   TestHandler_SetReadLimitCalled/SetReadLimit_called_with_custom_2MB
--- PASS: TestHandler_SetReadLimitCalled (0.16s)
    --- PASS: TestHandler_SetReadLimitCalled/SetReadLimit_called_with_default_1MB (0.05s)
    --- PASS: TestHandler_SetReadLimitCalled/SetReadLimit_called_with_custom_512KB (0.05s)
    --- PASS: TestHandler_SetReadLimitCalled/SetReadLimit_called_with_custom_2MB (0.05s)
=== RUN   TestProperty_ShutdownRespectsDeadline
--- PASS: TestProperty_ShutdownRespectsDeadline (0.03s)
=== RUN   TestProperty_ShutdownClosesAllConnections
--- PASS: TestProperty_ShutdownClosesAllConnections (0.06s)
PASS
ok  	github.com/real-rm/chatbox/internal/websocket	18.543s
FAIL
